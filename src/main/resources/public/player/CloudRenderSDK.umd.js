!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CloudRenderSDK={})}(this,(function(e){"use strict";var t=Object.defineProperty,s=(e,s,n)=>(((e,s,n)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n})(e,"symbol"!=typeof s?s+"":s,n),n),n={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const s=t.splitSections(e);return s&&s[0]},t.getMediaSections=function(e){const s=t.splitSections(e);return s.shift(),s},t.matchPrefix=function(e,s){return t.splitLines(e).filter((e=>0===e.indexOf(s)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const s={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let n=8;n<t.length;n+=2)switch(t[n]){case"raddr":s.relatedAddress=t[n+1];break;case"rport":s.relatedPort=parseInt(t[n+1],10);break;case"tcptype":s.tcpType=t[n+1];break;case"ufrag":s.ufrag=t[n+1],s.usernameFragment=t[n+1];break;default:void 0===s[t[n]]&&(s[t[n]]=t[n+1])}return s},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const s=e.component;"rtp"===s?t.push(1):"rtcp"===s?t.push(2):t.push(s),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const s={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),s.name=t[0],s.clockRate=parseInt(t[1],10),s.channels=3===t.length?parseInt(t[2],10):1,s.numChannels=s.channels,s},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const s=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==s?"/"+s:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let s;const n=e.substring(e.indexOf(" ")+1).split(";");for(let r=0;r<n.length;r++)s=n[r].trim().split("="),t[s[0].trim()]=s[1];return t},t.writeFmtp=function(e){let t="",s=e.payloadType;if(void 0!==e.preferredPayloadType&&(s=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const n=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+s+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",s=e.payloadType;return void 0!==e.preferredPayloadType&&(s=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+s+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),s={ssrc:parseInt(e.substring(7,t),10)},n=e.indexOf(":",t);return n>-1?(s.attribute=e.substring(t+1,n),s.value=e.substring(n+1)):s.attribute=e.substring(t+1),s},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const s=t.matchPrefix(e,"a=mid:")[0];if(s)return s.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,s){return{role:"auto",fingerprints:t.matchPrefix(e+s,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let s="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{s+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),s},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,s){return t.matchPrefix(e+s,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,s){const n=t.matchPrefix(e+s,"a=ice-ufrag:")[0],r=t.matchPrefix(e+s,"a=ice-pwd:")[0];return n&&r?{usernameFragment:n.substring(12),password:r.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const s={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" ");for(let de=3;de<n.length;de++){const r=n[de],he=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(he){const n=t.parseRtpMap(he),de=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(n.parameters=de.length?t.parseFmtp(de[0]):{},n.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),s.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":s.fecMechanisms.push(n.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{s.headerExtensions.push(t.parseExtmap(e))}));const r=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return s.codecs.forEach((e=>{r.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),s},t.writeRtpDescription=function(e,s){let n="";n+="m="+e+" ",n+=s.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=s.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",s.codecs.forEach((e=>{n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));let r=0;return s.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)})),r>0&&(n+="a=maxptime:"+r+"\r\n"),s.headerExtensions&&s.headerExtensions.forEach((e=>{n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){const s=[],n=t.parseRtpParameters(e),r=-1!==n.fecMechanisms.indexOf("RED"),de=-1!==n.fecMechanisms.indexOf("ULPFEC"),he=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),ue=he.length>0&&he[0].ssrc;let pe;const ve=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));ve.length>0&&ve[0].length>1&&ve[0][0]===ue&&(pe=ve[0][1]),n.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:ue,codecPayloadType:parseInt(e.parameters.apt,10)};ue&&pe&&(t.rtx={ssrc:pe}),s.push(t),r&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:ue,mechanism:de?"red+ulpfec":"red"},s.push(t))}})),0===s.length&&ue&&s.push({ssrc:ue});let Le=t.matchPrefix(e,"b=");return Le.length&&(Le=0===Le[0].indexOf("b=TIAS:")?parseInt(Le[0].substring(7),10):0===Le[0].indexOf("b=AS:")?1e3*parseInt(Le[0].substring(5),10)*.95-16e3:void 0,s.forEach((e=>{e.maxBitrate=Le}))),s},t.parseRtcpParameters=function(e){const s={},n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];n&&(s.cname=n.value,s.ssrc=n.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");s.reducedSize=r.length>0,s.compound=0===r.length;const de=t.matchPrefix(e,"a=rtcp-mux");return s.mux=de.length>0,s},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let s;const n=t.matchPrefix(e,"a=msid:");if(1===n.length)return s=n[0].substring(7).split(" "),{stream:s[0],track:s[1]};const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return r.length>0?(s=r[0].value.split(" "),{stream:s[0],track:s[1]}):void 0},t.parseSctpDescription=function(e){const s=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");let r;n.length>0&&(r=parseInt(n[0].substring(19),10)),isNaN(r)&&(r=65536);const de=t.matchPrefix(e,"a=sctp-port:");if(de.length>0)return{port:parseInt(de[0].substring(12),10),protocol:s.fmt,maxMessageSize:r};const he=t.matchPrefix(e,"a=sctpmap:");if(he.length>0){const e=he[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){let s=[];return s="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&s.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),s.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,s,n){let r;const de=void 0!==s?s:2;r=e||t.generateSessionId();return"v=0\r\no="+(n||"thisisadapterortc")+" "+r+" "+de+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,s){const n=t.splitLines(e);for(let t=0;t<n.length;t++)switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substring(2)}return s?t.getDirection(s):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const s=t.splitLines(e)[0].substring(2).split(" ");return{kind:s[0],port:parseInt(s[1],10),protocol:s[2],fmt:s.slice(3).join(" ")}},t.parseOLine=function(e){const s=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:s[0],sessionId:s[1],sessionVersion:parseInt(s[2],10),netType:s[3],addressType:s[4],address:s[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const s=t.splitLines(e);for(let t=0;t<s.length;t++)if(s[t].length<2||"="!==s[t].charAt(1))return!1;return!0},e.exports=t}(n);var r,de,he,ue=n.exports,pe={d:(e,t)=>{for(var s in t)pe.o(t,s)&&!pe.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},ve={};pe.d(ve,{Dz:()=>Ce,g$:()=>A,Lt:()=>k,Q9:()=>x,qf:()=>L,hV:()=>ke,z$:()=>Me,J0:()=>be,De:()=>Se,$C:()=>De,al:()=>_,_W:()=>W,tz:()=>B,Nu:()=>ye,zg:()=>ze,vp:()=>ae,vU:()=>le,wF:()=>Y,rv:()=>Ee,Nh:()=>Te,ss:()=>Ie,qW:()=>te,QL:()=>ee,cf:()=>_e,eM:()=>j,Yd:()=>i,iM:()=>S,qy:()=>o,ce:()=>v,sK:()=>ce,Ok:()=>me,q5:()=>we,g:()=>Tt,xl:()=>$,I:()=>q,bx:()=>X,dD:()=>oe,Ib:()=>b,Az:()=>M,Iw:()=>w,qY:()=>R,db:()=>P,mR:()=>se,Tn:()=>C,rV:()=>J,gh:()=>V,Mi:()=>N,j:()=>K,YB:()=>Q,i5:()=>Z,x_:()=>ge,Am:()=>ut,eR:()=>F,r8:()=>H,u3:()=>Be,vd:()=>O,iV:()=>I,jZ:()=>U,SW:()=>z,ZH:()=>G,Ni:()=>pt,lh:()=>D,bq:()=>f,$f:()=>ft,eu:()=>ie,Ax:()=>re,Mc:()=>ne});class i{static GetStackTrace(){const e=new Error;let t="No Stack Available for this browser";return e.stack&&(t=e.stack.toString().replace(/Error/g,"")),t}static SetLoggerVerbosity(e){null!=this.verboseLogLevel&&(this.verboseLogLevel=e)}static Log(e,t,s){if(s>this.verboseLogLevel)return;const n=`Level: Log\nMsg: ${t}\nCaller: ${e}`;console.log(n)}static Info(e,t,s){if(s>this.verboseLogLevel)return;const n=`Level: Info\nMsg: ${t}`;console.info(n)}static Error(e,t){const s=`Level: Error\nMsg: ${t}\nCaller: ${e}`;console.error(s)}static Warning(e,t){const s=`Level: Warning\nCaller: ${e}\nMsg: ${t}`;console.warn(s)}}i.verboseLogLevel=5,(he=r||(r={})).LIST_STREAMERS="listStreamers",he.SUBSCRIBE="subscribe",he.UNSUBSCRIBE="unsubscribe",he.ICE_CANDIDATE="iceCandidate",he.OFFER="offer",he.ANSWER="answer",he.DATACHANNELREQUEST="dataChannelRequest",he.SFURECVDATACHANNELREADY="peerDataChannelsReady",he.PONG="pong";class o{payload(){return i.Log(i.GetStackTrace(),"Sending => \n"+JSON.stringify(this,void 0,4),6),JSON.stringify(this)}}class a extends o{constructor(){super(),this.type=r.LIST_STREAMERS}}class l extends o{constructor(e){super(),this.type=r.SUBSCRIBE,this.streamerId=e}}class d extends o{constructor(){super(),this.type=r.UNSUBSCRIBE}}class c extends o{constructor(e){super(),this.type=r.PONG,this.time=e}}class h extends o{constructor(e){super(),this.type=r.OFFER,e&&(this.type=e.type,this.sdp=e.sdp)}}class g extends o{constructor(e){super(),this.type=r.ANSWER,e&&(this.type=e.type,this.sdp=e.sdp)}}class u extends o{constructor(){super(),this.type=r.DATACHANNELREQUEST}}class m extends o{constructor(){super(),this.type=r.SFURECVDATACHANNELREADY}}class p{constructor(e){this.type=r.ICE_CANDIDATE,this.candidate=e}payload(){return i.Log(i.GetStackTrace(),"Sending => \n"+JSON.stringify(this,void 0,4),6),JSON.stringify(this)}}!function(e){e.CONFIG="config",e.STREAMER_LIST="streamerList",e.PLAYER_COUNT="playerCount",e.OFFER="offer",e.ANSWER="answer",e.ICE_CANDIDATE="iceCandidate",e.PEER_DATA_CHANNELS="peerDataChannels",e.PING="ping",e.WARNING="warning"}(de||(de={}));class S{}class v extends S{}class C{constructor(){this.FromUEMessageHandlers=new Map}addMessageHandler(e,t){this.FromUEMessageHandlers.set(e,t)}handleMessage(e,t){this.FromUEMessageHandlers.has(e)?this.FromUEMessageHandlers.get(e)(t):i.Error(i.GetStackTrace(),`Message type of ${e} does not have a message handler registered on the frontend - ignoring message.`)}static setupDefaultHandlers(e){e.signallingProtocol.addMessageHandler(de.PING,(t=>{const s=new c((new Date).getTime()).payload();i.Log(i.GetStackTrace(),de.PING+": "+t,6),e.webSocket.send(s)})),e.signallingProtocol.addMessageHandler(de.CONFIG,(t=>{i.Log(i.GetStackTrace(),de.CONFIG,6);const s=JSON.parse(t);e.onConfig(s)})),e.signallingProtocol.addMessageHandler(de.STREAMER_LIST,(t=>{i.Log(i.GetStackTrace(),de.STREAMER_LIST,6);const s=JSON.parse(t);e.onStreamerList(s)})),e.signallingProtocol.addMessageHandler(de.PLAYER_COUNT,(t=>{i.Log(i.GetStackTrace(),de.PLAYER_COUNT,6);const s=JSON.parse(t);i.Log(i.GetStackTrace(),"Player Count: "+s.count,6),e.onPlayerCount(s)})),e.signallingProtocol.addMessageHandler(de.ANSWER,(t=>{i.Log(i.GetStackTrace(),de.ANSWER,6);const s=JSON.parse(t);e.onWebRtcAnswer(s)})),e.signallingProtocol.addMessageHandler(de.OFFER,(t=>{i.Log(i.GetStackTrace(),de.OFFER,6);const s=JSON.parse(t);e.onWebRtcOffer(s)})),e.signallingProtocol.addMessageHandler(de.ICE_CANDIDATE,(t=>{i.Log(i.GetStackTrace(),de.ICE_CANDIDATE,6);const s=JSON.parse(t);e.onIceCandidate(s.candidate)})),e.signallingProtocol.addMessageHandler(de.WARNING,(e=>{i.Warning(i.GetStackTrace(),`Warning received: ${e}`)})),e.signallingProtocol.addMessageHandler(de.PEER_DATA_CHANNELS,(t=>{i.Log(i.GetStackTrace(),de.PEER_DATA_CHANNELS,6);const s=JSON.parse(t);e.onWebRtcPeerDataChannels(s)}))}}class f{constructor(){this.WS_OPEN_STATE=1,this.onOpen=new EventTarget,this.onClose=new EventTarget,this.signallingProtocol=new C,C.setupDefaultHandlers(this)}connect(e){i.Log(i.GetStackTrace(),e,6);try{return this.webSocket=new WebSocket(e),this.webSocket.onopen=e=>this.handleOnOpen(e),this.webSocket.onerror=()=>this.handleOnError(),this.webSocket.onclose=e=>this.handleOnClose(e),this.webSocket.onmessage=e=>this.handleOnMessage(e),this.webSocket.onmessagebinary=e=>this.handleOnMessageBinary(e),!0}catch(t){return i.Error(t,t),!1}}handleOnMessageBinary(e){e&&e.data&&e.data.text().then((e=>{const t=new MessageEvent("messageFromBinary",{data:e});this.handleOnMessage(t)})).catch((e=>{i.Error(i.GetStackTrace(),`Failed to parse binary blob from websocket, reason: ${e}`)}))}handleOnMessage(e){if(e.data&&e.data instanceof Blob)return void this.handleOnMessageBinary(e);const t=JSON.parse(e.data);i.Log(i.GetStackTrace(),"received => \n"+JSON.stringify(JSON.parse(e.data),void 0,4),6),this.signallingProtocol.handleMessage(t.type,e.data)}handleOnOpen(e){i.Log(i.GetStackTrace(),"Connected to the signalling server via WebSocket",6),this.onOpen.dispatchEvent(new Event("open"))}handleOnError(){i.Error(i.GetStackTrace(),"WebSocket error")}handleOnClose(e){this.onWebSocketOncloseOverlayMessage(e),i.Log(i.GetStackTrace(),"Disconnected to the signalling server via WebSocket: "+JSON.stringify(e.code)+" - "+e.reason),this.onClose.dispatchEvent(new Event("close"))}requestStreamerList(){const e=new a;this.webSocket.send(e.payload())}sendSubscribe(e){const t=new l(e);this.webSocket.send(t.payload())}sendUnsubscribe(){const e=new d;this.webSocket.send(e.payload())}sendWebRtcOffer(e){const t=new h(e);this.webSocket.send(t.payload())}sendWebRtcAnswer(e){const t=new g(e);this.webSocket.send(t.payload())}sendWebRtcDatachannelRequest(){const e=new u;this.webSocket.send(e.payload())}sendSFURecvDataChannelReady(){const e=new m;this.webSocket.send(e.payload())}sendIceCandidate(e){if(i.Log(i.GetStackTrace(),"Sending Ice Candidate"),this.webSocket&&this.webSocket.readyState===this.WS_OPEN_STATE){const t=new p(e);this.webSocket.send(t.payload())}}close(){var e;null===(e=this.webSocket)||void 0===e||e.close()}onWebSocketOncloseOverlayMessage(e){}onConfig(e){}onStreamerList(e){}onIceCandidate(e){}onWebRtcAnswer(e){}onWebRtcOffer(e){}onWebRtcPeerDataChannels(e){}onPlayerCount(e){}}class E{constructor(e){this.videoElementProvider=e,this.audioElement=document.createElement("Audio"),this.videoElementProvider.setAudioElement(this.audioElement)}handleOnTrack(e){i.Log(i.GetStackTrace(),"handleOnTrack "+JSON.stringify(e.streams),6);const t=this.videoElementProvider.getVideoElement();if(e.track&&i.Log(i.GetStackTrace(),"Got track - "+e.track.kind+" id="+e.track.id+" readyState="+e.track.readyState,6),"audio"!=e.track.kind)return"video"==e.track.kind&&t.srcObject!==e.streams[0]?(t.srcObject=e.streams[0],void i.Log(i.GetStackTrace(),"Set video source from video track ontrack.")):void 0;this.CreateAudioTrack(e.streams[0])}CreateAudioTrack(e){const t=this.videoElementProvider.getVideoElement();t.srcObject!=e&&t.srcObject&&t.srcObject!==e&&(this.audioElement.srcObject=e,i.Log(i.GetStackTrace(),"Created new audio element to play separate audio stream."))}}class T{constructor(e){this.freezeFrameHeight=0,this.freezeFrameWidth=0,this.rootDiv=e,this.rootElement=document.createElement("div"),this.rootElement.id="freezeFrame",this.rootElement.style.display="none",this.rootElement.style.pointerEvents="none",this.rootElement.style.position="absolute",this.rootElement.style.zIndex="20",this.imageElement=document.createElement("img"),this.imageElement.style.position="absolute",this.rootElement.appendChild(this.imageElement),this.rootDiv.appendChild(this.rootElement)}setElementForShow(){this.rootElement.style.display="block"}setElementForHide(){this.rootElement.style.display="none"}updateImageElementSource(e){const t=btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),""));this.imageElement.src="data:image/jpeg;base64,"+t}setDimensionsFromElementAndResize(){this.freezeFrameHeight=this.imageElement.naturalHeight,this.freezeFrameWidth=this.imageElement.naturalWidth,this.resize()}resize(){if(0!==this.freezeFrameWidth&&0!==this.freezeFrameHeight){let e=0,t=0,s=0,n=0;const r=this.rootDiv.clientWidth/this.rootDiv.clientHeight,de=this.freezeFrameWidth/this.freezeFrameHeight;r<de?(e=this.rootDiv.clientWidth,t=Math.floor(this.rootDiv.clientWidth/de),s=Math.floor(.5*(this.rootDiv.clientHeight-t)),n=0):(e=Math.floor(this.rootDiv.clientHeight*de),t=this.rootDiv.clientHeight,s=0,n=Math.floor(.5*(this.rootDiv.clientWidth-e))),this.rootElement.style.width=this.rootDiv.offsetWidth+"px",this.rootElement.style.height=this.rootDiv.offsetHeight+"px",this.rootElement.style.left="0px",this.rootElement.style.top="0px",this.imageElement.style.width=e+"px",this.imageElement.style.height=t+"px",this.imageElement.style.left=n+"px",this.imageElement.style.top=s+"px"}}}class y{constructor(e){this.receiving=!1,this.size=0,this.jpeg=void 0,this.valid=!1,this.freezeFrameDelay=50,this.freezeFrame=new T(e)}showFreezeFrame(){this.valid&&this.freezeFrame.setElementForShow()}hideFreezeFrame(){this.valid=!1,this.freezeFrame.setElementForHide()}updateFreezeFrameAndShow(e,t){this.freezeFrame.updateImageElementSource(e),this.freezeFrame.imageElement.onload=()=>{this.freezeFrame.setDimensionsFromElementAndResize(),t()}}processFreezeFrameMessage(e,t){this.receiving||(this.receiving=!0,this.valid=!1,this.size=0,this.jpeg=void 0),this.size=new DataView(e.slice(1,5).buffer).getInt32(0,!0);const s=e.slice(5);if(this.jpeg){const e=new Uint8Array(this.jpeg.length+s.length);e.set(this.jpeg,0),e.set(s,this.jpeg.length),this.jpeg=e}else this.jpeg=s,this.receiving=!0,i.Log(i.GetStackTrace(),`received first chunk of freeze frame: ${this.jpeg.length}/${this.size}`,6);this.jpeg.length===this.size?(this.receiving=!1,this.valid=!0,i.Log(i.GetStackTrace(),`received complete freeze frame ${this.size}`,6),this.updateFreezeFrameAndShow(this.jpeg,t)):this.jpeg.length>this.size&&(i.Error(i.GetStackTrace(),`received bigger freeze frame than advertised: ${this.jpeg.length}/${this.size}`),this.jpeg=void 0,this.receiving=!1)}}class b{constructor(e,t,s,n,r=(()=>{})){this.onChange=r,this.onChangeEmit=()=>{},this.id=e,this.description=s,this.label=t,this.value=n}set label(e){this._label=e,this.onChangeEmit(this._value)}get label(){return this._label}get value(){return this._value}set value(e){this._value=e,this.onChange(this._value,this),this.onChangeEmit(this._value)}}class M extends b{constructor(e,t,s,n,r,de=(()=>{})){super(e,t,s,n,de);const he=new URLSearchParams(window.location.search);if(r&&he.has(this.id)){const e=this.getUrlParamFlag();this.flag=e}else this.flag=n;this.useUrlParams=r}getUrlParamFlag(){const e=new URLSearchParams(window.location.search);return!!e.has(this.id)&&"false"!==e.get(this.id)&&"False"!==e.get(this.id)}updateURLParams(){if(this.useUrlParams){const e=new URLSearchParams(window.location.search);!0===this.flag?e.set(this.id,"true"):e.set(this.id,"false"),window.history.replaceState({},"",""!==e.toString()?`${location.pathname}?${e}`:`${location.pathname}`)}}enable(){this.flag=!0}get flag(){return!!this.value}set flag(e){this.value=e}}class w extends b{constructor(e,t,s,n,r,de,he,ue=(()=>{})){super(e,t,s,de,ue),this._min=n,this._max=r;const pe=new URLSearchParams(window.location.search);if(he&&pe.has(this.id)){const e=Number.parseInt(pe.get(this.id));this.number=Number.isNaN(e)?de:e}else this.number=de;this.useUrlParams=he}updateURLParams(){if(this.useUrlParams){const e=new URLSearchParams(window.location.search);e.set(this.id,this.number.toString()),window.history.replaceState({},"",""!==e.toString()?`${location.pathname}?${e}`:`${location.pathname}`)}}set number(e){this.value=this.clamp(e)}get number(){return this.value}clamp(e){return Math.max(Math.min(this._max,e),this._min)}get min(){return this._min}get max(){return this._max}addOnChangedListener(e){this.onChange=e}}class P extends b{constructor(e,t,s,n,r,de=(()=>{})){super(e,t,s,n,de);const he=new URLSearchParams(window.location.search);if(r&&he.has(this.id)){const e=this.getUrlParamText();this.text=e}else this.text=n;this.useUrlParams=r}getUrlParamText(){var e;const t=new URLSearchParams(window.location.search);return t.has(this.id)&&null!==(e=t.get(this.id))&&void 0!==e?e:""}updateURLParams(){if(this.useUrlParams){const e=new URLSearchParams(window.location.search);e.set(this.id,this.text),window.history.replaceState({},"",""!==e.toString()?`${location.pathname}?${e}`:`${location.pathname}`)}}get text(){return this.value}set text(e){this.value=e}}class R extends b{constructor(e,t,s,n,r,de,he=(()=>{})){super(e,t,s,[n,n],he),this.options=r;const ue=new URLSearchParams(window.location.search),pe=de&&ue.has(this.id)?this.getUrlParamText():n;this.selected=pe,this.useUrlParams=de}getUrlParamText(){var e;const t=new URLSearchParams(window.location.search);return t.has(this.id)&&null!==(e=t.get(this.id))&&void 0!==e?e:""}updateURLParams(){if(this.useUrlParams){const e=new URLSearchParams(window.location.search);e.set(this.id,this.selected),window.history.replaceState({},"",""!==e.toString()?`${location.pathname}?${e}`:`${location.pathname}`)}}addOnChangedListener(e){this.onChange=e}get options(){return this._options}set options(e){this._options=e,this.onChangeEmit(this.selected)}get selected(){return this.value}set selected(e){let t=this.options.filter((t=>-1!==t.indexOf(e)));t.length?this.value=t[0]:(t=this.options.filter((t=>-1!==t.indexOf(e.split(" ")[0]))),t.length&&(this.value=t[0]))}}class k extends Event{constructor(e){super("afkWarningActivate"),this.data=e}}class L extends Event{constructor(e){super("afkWarningUpdate"),this.data=e}}class x extends Event{constructor(){super("afkWarningDeactivate")}}class A extends Event{constructor(){super("afkTimedOut")}}class F extends Event{constructor(e){super("videoEncoderAvgQP"),this.data=e}}class D extends Event{constructor(){super("webRtcSdp")}}class O extends Event{constructor(){super("webRtcAutoConnect")}}class U extends Event{constructor(){super("webRtcConnecting")}}class I extends Event{constructor(){super("webRtcConnected")}}class G extends Event{constructor(){super("webRtcFailed")}}class z extends Event{constructor(e){super("webRtcDisconnected"),this.data=e}}class B extends Event{constructor(e){super("dataChannelOpen"),this.data=e}}class _ extends Event{constructor(e){super("dataChannelClose"),this.data=e}}class W extends Event{constructor(e){super("dataChannelError"),this.data=e}}class H extends Event{constructor(){super("videoInitialized")}}class V extends Event{constructor(){super("streamLoading")}}class N extends Event{constructor(){super("streamConnect")}}class K extends Event{constructor(){super("streamDisconnect")}}class Q extends Event{constructor(){super("streamReconnect")}}class $ extends Event{constructor(e){super("playStreamError"),this.data=e}}class q extends Event{constructor(){super("playStream")}}class X extends Event{constructor(e){super("playStreamRejected"),this.data=e}}class j extends Event{constructor(e){super("loadFreezeFrame"),this.data=e}}class Y extends Event{constructor(){super("hideFreezeFrame")}}class J extends Event{constructor(e){super("statsReceived"),this.data=e}}class Z extends Event{constructor(e){super("streamerListMessage"),this.data=e}}class ee extends Event{constructor(e){super("latencyTestResult"),this.data=e}}class te extends Event{constructor(e){super("initialSettings"),this.data=e}}class se extends Event{constructor(e){super("settingsChanged"),this.data=e}}class ne extends Event{constructor(){super("xrSessionStarted")}}class re extends Event{constructor(){super("xrSessionEnded")}}class ie extends Event{constructor(e){super("xrFrame"),this.data=e}}class oe extends Event{constructor(e){super("playerCount"),this.data=e}}class ae extends EventTarget{dispatchEvent(e){return super.dispatchEvent(e)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}}class le{}le.AutoConnect="AutoConnect",le.AutoPlayVideo="AutoPlayVideo",le.AFKDetection="TimeoutIfIdle",le.BrowserSendOffer="OfferToReceive",le.HoveringMouseMode="HoveringMouse",le.ForceMonoAudio="ForceMonoAudio",le.ForceTURN="ForceTURN",le.FakeMouseWithTouches="FakeMouseWithTouches",le.IsQualityController="ControlsQuality",le.MatchViewportResolution="MatchViewportRes",le.PreferSFU="preferSFU",le.StartVideoMuted="StartVideoMuted",le.SuppressBrowserKeys="SuppressBrowserKeys",le.UseMic="UseMic",le.KeyboardInput="KeyboardInput",le.MouseInput="MouseInput",le.TouchInput="TouchInput",le.GamepadInput="GamepadInput",le.XRControllerInput="XRControllerInput";const Le=e=>Object.getOwnPropertyNames(le).some((t=>le[t]===e));class ce{}ce.AFKTimeoutSecs="AFKTimeout",ce.MinQP="MinQP",ce.MaxQP="MaxQP",ce.WebRTCFPS="WebRTCFPS",ce.WebRTCMinBitrate="WebRTCMinBitrate",ce.WebRTCMaxBitrate="WebRTCMaxBitrate",ce.MaxReconnectAttempts="MaxReconnectAttempts";const xe=e=>Object.getOwnPropertyNames(ce).some((t=>ce[t]===e));class ge{}ge.SignallingServerUrl="ss";const Ae=e=>Object.getOwnPropertyNames(ge).some((t=>ge[t]===e));class me{}me.PreferredCodec="PreferredCodec",me.StreamerId="StreamerId";const Oe=e=>Object.getOwnPropertyNames(me).some((t=>me[t]===e));class Se{constructor(e={}){this.flags=new Map,this.numericParameters=new Map,this.textParameters=new Map,this.optionParameters=new Map;const{initialSettings:t,useUrlParams:s}=e;this._useUrlParams=!!s,this.populateDefaultSettings(this._useUrlParams),t&&this.setSettings(t)}get useUrlParams(){return this._useUrlParams}populateDefaultSettings(e){this.textParameters.set(ge.SignallingServerUrl,new P(ge.SignallingServerUrl,"Signalling url","Url of the signalling server",("https:"===location.protocol?"wss://":"ws://")+window.location.hostname+("80"===window.location.port||""===window.location.port?"":`:${window.location.port}`),e)),this.optionParameters.set(me.StreamerId,new R(me.StreamerId,"Streamer ID","The ID of the streamer to stream.","",[],e)),this.optionParameters.set(me.PreferredCodec,new R(me.PreferredCodec,"Preferred Codec","The preferred codec to be used during codec negotiation","H264 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f",function(){const e=[];if(!RTCRtpReceiver.getCapabilities)return e.push("Only available on Chrome"),e;const t=/(VP\d|H26\d|AV1).*/;return RTCRtpReceiver.getCapabilities("video").codecs.forEach((s=>{const n=s.mimeType.split("/")[1]+" "+(s.sdpFmtpLine||"");null!==t.exec(n)&&e.push(n)})),e}(),e)),this.flags.set(le.AutoConnect,new M(le.AutoConnect,"Auto connect to stream","Whether we should attempt to auto connect to the signalling server or show a click to start prompt.",!1,e)),this.flags.set(le.AutoPlayVideo,new M(le.AutoPlayVideo,"Auto play video","When video is ready automatically start playing it as opposed to showing a play button.",!0,e)),this.flags.set(le.BrowserSendOffer,new M(le.BrowserSendOffer,"Browser send offer","Browser will initiate the WebRTC handshake by sending the offer to the streamer",!1,e)),this.flags.set(le.UseMic,new M(le.UseMic,"Use microphone","Make browser request microphone access and open an input audio track.",!1,e)),this.flags.set(le.StartVideoMuted,new M(le.StartVideoMuted,"Start video muted","Video will start muted if true.",!1,e)),this.flags.set(le.SuppressBrowserKeys,new M(le.SuppressBrowserKeys,"Suppress browser keys","Suppress certain browser keys that we use in UE, for example F5 to show shader complexity instead of refresh the page.",!0,e)),this.flags.set(le.PreferSFU,new M(le.PreferSFU,"Prefer SFU","Try to connect to the SFU instead of P2P.",!1,e)),this.flags.set(le.IsQualityController,new M(le.IsQualityController,"Is quality controller?","True if this peer controls stream quality",!0,e)),this.flags.set(le.ForceMonoAudio,new M(le.ForceMonoAudio,"Force mono audio","Force browser to request mono audio in the SDP",!1,e)),this.flags.set(le.ForceTURN,new M(le.ForceTURN,"Force TURN","Only generate TURN/Relayed ICE candidates.",!1,e)),this.flags.set(le.AFKDetection,new M(le.AFKDetection,"AFK if idle","Timeout the experience if user is AFK for a period.",!1,e)),this.flags.set(le.MatchViewportResolution,new M(le.MatchViewportResolution,"Match viewport resolution","Pixel Streaming will be instructed to dynamically resize the video stream to match the size of the video element.",!1,e)),this.flags.set(le.HoveringMouseMode,new M(le.HoveringMouseMode,"Control Scheme: Locked Mouse","Either locked mouse, where the pointer is consumed by the video and locked to it, or hovering mouse, where the mouse is not consumed.",!1,e,((e,t)=>{t.label=`Control Scheme: ${e?"Hovering":"Locked"} Mouse`}))),this.flags.set(le.FakeMouseWithTouches,new M(le.FakeMouseWithTouches,"Fake mouse with touches","A single finger touch is converted into a mouse event. This allows a non-touch application to be controlled partially via a touch device.",!1,e)),this.flags.set(le.KeyboardInput,new M(le.KeyboardInput,"Keyboard input","If enabled, send keyboard events to streamer",!0,e)),this.flags.set(le.MouseInput,new M(le.MouseInput,"Mouse input","If enabled, send mouse events to streamer",!0,e)),this.flags.set(le.TouchInput,new M(le.TouchInput,"Touch input","If enabled, send touch events to streamer",!0,e)),this.flags.set(le.GamepadInput,new M(le.GamepadInput,"Gamepad input","If enabled, send gamepad events to streamer",!0,e)),this.flags.set(le.XRControllerInput,new M(le.XRControllerInput,"XR controller input","If enabled, send XR controller events to streamer",!0,e)),this.numericParameters.set(ce.AFKTimeoutSecs,new w(ce.AFKTimeoutSecs,"AFK timeout","The time (in seconds) it takes for the application to time out if AFK timeout is enabled.",0,600,120,e)),this.numericParameters.set(ce.MaxReconnectAttempts,new w(ce.MaxReconnectAttempts,"Max Reconnects","Maximum number of reconnects the application will attempt when a streamer disconnects.",0,999,3,e)),this.numericParameters.set(ce.MinQP,new w(ce.MinQP,"Min QP","The lower bound for the quantization parameter (QP) of the encoder. 0 = Best quality, 51 = worst quality.",0,51,0,e)),this.numericParameters.set(ce.MaxQP,new w(ce.MaxQP,"Max QP","The upper bound for the quantization parameter (QP) of the encoder. 0 = Best quality, 51 = worst quality.",0,51,51,e)),this.numericParameters.set(ce.WebRTCFPS,new w(ce.WebRTCFPS,"Max FPS","The maximum FPS that WebRTC will try to transmit frames at.",1,999,60,e)),this.numericParameters.set(ce.WebRTCMinBitrate,new w(ce.WebRTCMinBitrate,"Min Bitrate (kbps)","The minimum bitrate that WebRTC should use.",0,5e5,0,e)),this.numericParameters.set(ce.WebRTCMaxBitrate,new w(ce.WebRTCMaxBitrate,"Max Bitrate (kbps)","The maximum bitrate that WebRTC should use.",0,5e5,0,e))}_addOnNumericSettingChangedListener(e,t){this.numericParameters.has(e)&&this.numericParameters.get(e).addOnChangedListener(t)}_addOnOptionSettingChangedListener(e,t){this.optionParameters.has(e)&&this.optionParameters.get(e).addOnChangedListener(t)}getNumericSettingValue(e){if(this.numericParameters.has(e))return this.numericParameters.get(e).number;throw new Error(`There is no numeric setting with the id of ${e}`)}getTextSettingValue(e){if(this.textParameters.has(e))return this.textParameters.get(e).value;throw new Error(`There is no numeric setting with the id of ${e}`)}setNumericSetting(e,t){if(!this.numericParameters.has(e))throw new Error(`There is no numeric setting with the id of ${e}`);this.numericParameters.get(e).number=t}_addOnSettingChangedListener(e,t){this.flags.has(e)&&(this.flags.get(e).onChange=t)}_addOnTextSettingChangedListener(e,t){this.textParameters.has(e)&&(this.textParameters.get(e).onChange=t)}getSettingOption(e){return this.optionParameters.get(e)}isFlagEnabled(e){return this.flags.get(e).flag}setFlagEnabled(e,t){this.flags.has(e)?this.flags.get(e).flag=t:i.Warning(i.GetStackTrace(),`Cannot toggle flag called ${e} - it does not exist in the Config.flags map.`)}setTextSetting(e,t){this.textParameters.has(e)?this.textParameters.get(e).text=t:i.Warning(i.GetStackTrace(),`Cannot set text setting called ${e} - it does not exist in the Config.textParameters map.`)}setOptionSettingOptions(e,t){this.optionParameters.has(e)?this.optionParameters.get(e).options=t:i.Warning(i.GetStackTrace(),`Cannot set text setting called ${e} - it does not exist in the Config.optionParameters map.`)}setOptionSettingValue(e,t){this.optionParameters.has(e)?this.optionParameters.get(e).selected=t:i.Warning(i.GetStackTrace(),`Cannot set text setting called ${e} - it does not exist in the Config.enumParameters map.`)}setFlagLabel(e,t){this.flags.has(e)?this.flags.get(e).label=t:i.Warning(i.GetStackTrace(),`Cannot set label for flag called ${e} - it does not exist in the Config.flags map.`)}setSettings(e){for(const t of Object.keys(e))Le(t)?this.setFlagEnabled(t,e[t]):xe(t)?this.setNumericSetting(t,e[t]):Ae(t)?this.setTextSetting(t,e[t]):Oe(t)&&this.setOptionSettingValue(t,e[t])}getSettings(){const e={};for(const[t,s]of this.flags.entries())e[t]=s.flag;for(const[t,s]of this.numericParameters.entries())e[t]=s.number;for(const[t,s]of this.textParameters.entries())e[t]=s.text;for(const[t,s]of this.optionParameters.entries())e[t]=s.selected;return e}getFlags(){return Array.from(this.flags.values())}getTextSettings(){return Array.from(this.textParameters.values())}getNumericSettings(){return Array.from(this.numericParameters.values())}getOptionSettings(){return Array.from(this.optionParameters.values())}_registerOnChangeEvents(e){for(const t of this.flags.keys()){const s=this.flags.get(t);s&&(s.onChangeEmit=t=>e.dispatchEvent(new se({id:s.id,type:"flag",value:t,target:s})))}for(const t of this.numericParameters.keys()){const s=this.numericParameters.get(t);s&&(s.onChangeEmit=t=>e.dispatchEvent(new se({id:s.id,type:"number",value:t,target:s})))}for(const t of this.textParameters.keys()){const s=this.textParameters.get(t);s&&(s.onChangeEmit=t=>e.dispatchEvent(new se({id:s.id,type:"text",value:t,target:s})))}for(const t of this.optionParameters.keys()){const s=this.optionParameters.get(t);s&&(s.onChangeEmit=t=>e.dispatchEvent(new se({id:s.id,type:"option",value:t,target:s})))}}}var De;!function(e){e[e.LockedMouse=0]="LockedMouse",e[e.HoveringMouse=1]="HoveringMouse"}(De||(De={}));class Ce{constructor(e,t,s){this.closeTimeout=10,this.active=!1,this.countdownActive=!1,this.warnTimer=void 0,this.countDown=0,this.countDownTimer=void 0,this.config=e,this.pixelStreaming=t,this.onDismissAfk=s,this.onAFKTimedOutCallback=()=>{console.log("AFK timed out, did you want to override this callback?")}}onAfkClick(){clearInterval(this.countDownTimer),(this.active||this.countdownActive)&&(this.startAfkWarningTimer(),this.pixelStreaming.dispatchEvent(new x))}startAfkWarningTimer(){this.config.getNumericSettingValue(ce.AFKTimeoutSecs)>0&&this.config.isFlagEnabled(le.AFKDetection)?this.active=!0:this.active=!1,this.resetAfkWarningTimer()}stopAfkWarningTimer(){this.active=!1,this.countdownActive=!1,clearTimeout(this.warnTimer),clearInterval(this.countDownTimer)}pauseAfkWarningTimer(){this.active=!1}resetAfkWarningTimer(){this.active&&this.config.isFlagEnabled(le.AFKDetection)&&(clearTimeout(this.warnTimer),this.warnTimer=setTimeout((()=>this.activateAfkEvent()),1e3*this.config.getNumericSettingValue(ce.AFKTimeoutSecs)))}activateAfkEvent(){this.pauseAfkWarningTimer(),this.pixelStreaming.dispatchEvent(new k({countDown:this.countDown,dismissAfk:this.onDismissAfk})),this.countDown=this.closeTimeout,this.countdownActive=!0,this.pixelStreaming.dispatchEvent(new L({countDown:this.countDown})),this.config.isFlagEnabled(le.HoveringMouseMode)||document.exitPointerLock&&document.exitPointerLock(),this.countDownTimer=setInterval((()=>{this.countDown--,0==this.countDown?(this.pixelStreaming.dispatchEvent(new A),this.onAFKTimedOutCallback(),i.Log(i.GetStackTrace(),"You have been disconnected due to inactivity"),this.stopAfkWarningTimer()):this.pixelStreaming.dispatchEvent(new L({countDown:this.countDown}))}),1e3)}}class fe{constructor(){this.isReceivingFreezeFrame=!1}getDataChannelInstance(){return this}createDataChannel(e,t,s){this.peerConnection=e,this.label=t,this.datachannelOptions=s,null==s&&(this.datachannelOptions={},this.datachannelOptions.ordered=!0),this.dataChannel=this.peerConnection.createDataChannel(this.label,this.datachannelOptions),this.setupDataChannel()}setupDataChannel(){this.dataChannel.binaryType="arraybuffer",this.dataChannel.onopen=e=>this.handleOnOpen(e),this.dataChannel.onclose=e=>this.handleOnClose(e),this.dataChannel.onmessage=e=>this.handleOnMessage(e),this.dataChannel.onerror=e=>this.handleOnError(e)}handleOnOpen(e){var t;i.Log(i.GetStackTrace(),`Data Channel (${this.label}) opened.`,7),this.onOpen(null===(t=this.dataChannel)||void 0===t?void 0:t.label,e)}handleOnClose(e){var t;i.Log(i.GetStackTrace(),`Data Channel (${this.label}) closed.`,7),this.onClose(null===(t=this.dataChannel)||void 0===t?void 0:t.label,e)}handleOnMessage(e){i.Log(i.GetStackTrace(),`Data Channel (${this.label}) message: ${e}`,8)}handleOnError(e){var t;i.Log(i.GetStackTrace(),`Data Channel (${this.label}) error: ${e}`,7),this.onError(null===(t=this.dataChannel)||void 0===t?void 0:t.label,e)}onOpen(e,t){}onClose(e,t){}onError(e,t){}}class Ee{}class Te{}class ye{}class be{}class Me{}class we{}class Pe{}class Re{}class ke{constructor(){this.inboundVideoStats=new Te,this.inboundAudioStats=new Ee,this.candidatePair=new Me,this.DataChannelStats=new ye,this.outBoundVideoStats=new we,this.sessionStats=new Pe,this.streamStats=new Re,this.codecs=new Map}processStats(e){this.localCandidates=new Array,this.remoteCandidates=new Array,e.forEach((e=>{switch(e.type){case"candidate-pair":this.handleCandidatePair(e);break;case"certificate":case"media-source":case"media-playout":case"outbound-rtp":case"peer-connection":case"remote-inbound-rtp":case"transport":break;case"codec":this.handleCodec(e);break;case"data-channel":this.handleDataChannel(e);break;case"inbound-rtp":this.handleInBoundRTP(e);break;case"local-candidate":this.handleLocalCandidate(e);break;case"remote-candidate":this.handleRemoteCandidate(e);break;case"remote-outbound-rtp":this.handleRemoteOutBound(e);break;case"track":this.handleTrack(e);break;case"stream":this.handleStream(e);break;default:i.Error(i.GetStackTrace(),"unhandled Stat Type"),i.Log(i.GetStackTrace(),e)}}))}handleStream(e){this.streamStats=e}handleCandidatePair(e){this.candidatePair.bytesReceived=e.bytesReceived,this.candidatePair.bytesSent=e.bytesSent,this.candidatePair.localCandidateId=e.localCandidateId,this.candidatePair.remoteCandidateId=e.remoteCandidateId,this.candidatePair.nominated=e.nominated,this.candidatePair.readable=e.readable,this.candidatePair.selected=e.selected,this.candidatePair.writable=e.writable,this.candidatePair.state=e.state,this.candidatePair.currentRoundTripTime=e.currentRoundTripTime}handleDataChannel(e){this.DataChannelStats.bytesReceived=e.bytesReceived,this.DataChannelStats.bytesSent=e.bytesSent,this.DataChannelStats.dataChannelIdentifier=e.dataChannelIdentifier,this.DataChannelStats.id=e.id,this.DataChannelStats.label=e.label,this.DataChannelStats.messagesReceived=e.messagesReceived,this.DataChannelStats.messagesSent=e.messagesSent,this.DataChannelStats.protocol=e.protocol,this.DataChannelStats.state=e.state,this.DataChannelStats.timestamp=e.timestamp}handleLocalCandidate(e){const t=new be;t.label="local-candidate",t.address=e.address,t.port=e.port,t.protocol=e.protocol,t.candidateType=e.candidateType,t.id=e.id,this.localCandidates.push(t)}handleRemoteCandidate(e){const t=new be;t.label="local-candidate",t.address=e.address,t.port=e.port,t.protocol=e.protocol,t.id=e.id,t.candidateType=e.candidateType,this.remoteCandidates.push(t)}handleInBoundRTP(e){switch(e.kind){case"video":this.inboundVideoStats=e,null!=this.lastVideoStats&&(this.inboundVideoStats.bitrate=8*(this.inboundVideoStats.bytesReceived-this.lastVideoStats.bytesReceived)/(this.inboundVideoStats.timestamp-this.lastVideoStats.timestamp),this.inboundVideoStats.bitrate=Math.floor(this.inboundVideoStats.bitrate)),this.lastVideoStats=Object.assign({},this.inboundVideoStats);break;case"audio":this.inboundAudioStats=e,null!=this.lastAudioStats&&(this.inboundAudioStats.bitrate=8*(this.inboundAudioStats.bytesReceived-this.lastAudioStats.bytesReceived)/(this.inboundAudioStats.timestamp-this.lastAudioStats.timestamp),this.inboundAudioStats.bitrate=Math.floor(this.inboundAudioStats.bitrate)),this.lastAudioStats=Object.assign({},this.inboundAudioStats);break;default:i.Log(i.GetStackTrace(),"Kind is not handled")}}handleRemoteOutBound(e){"video"===e.kind&&(this.outBoundVideoStats.bytesSent=e.bytesSent,this.outBoundVideoStats.id=e.id,this.outBoundVideoStats.localId=e.localId,this.outBoundVideoStats.packetsSent=e.packetsSent,this.outBoundVideoStats.remoteTimestamp=e.remoteTimestamp,this.outBoundVideoStats.timestamp=e.timestamp)}handleTrack(e){"track"!==e.type||"video_label"!==e.trackIdentifier&&"video"!==e.kind||(this.inboundVideoStats.framesDropped=e.framesDropped,this.inboundVideoStats.framesReceived=e.framesReceived,this.inboundVideoStats.frameHeight=e.frameHeight,this.inboundVideoStats.frameWidth=e.frameWidth)}handleCodec(e){const t=e.id,s=`${e.mimeType.replace("video/","").replace("audio/","")}${e.sdpFmtpLine?` ${e.sdpFmtpLine}`:""}`;this.codecs.set(t,s)}handleSessionStatistics(e,t,s){const n=Date.now()-e;this.sessionStats.runTime=new Date(n).toISOString().substr(11,8).toString();const r=null===t?"Not sent yet":t?"true":"false";this.sessionStats.controlsStreamInput=r,this.sessionStats.videoEncoderAvgQP=s}isNumber(e){return"number"==typeof e&&isFinite(e)}}const Fe=(yt={parseRtpParameters:()=>ue.parseRtpParameters,splitSections:()=>ue.splitSections},bt={},pe.d(bt,yt),bt);var yt,bt,Pt,wt,Mt=function(e,t,s,n){return new(s||(s=Promise))((function(r,de){function he(e){try{pe(n.next(e))}catch(t){de(t)}}function ue(e){try{pe(n.throw(e))}catch(t){de(t)}}function pe(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(he,ue)}pe((n=n.apply(e,t||[])).next())}))};class Ue{constructor(e,t,s){this.config=t,this.createPeerConnection(e,s)}createPeerConnection(e,t){this.config.isFlagEnabled(le.ForceTURN)&&(e.iceTransportPolicy="relay",i.Log(i.GetStackTrace(),"Forcing TURN usage by setting ICE Transport Policy in peer connection config.")),this.peerConnection=new RTCPeerConnection(e),this.peerConnection.onsignalingstatechange=e=>this.handleSignalStateChange(e),this.peerConnection.oniceconnectionstatechange=e=>this.handleIceConnectionStateChange(e),this.peerConnection.onicegatheringstatechange=e=>this.handleIceGatheringStateChange(e),this.peerConnection.ontrack=e=>this.handleOnTrack(e),this.peerConnection.onicecandidate=e=>this.handleIceCandidate(e),this.peerConnection.ondatachannel=e=>this.handleDataChannel(e),this.aggregatedStats=new ke,this.preferredCodec=t,this.updateCodecSelection=!0}createOffer(e,t){return Mt(this,void 0,void 0,(function*(){i.Log(i.GetStackTrace(),"Create Offer",6);const s="localhost"===location.hostname||"127.0.0.1"===location.hostname,n="https:"===location.protocol;let r=t.isFlagEnabled(le.UseMic);!r||s||n||(r=!1,i.Error(i.GetStackTrace(),"Microphone access in the browser will not work if you are not on HTTPS or localhost. Disabling mic access."),i.Error(i.GetStackTrace(),"For testing you can enable HTTP microphone access Chrome by visiting chrome://flags/ and enabling 'unsafely-treat-insecure-origin-as-secure'")),this.setupTransceiversAsync(r).finally((()=>{var t;null===(t=this.peerConnection)||void 0===t||t.createOffer(e).then((e=>{var t;this.showTextOverlayConnecting(),e.sdp=this.mungeSDP(e.sdp,r),null===(t=this.peerConnection)||void 0===t||t.setLocalDescription(e),this.onSendWebRTCOffer(e)})).catch((()=>{this.showTextOverlaySetupFailure()}))}))}))}receiveOffer(e,t){var s;return Mt(this,void 0,void 0,(function*(){i.Log(i.GetStackTrace(),"Receive Offer",6),null===(s=this.peerConnection)||void 0===s||s.setRemoteDescription(e).then((()=>{const e="localhost"===location.hostname||"127.0.0.1"===location.hostname,s="https:"===location.protocol;let n=t.isFlagEnabled(le.UseMic);!n||e||s||(n=!1,i.Error(i.GetStackTrace(),"Microphone access in the browser will not work if you are not on HTTPS or localhost. Disabling mic access."),i.Error(i.GetStackTrace(),"For testing you can enable HTTP microphone access Chrome by visiting chrome://flags/ and enabling 'unsafely-treat-insecure-origin-as-secure'")),this.setupTransceiversAsync(n).finally((()=>{var e;null===(e=this.peerConnection)||void 0===e||e.createAnswer().then((e=>{var t;return e.sdp=this.mungeSDP(e.sdp,n),null===(t=this.peerConnection)||void 0===t?void 0:t.setLocalDescription(e)})).then((()=>{var e;this.onSendWebRTCAnswer(null===(e=this.peerConnection)||void 0===e?void 0:e.currentLocalDescription)})).catch((()=>{i.Error(i.GetStackTrace(),"createAnswer() failed")}))}))})),this.config.setOptionSettingOptions(me.PreferredCodec,this.parseAvailableCodecs(e).filter((e=>this.config.getSettingOption(me.PreferredCodec).options.includes(e))))}))}receiveAnswer(e){var t;null===(t=this.peerConnection)||void 0===t||t.setRemoteDescription(e),this.config.setOptionSettingOptions(me.PreferredCodec,this.parseAvailableCodecs(e).filter((e=>this.config.getSettingOption(me.PreferredCodec).options.includes(e))))}generateStats(){var e;null===(e=this.peerConnection)||void 0===e||e.getStats(null).then((e=>{this.aggregatedStats.processStats(e),this.onVideoStats(this.aggregatedStats),this.updateCodecSelection&&this.config.setOptionSettingValue(me.PreferredCodec,this.aggregatedStats.codecs.get(this.aggregatedStats.inboundVideoStats.codecId))}))}close(){this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}mungeSDP(e,t){let s=e.replace(/(a=fmtp:\d+ .*level-asymmetry-allowed=.*)\r\n/gm,"$1;x-google-start-bitrate=10000;x-google-max-bitrate=100000\r\n"),n="maxaveragebitrate=510000;";return t&&(n+="sprop-maxcapturerate=48000;"),n+=this.config.isFlagEnabled(le.ForceMonoAudio)?"stereo=0;":"stereo=1;",n+="useinbandfec=1",s=s.replace("useinbandfec=1",n),s}handleOnIce(e){var t;i.Log(i.GetStackTrace(),"peerconnection handleOnIce",6),this.config.isFlagEnabled(le.ForceTURN)&&e.candidate.indexOf("relay")<0?i.Info(i.GetStackTrace(),`Dropping candidate because it was not TURN relay. | Type= ${e.type} | Protocol= ${e.protocol} | Address=${e.address} | Port=${e.port} |`,6):null===(t=this.peerConnection)||void 0===t||t.addIceCandidate(e)}handleSignalStateChange(e){i.Log(i.GetStackTrace(),"signaling state change: "+e,6)}handleIceConnectionStateChange(e){i.Log(i.GetStackTrace(),"ice connection state change: "+e,6),this.onIceConnectionStateChange(e)}handleIceGatheringStateChange(e){i.Log(i.GetStackTrace(),"ice gathering state change: "+JSON.stringify(e),6)}handleOnTrack(e){this.onTrack(e)}handleIceCandidate(e){this.onPeerIceCandidate(e)}handleDataChannel(e){this.onDataChannel(e)}onTrack(e){}onIceConnectionStateChange(e){}onPeerIceCandidate(e){}onDataChannel(e){}setupTransceiversAsync(e){var t,s,n,r,de,he,ue,pe,ve;return Mt(this,void 0,void 0,(function*(){const Le=(null===(t=this.peerConnection)||void 0===t?void 0:t.getTransceivers().length)>0;if(null===(s=this.peerConnection)||void 0===s||s.addTransceiver("video",{direction:"recvonly"}),RTCRtpReceiver.getCapabilities&&""!=this.preferredCodec)for(const e of null!==(r=null===(n=this.peerConnection)||void 0===n?void 0:n.getTransceivers())&&void 0!==r?r:[])if(e&&e.receiver&&e.receiver.track&&"video"===e.receiver.track.kind&&e.setCodecPreferences){const t=this.preferredCodec.split(" "),s=[{mimeType:"video/"+t[0],clockRate:9e4,sdpFmtpLine:t[1]?t[1]:""}];this.config.getSettingOption(me.PreferredCodec).options.filter((e=>e!=this.preferredCodec)).forEach((e=>{const t=e.split(" ");s.push({mimeType:"video/"+t[0],clockRate:9e4,sdpFmtpLine:t[1]?t[1]:""})}));for(const e of s)""===e.sdpFmtpLine&&delete e.sdpFmtpLine;e.setCodecPreferences(s)}if(e){const t={video:!1,audio:!!e&&{autoGainControl:!1,channelCount:1,echoCancellation:!1,latency:0,noiseSuppression:!1,sampleRate:48e3,sampleSize:16,volume:1}},s=yield navigator.mediaDevices.getUserMedia(t);if(s)if(Le){for(const e of null!==(ue=null===(he=this.peerConnection)||void 0===he?void 0:he.getTransceivers())&&void 0!==ue?ue:[])if(e&&e.receiver&&e.receiver.track&&"audio"===e.receiver.track.kind)for(const t of s.getTracks())t.kind&&"audio"==t.kind&&(e.sender.replaceTrack(t),e.direction="sendrecv")}else for(const e of s.getTracks())e.kind&&"audio"==e.kind&&(null===(pe=this.peerConnection)||void 0===pe||pe.addTransceiver(e,{direction:"sendrecv"}));else null===(ve=this.peerConnection)||void 0===ve||ve.addTransceiver("audio",{direction:"recvonly"})}else null===(de=this.peerConnection)||void 0===de||de.addTransceiver("audio",{direction:"recvonly"})}))}onVideoStats(e){}onSendWebRTCOffer(e){}onSendWebRTCAnswer(e){}showTextOverlayConnecting(){}showTextOverlaySetupFailure(){}parseAvailableCodecs(e){if(!RTCRtpReceiver.getCapabilities)return["Only available on Chrome"];const t=[],s=(0,Fe.splitSections)(e.sdp);return s.shift(),s.forEach((e=>{const{codecs:s}=(0,Fe.parseRtpParameters)(e),n=/(VP\d|H26\d|AV1).*/;s.forEach((e=>{const s=e.name+" "+Object.keys(e.parameters||{}).map((t=>t+"="+e.parameters[t])).join(";");if(null!==n.exec(s)){"VP9"==e.name&&(e.parameters={"profile-id":"0"});const s=e.name+" "+Object.keys(e.parameters||{}).map((t=>t+"="+e.parameters[t])).join(";");t.push(s)}}))})),t}}class Ie{constructor(){this.PixelStreamingSettings=new Ge,this.EncoderSettings=new ze,this.WebRTCSettings=new Be}ueCompatible(){null!=this.WebRTCSettings.MaxFPS&&(this.WebRTCSettings.FPS=this.WebRTCSettings.MaxFPS)}}class Ge{}class ze{}class Be{}class _e{constructor(){this.ReceiptTimeMs=null,this.TransmissionTimeMs=null,this.PreCaptureTimeMs=null,this.PostCaptureTimeMs=null,this.PreEncodeTimeMs=null,this.PostEncodeTimeMs=null,this.EncodeMs=null,this.CaptureToSendMs=null,this.testStartTimeMs=0,this.browserReceiptTimeMs=0,this.latencyExcludingDecode=0,this.testDuration=0,this.networkLatency=0,this.browserSendLatency=0,this.frameDisplayDeltaTimeMs=0,this.endToEndLatency=0,this.encodeLatency=0}setFrameDisplayDeltaTime(e){0==this.frameDisplayDeltaTimeMs&&(this.frameDisplayDeltaTimeMs=Math.round(e))}processFields(){null!=this.EncodeMs||null==this.PreEncodeTimeMs&&null==this.PostEncodeTimeMs||(i.Log(i.GetStackTrace(),`Setting Encode Ms \n ${this.PostEncodeTimeMs} \n ${this.PreEncodeTimeMs}`,6),this.EncodeMs=this.PostEncodeTimeMs-this.PreEncodeTimeMs),null!=this.CaptureToSendMs||null==this.PreCaptureTimeMs&&null==this.PostCaptureTimeMs||(i.Log(i.GetStackTrace(),`Setting CaptureToSendMs Ms \n ${this.PostCaptureTimeMs} \n ${this.PreCaptureTimeMs}`,6),this.CaptureToSendMs=this.PostCaptureTimeMs-this.PreCaptureTimeMs)}}class We{static setExtensionFromBytes(e,t){t.receiving||(t.mimetype="",t.extension="",t.receiving=!0,t.valid=!1,t.size=0,t.data=[],t.timestampStart=(new Date).getTime(),i.Log(i.GetStackTrace(),"Received first chunk of file",6));const s=new TextDecoder("utf-16").decode(e.slice(1));i.Log(i.GetStackTrace(),s,6),t.extension=s}static setMimeTypeFromBytes(e,t){t.receiving||(t.mimetype="",t.extension="",t.receiving=!0,t.valid=!1,t.size=0,t.data=[],t.timestampStart=(new Date).getTime(),i.Log(i.GetStackTrace(),"Received first chunk of file",6));const s=new TextDecoder("utf-16").decode(e.slice(1));i.Log(i.GetStackTrace(),s,6),t.mimetype=s}static setContentsFromBytes(e,t){if(!t.receiving)return;t.size=Math.ceil(new DataView(e.slice(1,5).buffer).getInt32(0,!0)/16379);const s=e.slice(5);if(t.data.push(s),i.Log(i.GetStackTrace(),`Received file chunk: ${t.data.length}/${t.size}`,6),t.data.length===t.size){t.receiving=!1,t.valid=!0,i.Log(i.GetStackTrace(),"Received complete file",6);const e=(new Date).getTime()-t.timestampStart,s=Math.round(16*t.size*1024/e);i.Log(i.GetStackTrace(),`Average transfer bitrate: ${s}kb/s over ${e/1e3} seconds`,6);const n=new Blob(t.data,{type:t.mimetype}),r=document.createElement("a");r.setAttribute("href",URL.createObjectURL(n)),r.setAttribute("download",`transfer.${t.extension}`),document.body.append(r),r.remove()}else t.data.length>t.size&&(t.receiving=!1,i.Error(i.GetStackTrace(),`Received bigger file than advertised: ${t.data.length}/${t.size}`))}}class He{constructor(){this.mimetype="",this.extension="",this.receiving=!1,this.size=0,this.data=[],this.valid=!1}}class Ve{}Ve.mainButton=0,Ve.auxiliaryButton=1,Ve.secondaryButton=2,Ve.fourthButton=3,Ve.fifthButton=4;class Ne{}Ne.primaryButton=1,Ne.secondaryButton=2,Ne.auxiliaryButton=4,Ne.fourthButton=8,Ne.fifthButton=16;class Ke{constructor(){this.unregisterCallbacks=[]}addUnregisterCallback(e){this.unregisterCallbacks.push(e)}unregisterAll(){for(const e of this.unregisterCallbacks)e();this.unregisterCallbacks=[]}}class Qe{constructor(e,t,s){this.touchEventListenerTracker=new Ke,this.toStreamerMessagesProvider=e,this.videoElementProvider=t,this.coordinateConverter=s;const n=e=>this.onTouchStart(e),r=e=>this.onTouchEnd(e),de=e=>this.onTouchMove(e);document.addEventListener("touchstart",n,{passive:!1}),document.addEventListener("touchend",r,{passive:!1}),document.addEventListener("touchmove",de,{passive:!1}),this.touchEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("touchstart",n))),this.touchEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("touchend",r))),this.touchEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("touchmove",de)))}unregisterTouchEvents(){this.touchEventListenerTracker.unregisterAll()}setVideoElementParentClientRect(e){this.videoElementParentClientRect=e}onTouchStart(e){if(this.videoElementProvider.isVideoReady()){if(null==this.fakeTouchFinger){const t=e.changedTouches[0];this.fakeTouchFinger=new $e(t.identifier,t.clientX-this.videoElementParentClientRect.left,t.clientY-this.videoElementParentClientRect.top);const s=this.videoElementProvider.getVideoParentElement(),n=new MouseEvent("mouseenter",t);s.dispatchEvent(n);const r=this.coordinateConverter.normalizeAndQuantizeUnsigned(this.fakeTouchFinger.x,this.fakeTouchFinger.y);this.toStreamerMessagesProvider.toStreamerHandlers.get("MouseDown")([Ve.mainButton,r.x,r.y])}e.preventDefault()}}onTouchEnd(e){if(!this.videoElementProvider.isVideoReady())return;const t=this.videoElementProvider.getVideoParentElement(),s=this.toStreamerMessagesProvider.toStreamerHandlers;for(let n=0;n<e.changedTouches.length;n++){const r=e.changedTouches[n];if(r.identifier===this.fakeTouchFinger.id){const e=r.clientX-this.videoElementParentClientRect.left,n=r.clientY-this.videoElementParentClientRect.top,de=this.coordinateConverter.normalizeAndQuantizeUnsigned(e,n);s.get("MouseUp")([Ve.mainButton,de.x,de.y]);const he=new MouseEvent("mouseleave",r);t.dispatchEvent(he),this.fakeTouchFinger=null;break}}e.preventDefault()}onTouchMove(e){if(!this.videoElementProvider.isVideoReady())return;const t=this.toStreamerMessagesProvider.toStreamerHandlers;for(let s=0;s<e.touches.length;s++){const n=e.touches[s];if(n.identifier===this.fakeTouchFinger.id){const e=n.clientX-this.videoElementParentClientRect.left,s=n.clientY-this.videoElementParentClientRect.top,r=this.coordinateConverter.normalizeAndQuantizeUnsigned(e,s),de=this.coordinateConverter.normalizeAndQuantizeSigned(e-this.fakeTouchFinger.x,s-this.fakeTouchFinger.y);t.get("MouseMove")([r.x,r.y,de.x,de.y]),this.fakeTouchFinger.x=e,this.fakeTouchFinger.y=s;break}}e.preventDefault()}}class $e{constructor(e,t,s){this.id=e,this.x=t,this.y=s}}class qe{}qe.backSpace=8,qe.shift=16,qe.control=17,qe.alt=18,qe.rightShift=253,qe.rightControl=254,qe.rightAlt=255;class Xe{constructor(e,t,s){this.keyboardEventListenerTracker=new Ke,this.CodeToKeyCode={Escape:27,Digit0:48,Digit1:49,Digit2:50,Digit3:51,Digit4:52,Digit5:53,Digit6:54,Digit7:55,Digit8:56,Digit9:57,Minus:173,Equal:187,Backspace:8,Tab:9,KeyQ:81,KeyW:87,KeyE:69,KeyR:82,KeyT:84,KeyY:89,KeyU:85,KeyI:73,KeyO:79,KeyP:80,BracketLeft:219,BracketRight:221,Enter:13,ControlLeft:17,KeyA:65,KeyS:83,KeyD:68,KeyF:70,KeyG:71,KeyH:72,KeyJ:74,KeyK:75,KeyL:76,Semicolon:186,Quote:222,Backquote:192,ShiftLeft:16,Backslash:220,KeyZ:90,KeyX:88,KeyC:67,KeyV:86,KeyB:66,KeyN:78,KeyM:77,Comma:188,Period:190,Slash:191,ShiftRight:253,AltLeft:18,Space:32,CapsLock:20,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Pause:19,ScrollLock:145,NumpadDivide:111,NumpadMultiply:106,NumpadSubtract:109,NumpadAdd:107,NumpadDecimal:110,Numpad9:105,Numpad8:104,Numpad7:103,Numpad6:102,Numpad5:101,Numpad4:100,Numpad3:99,Numpad2:98,Numpad1:97,Numpad0:96,NumLock:144,ControlRight:254,AltRight:255,Home:36,End:35,ArrowUp:38,ArrowLeft:37,ArrowRight:39,ArrowDown:40,PageUp:33,PageDown:34,Insert:45,Delete:46,ContextMenu:93},this.toStreamerMessagesProvider=e,this.config=t,this.activeKeysProvider=s}registerKeyBoardEvents(){const e=e=>this.handleOnKeyDown(e),t=e=>this.handleOnKeyUp(e),s=e=>this.handleOnKeyPress(e);document.addEventListener("keydown",e),document.addEventListener("keyup",t),document.addEventListener("keypress",s),this.keyboardEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("keydown",e))),this.keyboardEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("keyup",t))),this.keyboardEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("keypress",s)))}unregisterKeyBoardEvents(){this.keyboardEventListenerTracker.unregisterAll()}handleOnKeyDown(e){const t=this.getKeycode(e);t&&(i.Log(i.GetStackTrace(),`key down ${t}, repeat = ${e.repeat}`,6),this.toStreamerMessagesProvider.toStreamerHandlers.get("KeyDown")([this.getKeycode(e),e.repeat?1:0]),this.activeKeysProvider.getActiveKeys().push(t),t===qe.backSpace&&document.dispatchEvent(new KeyboardEvent("keypress",{charCode:qe.backSpace})),this.config.isFlagEnabled(le.SuppressBrowserKeys)&&this.isKeyCodeBrowserKey(t)&&e.preventDefault())}handleOnKeyUp(e){const t=this.getKeycode(e);t&&(i.Log(i.GetStackTrace(),`key up ${t}`,6),this.toStreamerMessagesProvider.toStreamerHandlers.get("KeyUp")([t,e.repeat?1:0]),this.config.isFlagEnabled(le.SuppressBrowserKeys)&&this.isKeyCodeBrowserKey(t)&&e.preventDefault())}handleOnKeyPress(e){if(!("charCode"in e))return void i.Warning(i.GetStackTrace(),"KeyboardEvent.charCode is deprecated in this browser, cannot send key press.");const t=e.charCode;i.Log(i.GetStackTrace(),`key press ${t}`,6),this.toStreamerMessagesProvider.toStreamerHandlers.get("KeyPress")([t])}getKeycode(e){if(!("keyCode"in e)){const t=e;return t.code in this.CodeToKeyCode?this.CodeToKeyCode[t.code]:(i.Warning(i.GetStackTrace(),`Keyboard code of ${t.code} is not supported in our mapping, ignoring this key.`),null)}return e.keyCode===qe.shift&&"ShiftRight"===e.code?qe.rightShift:e.keyCode===qe.control&&"ControlRight"===e.code?qe.rightControl:e.keyCode===qe.alt&&"AltRight"===e.code?qe.rightAlt:e.keyCode}isKeyCodeBrowserKey(e){return e>=112&&e<=123||9===e}}class je{constructor(e,t,s){this.x=0,this.y=0,this.updateMouseMovePositionEvent=e=>{this.updateMouseMovePosition(e)},this.mouseEventListenerTracker=new Ke,this.videoElementProvider=e,this.mouseController=t,this.activeKeysProvider=s;const n=this.videoElementProvider.getVideoParentElement();this.x=n.getBoundingClientRect().width/2,this.y=n.getBoundingClientRect().height/2,this.coord=this.mouseController.coordinateConverter.normalizeAndQuantizeUnsigned(this.x,this.y)}unregisterMouseEvents(){this.mouseEventListenerTracker.unregisterAll()}lockStateChange(){const e=this.videoElementProvider.getVideoParentElement(),t=this.mouseController.toStreamerMessagesProvider.toStreamerHandlers;if(document.pointerLockElement===e||document.mozPointerLockElement===e)i.Log(i.GetStackTrace(),"Pointer locked",6),document.addEventListener("mousemove",this.updateMouseMovePositionEvent,!1),this.mouseEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("mousemove",this.updateMouseMovePositionEvent,!1)));else{i.Log(i.GetStackTrace(),"The pointer lock status is now unlocked",6),document.removeEventListener("mousemove",this.updateMouseMovePositionEvent,!1);let e=this.activeKeysProvider.getActiveKeys();const s=[];new Set(e).forEach((e=>{})),s.forEach((e=>{t.get("KeyUp")([e])})),e=[]}}updateMouseMovePosition(e){if(!this.videoElementProvider.isVideoReady())return;const t=this.mouseController.toStreamerMessagesProvider.toStreamerHandlers,s=this.videoElementProvider.getVideoParentElement().clientWidth,n=this.videoElementProvider.getVideoParentElement().clientHeight;this.x+=e.movementX,this.y+=e.movementY,this.x>s&&(this.x-=s),this.y>n&&(this.y-=n),this.x<0&&(this.x=s+this.x),this.y<0&&(this.y=n-this.y),this.coord=this.mouseController.coordinateConverter.normalizeAndQuantizeUnsigned(this.x,this.y);const r=this.mouseController.coordinateConverter.normalizeAndQuantizeSigned(e.movementX,e.movementY);t.get("MouseMove")([this.coord.x,this.coord.y,r.x,r.y])}handleMouseDown(e){this.videoElementProvider.isVideoReady()&&this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseDown")([e.button,this.coord.x,this.coord.y])}handleMouseUp(e){this.videoElementProvider.isVideoReady()&&this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseUp")([e.button,this.coord.x,this.coord.y])}handleMouseWheel(e){this.videoElementProvider.isVideoReady()&&this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseWheel")([e.wheelDelta,this.coord.x,this.coord.y])}handleMouseDouble(e){this.videoElementProvider.isVideoReady()&&this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseDouble")([e.button,this.coord.x,this.coord.y])}handlePressMouseButtons(e){this.videoElementProvider.isVideoReady()&&this.mouseController.pressMouseButtons(e.buttons,this.x,this.y)}handleReleaseMouseButtons(e){this.videoElementProvider.isVideoReady()&&this.mouseController.releaseMouseButtons(e.buttons,this.x,this.y)}}class Ye{constructor(e){this.mouseController=e}unregisterMouseEvents(){}updateMouseMovePosition(e){if(!this.mouseController.videoElementProvider.isVideoReady())return;i.Log(i.GetStackTrace(),"MouseMove",6);const t=this.mouseController.coordinateConverter.normalizeAndQuantizeUnsigned(e.offsetX,e.offsetY),s=this.mouseController.coordinateConverter.normalizeAndQuantizeSigned(e.movementX,e.movementY);this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseMove")([t.x,t.y,s.x,s.y]),e.preventDefault()}handleMouseDown(e){if(!this.mouseController.videoElementProvider.isVideoReady())return;i.Log(i.GetStackTrace(),"onMouse Down",6);const t=this.mouseController.coordinateConverter.normalizeAndQuantizeUnsigned(e.offsetX,e.offsetY);this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseDown")([e.button,t.x,t.y]),e.preventDefault()}handleMouseUp(e){if(!this.mouseController.videoElementProvider.isVideoReady())return;i.Log(i.GetStackTrace(),"onMouse Up",6);const t=this.mouseController.coordinateConverter.normalizeAndQuantizeUnsigned(e.offsetX,e.offsetY);this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseUp")([e.button,t.x,t.y]),e.preventDefault()}handleContextMenu(e){this.mouseController.videoElementProvider.isVideoReady()&&e.preventDefault()}handleMouseWheel(e){if(!this.mouseController.videoElementProvider.isVideoReady())return;const t=this.mouseController.coordinateConverter.normalizeAndQuantizeUnsigned(e.offsetX,e.offsetY);this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseWheel")([e.wheelDelta,t.x,t.y]),e.preventDefault()}handleMouseDouble(e){if(!this.mouseController.videoElementProvider.isVideoReady())return;const t=this.mouseController.coordinateConverter.normalizeAndQuantizeUnsigned(e.offsetX,e.offsetY);this.mouseController.toStreamerMessagesProvider.toStreamerHandlers.get("MouseDouble")([e.button,t.x,t.y])}handlePressMouseButtons(e){this.mouseController.videoElementProvider.isVideoReady()&&(i.Log(i.GetStackTrace(),"onMouse press",6),this.mouseController.pressMouseButtons(e.buttons,e.offsetX,e.offsetY))}handleReleaseMouseButtons(e){this.mouseController.videoElementProvider.isVideoReady()&&(i.Log(i.GetStackTrace(),"onMouse release",6),this.mouseController.releaseMouseButtons(e.buttons,e.offsetX,e.offsetY))}}class Je{constructor(e,t,s,n){this.mouseEventListenerTracker=new Ke,this.toStreamerMessagesProvider=e,this.coordinateConverter=s,this.videoElementProvider=t,this.activeKeysProvider=n,this.registerMouseEnterAndLeaveEvents()}unregisterMouseEvents(){this.mouseEventListenerTracker.unregisterAll()}registerLockedMouseEvents(e){const t=this.videoElementProvider.getVideoParentElement(),s=new je(this.videoElementProvider,e,this.activeKeysProvider);if(t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,t.requestPointerLock){const e=()=>{t.requestPointerLock()};t.addEventListener("click",e),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("click",e)))}const n=()=>s.lockStateChange();document.addEventListener("pointerlockchange",n,!1),document.addEventListener("mozpointerlockchange",n,!1),this.mouseEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("pointerlockchange",n,!1))),this.mouseEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("mozpointerlockchange",n,!1)));const r=e=>s.handleMouseDown(e),de=e=>s.handleMouseUp(e),he=e=>s.handleMouseWheel(e),ue=e=>s.handleMouseDouble(e);t.addEventListener("mousedown",r),t.addEventListener("mouseup",de),t.addEventListener("wheel",he),t.addEventListener("dblclick",ue),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("mousedown",r))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("mouseup",de))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("wheel",he))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("dblclick",ue))),this.mouseEventListenerTracker.addUnregisterCallback((()=>s.unregisterMouseEvents())),this.mouseEventListenerTracker.addUnregisterCallback((()=>{!document.exitPointerLock||document.pointerLockElement!==t&&document.mozPointerLockElement!==t||document.exitPointerLock()}))}registerHoveringMouseEvents(e){const t=this.videoElementProvider.getVideoParentElement(),s=new Ye(e),n=e=>s.updateMouseMovePosition(e),r=e=>s.handleMouseDown(e),de=e=>s.handleMouseUp(e),he=e=>s.handleContextMenu(e),ue=e=>s.handleMouseWheel(e),pe=e=>s.handleMouseDouble(e);t.addEventListener("mousemove",n),t.addEventListener("mousedown",r),t.addEventListener("mouseup",de),t.addEventListener("contextmenu",he),t.addEventListener("wheel",ue),t.addEventListener("dblclick",pe),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("mousemove",n))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("mousedown",r))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("mouseup",de))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("contextmenu",he))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("wheel",ue))),this.mouseEventListenerTracker.addUnregisterCallback((()=>t.removeEventListener("dblclick",pe))),this.mouseEventListenerTracker.addUnregisterCallback((()=>s.unregisterMouseEvents()))}registerMouseEnterAndLeaveEvents(){const e=this.videoElementProvider.getVideoParentElement(),t=e=>{this.videoElementProvider.isVideoReady()&&(i.Log(i.GetStackTrace(),"Mouse Entered",6),this.sendMouseEnter(),this.pressMouseButtons(e.buttons,e.x,e.y))},s=e=>{this.videoElementProvider.isVideoReady()&&(i.Log(i.GetStackTrace(),"Mouse Left",6),this.sendMouseLeave(),this.releaseMouseButtons(e.buttons,e.x,e.y))};e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",s),this.mouseEventListenerTracker.addUnregisterCallback((()=>e.removeEventListener("mouseenter",t))),this.mouseEventListenerTracker.addUnregisterCallback((()=>e.removeEventListener("mouseleave",s)))}releaseMouseButtons(e,t,s){const n=this.coordinateConverter.normalizeAndQuantizeUnsigned(t,s);e&Ne.primaryButton&&this.sendMouseUp(Ve.mainButton,n.x,n.y),e&Ne.secondaryButton&&this.sendMouseUp(Ve.secondaryButton,n.x,n.y),e&Ne.auxiliaryButton&&this.sendMouseUp(Ve.auxiliaryButton,n.x,n.y),e&Ne.fourthButton&&this.sendMouseUp(Ve.fourthButton,n.x,n.y),e&Ne.fifthButton&&this.sendMouseUp(Ve.fifthButton,n.x,n.y)}pressMouseButtons(e,t,s){if(!this.videoElementProvider.isVideoReady())return;const n=this.coordinateConverter.normalizeAndQuantizeUnsigned(t,s);e&Ne.primaryButton&&this.sendMouseDown(Ve.mainButton,n.x,n.y),e&Ne.secondaryButton&&this.sendMouseDown(Ve.secondaryButton,n.x,n.y),e&Ne.auxiliaryButton&&this.sendMouseDown(Ve.auxiliaryButton,n.x,n.y),e&Ne.fourthButton&&this.sendMouseDown(Ve.fourthButton,n.x,n.y),e&Ne.fifthButton&&this.sendMouseDown(Ve.fifthButton,n.x,n.y)}sendMouseEnter(){this.videoElementProvider.isVideoReady()&&this.toStreamerMessagesProvider.toStreamerHandlers.get("MouseEnter")()}sendMouseLeave(){this.videoElementProvider.isVideoReady()&&this.toStreamerMessagesProvider.toStreamerHandlers.get("MouseLeave")()}sendMouseDown(e,t,s){this.videoElementProvider.isVideoReady()&&(i.Log(i.GetStackTrace(),`mouse button ${e} down at (${t}, ${s})`,6),this.toStreamerMessagesProvider.toStreamerHandlers.get("MouseDown")([e,t,s]))}sendMouseUp(e,t,s){if(!this.videoElementProvider.isVideoReady())return;i.Log(i.GetStackTrace(),`mouse button ${e} up at (${t}, ${s})`,6);const n=this.coordinateConverter.normalizeAndQuantizeUnsigned(t,s);this.toStreamerMessagesProvider.toStreamerHandlers.get("MouseUp")([e,n.x,n.y])}}class Ze{constructor(e,t,s){this.fingers=[9,8,7,6,5,4,3,2,1,0],this.fingerIds=new Map,this.maxByteValue=255,this.touchEventListenerTracker=new Ke,this.toStreamerMessagesProvider=e,this.videoElementProvider=t,this.coordinateConverter=s,this.videoElementParent=t.getVideoElement();const n=e=>this.onTouchStart(e),r=e=>this.onTouchEnd(e),de=e=>this.onTouchMove(e);this.videoElementParent.addEventListener("touchstart",n,{passive:!1}),this.videoElementParent.addEventListener("touchend",r,{passive:!1}),this.videoElementParent.addEventListener("touchmove",de,{passive:!1}),this.touchEventListenerTracker.addUnregisterCallback((()=>this.videoElementParent.removeEventListener("touchstart",n))),this.touchEventListenerTracker.addUnregisterCallback((()=>this.videoElementParent.removeEventListener("touchend",r))),this.touchEventListenerTracker.addUnregisterCallback((()=>this.videoElementParent.removeEventListener("touchmove",de))),i.Log(i.GetStackTrace(),"Touch Events Registered",6);const he=e=>{e.preventDefault()};document.addEventListener("touchmove",he,{passive:!1}),this.touchEventListenerTracker.addUnregisterCallback((()=>document.removeEventListener("touchmove",he)))}unregisterTouchEvents(){this.touchEventListenerTracker.unregisterAll()}rememberTouch(e){const t=this.fingers.pop();void 0===t&&i.Log(i.GetStackTrace(),"exhausted touch identifiers",6),this.fingerIds.set(e.identifier,t)}forgetTouch(e){this.fingers.push(this.fingerIds.get(e.identifier)),this.fingers.sort((function(e,t){return t-e})),this.fingerIds.delete(e.identifier)}onTouchStart(e){if(this.videoElementProvider.isVideoReady()){for(let t=0;t<e.changedTouches.length;t++)this.rememberTouch(e.changedTouches[t]);i.Log(i.GetStackTrace(),"touch start",6),this.emitTouchData("TouchStart",e.changedTouches),e.preventDefault()}}onTouchEnd(e){if(this.videoElementProvider.isVideoReady()){i.Log(i.GetStackTrace(),"touch end",6),this.emitTouchData("TouchEnd",e.changedTouches);for(let t=0;t<e.changedTouches.length;t++)this.forgetTouch(e.changedTouches[t]);e.preventDefault()}}onTouchMove(e){this.videoElementProvider.isVideoReady()&&(i.Log(i.GetStackTrace(),"touch move",6),this.emitTouchData("TouchMove",e.touches),e.preventDefault())}emitTouchData(e,t){if(!this.videoElementProvider.isVideoReady())return;const s=this.videoElementProvider.getVideoParentElement().getBoundingClientRect(),n=this.toStreamerMessagesProvider.toStreamerHandlers;for(let r=0;r<t.length;r++){const de=1,he=t[r],ue=he.clientX-s.left,pe=he.clientY-s.top;i.Log(i.GetStackTrace(),`F${this.fingerIds.get(he.identifier)}=(${ue}, ${pe})`,6);const ve=this.coordinateConverter.normalizeAndQuantizeUnsigned(ue,pe);switch(e){case"TouchStart":n.get("TouchStart")([de,ve.x,ve.y,this.fingerIds.get(he.identifier),this.maxByteValue*he.force,ve.inRange?1:0]);break;case"TouchEnd":n.get("TouchEnd")([de,ve.x,ve.y,this.fingerIds.get(he.identifier),this.maxByteValue*he.force,ve.inRange?1:0]);break;case"TouchMove":n.get("TouchMove")([de,ve.x,ve.y,this.fingerIds.get(he.identifier),this.maxByteValue*he.force,ve.inRange?1:0])}}}}class et{constructor(e){this.gamePadEventListenerTracker=new Ke,this.toStreamerMessagesProvider=e,this.requestAnimationFrame=(window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.requestAnimationFrame).bind(window);const t=window;if("GamepadEvent"in t){const e=e=>this.gamePadConnectHandler(e),t=e=>this.gamePadDisconnectHandler(e);window.addEventListener("gamepadconnected",e),window.addEventListener("gamepaddisconnected",t),this.gamePadEventListenerTracker.addUnregisterCallback((()=>window.removeEventListener("gamepadconnected",e))),this.gamePadEventListenerTracker.addUnregisterCallback((()=>window.removeEventListener("gamepaddisconnected",t)))}else if("WebKitGamepadEvent"in t){const e=e=>this.gamePadConnectHandler(e),t=e=>this.gamePadDisconnectHandler(e);window.addEventListener("webkitgamepadconnected",e),window.addEventListener("webkitgamepaddisconnected",t),this.gamePadEventListenerTracker.addUnregisterCallback((()=>window.removeEventListener("webkitgamepadconnected",e))),this.gamePadEventListenerTracker.addUnregisterCallback((()=>window.removeEventListener("webkitgamepaddisconnected",t)))}if(this.controllers=[],navigator.getGamepads)for(const s of navigator.getGamepads())s&&this.gamePadConnectHandler(new GamepadEvent("gamepadconnected",{gamepad:s}))}unregisterGamePadEvents(){this.gamePadEventListenerTracker.unregisterAll();for(const e of this.controllers)void 0!==e.id&&this.onGamepadDisconnected(e.id);this.controllers=[],this.onGamepadConnected=()=>{},this.onGamepadDisconnected=()=>{}}gamePadConnectHandler(e){i.Log(i.GetStackTrace(),"Gamepad connect handler",6);const t=e.gamepad,s={currentState:t,prevState:t,id:void 0};this.controllers.push(s),this.controllers[t.index].currentState=t,this.controllers[t.index].prevState=t,i.Log(i.GetStackTrace(),"gamepad: "+t.id+" connected",6),window.requestAnimationFrame((()=>this.updateStatus())),this.onGamepadConnected()}gamePadDisconnectHandler(e){i.Log(i.GetStackTrace(),"Gamepad disconnect handler",6),i.Log(i.GetStackTrace(),"gamepad: "+e.gamepad.id+" disconnected",6);const t=this.controllers[e.gamepad.index];delete this.controllers[e.gamepad.index],this.controllers=this.controllers.filter((e=>void 0!==e)),this.onGamepadDisconnected(t.id)}scanGamePads(){const e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let t=0;t<e.length;t++)e[t]&&e[t].index in this.controllers&&(this.controllers[e[t].index].currentState=e[t])}updateStatus(){this.scanGamePads();const e=this.toStreamerMessagesProvider.toStreamerHandlers;for(const t of this.controllers){const s=void 0===t.id?this.controllers.indexOf(t):t.id,n=t.currentState;for(let r=0;r<t.currentState.buttons.length;r++){const n=t.currentState.buttons[r],de=t.prevState.buttons[r];n.pressed?r==Pt.LeftTrigger?e.get("GamepadAnalog")([s,5,n.value]):r==Pt.RightTrigger?e.get("GamepadAnalog")([s,6,n.value]):e.get("GamepadButtonPressed")([s,r,de.pressed?1:0]):!n.pressed&&de.pressed&&(r==Pt.LeftTrigger?e.get("GamepadAnalog")([s,5,0]):r==Pt.RightTrigger?e.get("GamepadAnalog")([s,6,0]):e.get("GamepadButtonReleased")([s,r]))}for(let t=0;t<n.axes.length;t+=2){const r=parseFloat(n.axes[t].toFixed(4)),de=-parseFloat(n.axes[t+1].toFixed(4));e.get("GamepadAnalog")([s,t+1,r]),e.get("GamepadAnalog")([s,t+2,de])}this.controllers[s].prevState=n}this.controllers.length>0&&this.requestAnimationFrame((()=>this.updateStatus()))}onGamepadResponseReceived(e){for(const t of this.controllers)if(void 0===t.id){t.id=e;break}}onGamepadConnected(){}onGamepadDisconnected(e){}}!function(e){e[e.RightClusterBottomButton=0]="RightClusterBottomButton",e[e.RightClusterRightButton=1]="RightClusterRightButton",e[e.RightClusterLeftButton=2]="RightClusterLeftButton",e[e.RightClusterTopButton=3]="RightClusterTopButton",e[e.LeftShoulder=4]="LeftShoulder",e[e.RightShoulder=5]="RightShoulder",e[e.LeftTrigger=6]="LeftTrigger",e[e.RightTrigger=7]="RightTrigger",e[e.SelectOrBack=8]="SelectOrBack",e[e.StartOrForward=9]="StartOrForward",e[e.LeftAnalogPress=10]="LeftAnalogPress",e[e.RightAnalogPress=11]="RightAnalogPress",e[e.LeftClusterTopButton=12]="LeftClusterTopButton",e[e.LeftClusterBottomButton=13]="LeftClusterBottomButton",e[e.LeftClusterLeftButton=14]="LeftClusterLeftButton",e[e.LeftClusterRightButton=15]="LeftClusterRightButton",e[e.CentreButton=16]="CentreButton",e[e.LeftStickHorizontal=0]="LeftStickHorizontal",e[e.LeftStickVertical=1]="LeftStickVertical",e[e.RightStickHorizontal=2]="RightStickHorizontal",e[e.RightStickVertical=3]="RightStickVertical"}(Pt||(Pt={}));class tt{constructor(e,t,s){this.activeKeys=new st,this.toStreamerMessagesProvider=e,this.videoElementProvider=t,this.coordinateConverter=s}registerKeyBoard(e){i.Log(i.GetStackTrace(),"Register Keyboard Events",7);const t=new Xe(this.toStreamerMessagesProvider,e,this.activeKeys);return t.registerKeyBoardEvents(),t}registerMouse(e){i.Log(i.GetStackTrace(),"Register Mouse Events",7);const t=new Je(this.toStreamerMessagesProvider,this.videoElementProvider,this.coordinateConverter,this.activeKeys);switch(e){case De.LockedMouse:t.registerLockedMouseEvents(t);break;case De.HoveringMouse:t.registerHoveringMouseEvents(t);break;default:i.Info(i.GetStackTrace(),"unknown Control Scheme Type Defaulting to Locked Mouse Events"),t.registerLockedMouseEvents(t)}return t}registerTouch(e,t){if(i.Log(i.GetStackTrace(),"Registering Touch",6),e){const e=new Qe(this.toStreamerMessagesProvider,this.videoElementProvider,this.coordinateConverter);return e.setVideoElementParentClientRect(t),e}return new Ze(this.toStreamerMessagesProvider,this.videoElementProvider,this.coordinateConverter)}registerGamePad(){return i.Log(i.GetStackTrace(),"Register Game Pad",7),new et(this.toStreamerMessagesProvider)}}class st{constructor(){this.activeKeys=[],this.activeKeys=[]}getActiveKeys(){return this.activeKeys}}class nt{constructor(e,t){this.lastTimeResized=(new Date).getTime(),this.videoElement=document.createElement("video"),this.config=t,this.videoElement.id="streamingVideo",this.videoElement.disablePictureInPicture=!0,this.videoElement.playsInline=!0,this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.pointerEvents="all",e.appendChild(this.videoElement),this.onResizePlayerCallback=()=>{console.log("Resolution changed, restyling player, did you forget to override this function?")},this.onMatchViewportResolutionCallback=()=>{console.log("Resolution changed and match viewport resolution is turned on, did you forget to override this function?")},this.videoElement.onclick=()=>{null!=this.audioElement&&this.audioElement.paused&&this.audioElement.play(),this.videoElement.paused&&this.videoElement.play()},this.videoElement.onloadedmetadata=()=>{this.onVideoInitialized()},window.addEventListener("resize",(()=>this.resizePlayerStyle()),!0),window.addEventListener("orientationchange",(()=>this.onOrientationChange()))}setAudioElement(e){this.audioElement=e}play(){return this.videoElement.muted=this.config.isFlagEnabled(le.StartVideoMuted),this.videoElement.autoplay=this.config.isFlagEnabled(le.AutoPlayVideo),this.videoElement.play()}isPaused(){return this.videoElement.paused}isVideoReady(){return void 0!==this.videoElement.readyState&&this.videoElement.readyState>0}hasVideoSource(){return void 0!==this.videoElement.srcObject&&null!==this.videoElement.srcObject}getVideoElement(){return this.videoElement}getVideoParentElement(){return this.videoElement.parentElement}setVideoEnabled(e){this.videoElement.srcObject.getTracks().forEach((t=>t.enabled=e))}onVideoInitialized(){}onOrientationChange(){clearTimeout(this.orientationChangeTimeout),this.orientationChangeTimeout=window.setTimeout((()=>{this.resizePlayerStyle()}),500)}resizePlayerStyle(){const e=this.getVideoParentElement();e&&(this.updateVideoStreamSize(),e.classList.contains("fixed-size")||this.resizePlayerStyleToFillParentElement(),this.onResizePlayerCallback())}resizePlayerStyleToFillParentElement(){this.getVideoParentElement().setAttribute("style","top: 0px; left: 0px; width: 100%; height: 100%; cursor: default;")}updateVideoStreamSize(){if(this.config.isFlagEnabled(le.MatchViewportResolution))if((new Date).getTime()-this.lastTimeResized>300){const e=this.getVideoParentElement();if(!e)return;this.onMatchViewportResolutionCallback(e.clientWidth,e.clientHeight),this.lastTimeResized=(new Date).getTime()}else i.Log(i.GetStackTrace(),"Resizing too often - skipping",6),clearTimeout(this.resizeTimeoutHandle),this.resizeTimeoutHandle=window.setTimeout((()=>this.updateVideoStreamSize()),100)}}class rt{constructor(){this.map=new Map,this.reverseMap=new Map}getFromKey(e){return this.map.get(e)}getFromValue(e){return this.reverseMap.get(e)}add(e,t){this.map.set(e,t),this.reverseMap.set(t,e)}remove(e,t){this.map.delete(e),this.reverseMap.delete(t)}}class it{constructor(){this.toStreamerHandlers=new Map,this.fromStreamerHandlers=new Map,this.toStreamerMessages=new rt,this.fromStreamerMessages=new rt}populateDefaultProtocol(){this.toStreamerMessages.add("IFrameRequest",{id:0,byteLength:0,structure:[]}),this.toStreamerMessages.add("RequestQualityControl",{id:1,byteLength:0,structure:[]}),this.toStreamerMessages.add("FpsRequest",{id:2,byteLength:0,structure:[]}),this.toStreamerMessages.add("AverageBitrateRequest",{id:3,byteLength:0,structure:[]}),this.toStreamerMessages.add("StartStreaming",{id:4,byteLength:0,structure:[]}),this.toStreamerMessages.add("StopStreaming",{id:5,byteLength:0,structure:[]}),this.toStreamerMessages.add("LatencyTest",{id:6,byteLength:0,structure:[]}),this.toStreamerMessages.add("RequestInitialSettings",{id:7,byteLength:0,structure:[]}),this.toStreamerMessages.add("TestEcho",{id:8,byteLength:0,structure:[]}),this.toStreamerMessages.add("UIInteraction",{id:50,byteLength:0,structure:[]}),this.toStreamerMessages.add("Command",{id:51,byteLength:0,structure:[]}),this.toStreamerMessages.add("KeyDown",{id:60,byteLength:2,structure:["uint8","uint8"]}),this.toStreamerMessages.add("KeyUp",{id:61,byteLength:1,structure:["uint8"]}),this.toStreamerMessages.add("KeyPress",{id:62,byteLength:2,structure:["uint16"]}),this.toStreamerMessages.add("MouseEnter",{id:70,byteLength:0,structure:[]}),this.toStreamerMessages.add("MouseLeave",{id:71,byteLength:0,structure:[]}),this.toStreamerMessages.add("MouseDown",{id:72,byteLength:5,structure:["uint8","uint16","uint16"]}),this.toStreamerMessages.add("MouseUp",{id:73,byteLength:5,structure:["uint8","uint16","uint16"]}),this.toStreamerMessages.add("MouseMove",{id:74,byteLength:8,structure:["uint16","uint16","int16","int16"]}),this.toStreamerMessages.add("MouseWheel",{id:75,byteLength:6,structure:["int16","uint16","uint16"]}),this.toStreamerMessages.add("MouseDouble",{id:76,byteLength:5,structure:["uint8","uint16","uint16"]}),this.toStreamerMessages.add("TouchStart",{id:80,byteLength:8,structure:["uint8","uint16","uint16","uint8","uint8","uint8"]}),this.toStreamerMessages.add("TouchEnd",{id:81,byteLength:8,structure:["uint8","uint16","uint16","uint8","uint8","uint8"]}),this.toStreamerMessages.add("TouchMove",{id:82,byteLength:8,structure:["uint8","uint16","uint16","uint8","uint8","uint8"]}),this.toStreamerMessages.add("GamepadConnected",{id:93,byteLength:0,structure:[]}),this.toStreamerMessages.add("GamepadButtonPressed",{id:90,byteLength:3,structure:["uint8","uint8","uint8"]}),this.toStreamerMessages.add("GamepadButtonReleased",{id:91,byteLength:3,structure:["uint8","uint8","uint8"]}),this.toStreamerMessages.add("GamepadAnalog",{id:92,byteLength:10,structure:["uint8","uint8","double"]}),this.toStreamerMessages.add("GamepadDisconnected",{id:94,byteLength:1,structure:["uint8"]}),this.fromStreamerMessages.add("QualityControlOwnership",0),this.fromStreamerMessages.add("Response",1),this.fromStreamerMessages.add("Command",2),this.fromStreamerMessages.add("FreezeFrame",3),this.fromStreamerMessages.add("UnfreezeFrame",4),this.fromStreamerMessages.add("VideoEncoderAvgQP",5),this.fromStreamerMessages.add("LatencyTest",6),this.fromStreamerMessages.add("InitialSettings",7),this.fromStreamerMessages.add("FileExtension",8),this.fromStreamerMessages.add("FileMimeType",9),this.fromStreamerMessages.add("FileContents",10),this.fromStreamerMessages.add("TestEcho",11),this.fromStreamerMessages.add("InputControlOwnership",12),this.fromStreamerMessages.add("GamepadResponse",13),this.fromStreamerMessages.add("Protocol",255)}registerMessageHandler(e,t,s){switch(e){case wt.ToStreamer:this.toStreamerHandlers.set(t,s);break;case wt.FromStreamer:this.fromStreamerHandlers.set(t,s);break;default:i.Log(i.GetStackTrace(),`Unknown message direction ${e}`)}}}!function(e){e[e.ToStreamer=0]="ToStreamer",e[e.FromStreamer=1]="FromStreamer"}(wt||(wt={}));class ot{constructor(){this.responseEventListeners=new Map}addResponseEventListener(e,t){this.responseEventListeners.set(e,t)}removeResponseEventListener(e){this.responseEventListeners.delete(e)}onResponse(e){i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.Response",6);const t=new TextDecoder("utf-16").decode(e.slice(1));i.Log(i.GetStackTrace(),t,6),this.responseEventListeners.forEach((e=>{e(t)}))}}let Rt=class at{constructor(e,t){this.dataChannelSender=e,this.toStreamerMessagesMapProvider=t}sendLatencyTest(e){this.sendDescriptor("LatencyTest",e)}emitCommand(e){this.sendDescriptor("Command",e)}emitUIInteraction(e){this.sendDescriptor("UIInteraction",e)}sendDescriptor(e,t){const s=JSON.stringify(t),n=this.toStreamerMessagesMapProvider.toStreamerMessages.getFromKey(e);void 0===n&&i.Error(i.GetStackTrace(),`Attempted to emit descriptor with message type: ${e}, but the frontend hasn't been configured to send such a message. Check you've added the message type in your cpp`),i.Log(i.GetStackTrace(),"Sending: "+t,6);const r=new DataView(new ArrayBuffer(3+2*s.length));let de=0;r.setUint8(de,n.id),de++,r.setUint16(de,s.length,!0),de+=2;for(let he=0;he<s.length;he++)r.setUint16(de,s.charCodeAt(he),!0),de+=2;this.dataChannelSender.canSend()?this.dataChannelSender.sendData(r.buffer):i.Info(i.GetStackTrace(),`Data channel cannot send yet, skipping sending descriptor message: ${e} - ${s}`)}};class lt{constructor(e,t){this.dataChannelSender=e,this.toStreamerMessagesMapProvider=t}sendMessageToStreamer(e,t){void 0===t&&(t=[]);const s=this.toStreamerMessagesMapProvider.toStreamerMessages.getFromKey(e);if(void 0===s)return void i.Error(i.GetStackTrace(),`Attempted to send a message to the streamer with message type: ${e}, but the frontend hasn't been configured to send such a message. Check you've added the message type in your cpp`);const n=new DataView(new ArrayBuffer(s.byteLength+1));n.setUint8(0,s.id);let r=1;t.forEach(((e,t)=>{switch(s.structure[t]){case"uint8":n.setUint8(r,e),r+=1;break;case"uint16":n.setUint16(r,e,!0),r+=2;break;case"int16":n.setInt16(r,e,!0),r+=2;break;case"float":n.setFloat32(r,e,!0),r+=4;break;case"double":n.setFloat64(r,e,!0),r+=8}})),this.dataChannelSender.canSend()?this.dataChannelSender.sendData(n.buffer):i.Info(i.GetStackTrace(),`Data channel cannot send yet, skipping sending message: ${e} - ${new Uint8Array(n.buffer)}`)}}class dt{constructor(e){this.sendMessageController=e}SendRequestQualityControl(){this.sendMessageController.sendMessageToStreamer("RequestQualityControl")}SendMaxFpsRequest(){this.sendMessageController.sendMessageToStreamer("FpsRequest")}SendAverageBitrateRequest(){this.sendMessageController.sendMessageToStreamer("AverageBitrateRequest")}SendStartStreaming(){this.sendMessageController.sendMessageToStreamer("StartStreaming")}SendStopStreaming(){this.sendMessageController.sendMessageToStreamer("StopStreaming")}SendRequestInitialSettings(){this.sendMessageController.sendMessageToStreamer("RequestInitialSettings")}}class ct{constructor(e){this.dataChannelProvider=e}canSend(){return void 0!==this.dataChannelProvider.getDataChannelInstance().dataChannel&&"open"==this.dataChannelProvider.getDataChannelInstance().dataChannel.readyState}sendData(e){const t=this.dataChannelProvider.getDataChannelInstance();"open"==t.dataChannel.readyState?(t.dataChannel.send(e),i.Log(i.GetStackTrace(),`Message Sent: ${new Uint8Array(e)}`,6),this.resetAfkWarningTimerOnDataSend()):i.Error(i.GetStackTrace(),`Message Failed: ${new Uint8Array(e)}`)}resetAfkWarningTimerOnDataSend(){}}class ht{constructor(e){this.videoElementProvider=e,this.normalizeAndQuantizeUnsignedFunc=()=>{throw new Error("Normalize and quantize unsigned, method not implemented.")},this.normalizeAndQuantizeSignedFunc=()=>{throw new Error("Normalize and unquantize signed, method not implemented.")},this.denormalizeAndUnquantizeUnsignedFunc=()=>{throw new Error("Denormalize and unquantize unsigned, method not implemented.")}}normalizeAndQuantizeUnsigned(e,t){return this.normalizeAndQuantizeUnsignedFunc(e,t)}unquantizeAndDenormalizeUnsigned(e,t){return this.denormalizeAndUnquantizeUnsignedFunc(e,t)}normalizeAndQuantizeSigned(e,t){return this.normalizeAndQuantizeSignedFunc(e,t)}setupNormalizeAndQuantize(){if(this.videoElementParent=this.videoElementProvider.getVideoParentElement(),this.videoElement=this.videoElementProvider.getVideoElement(),this.videoElementParent&&this.videoElement){const e=this.videoElementParent.clientHeight/this.videoElementParent.clientWidth,t=this.videoElement.videoHeight/this.videoElement.videoWidth;e>t?(i.Log(i.GetStackTrace(),"Setup Normalize and Quantize for playerAspectRatio > videoAspectRatio",6),this.ratio=e/t,this.normalizeAndQuantizeUnsignedFunc=(e,t)=>this.normalizeAndQuantizeUnsignedPlayerBigger(e,t),this.normalizeAndQuantizeSignedFunc=(e,t)=>this.normalizeAndQuantizeSignedPlayerBigger(e,t),this.denormalizeAndUnquantizeUnsignedFunc=(e,t)=>this.denormalizeAndUnquantizeUnsignedPlayerBigger(e,t)):(i.Log(i.GetStackTrace(),"Setup Normalize and Quantize for playerAspectRatio <= videoAspectRatio",6),this.ratio=t/e,this.normalizeAndQuantizeUnsignedFunc=(e,t)=>this.normalizeAndQuantizeUnsignedPlayerSmaller(e,t),this.normalizeAndQuantizeSignedFunc=(e,t)=>this.normalizeAndQuantizeSignedPlayerSmaller(e,t),this.denormalizeAndUnquantizeUnsignedFunc=(e,t)=>this.denormalizeAndUnquantizeUnsignedPlayerSmaller(e,t))}}normalizeAndQuantizeUnsignedPlayerBigger(e,t){const s=e/this.videoElementParent.clientWidth,n=this.ratio*(t/this.videoElementParent.clientHeight-.5)+.5;return s<0||s>1||n<0||n>1?new gt(!1,65535,65535):new gt(!0,65536*s,65536*n)}denormalizeAndUnquantizeUnsignedPlayerBigger(e,t){const s=e/65536,n=(t/65536-.5)/this.ratio+.5;return new ut(s*this.videoElementParent.clientWidth,n*this.videoElementParent.clientHeight)}normalizeAndQuantizeSignedPlayerBigger(e,t){const s=e/(.5*this.videoElementParent.clientWidth),n=this.ratio*t/(.5*this.videoElementParent.clientHeight);return new mt(32767*s,32767*n)}normalizeAndQuantizeUnsignedPlayerSmaller(e,t){const s=this.ratio*(e/this.videoElementParent.clientWidth-.5)+.5,n=t/this.videoElementParent.clientHeight;return s<0||s>1||n<0||n>1?new gt(!1,65535,65535):new gt(!0,65536*s,65536*n)}denormalizeAndUnquantizeUnsignedPlayerSmaller(e,t){const s=(e/65536-.5)/this.ratio+.5,n=t/65536;return new ut(s*this.videoElementParent.clientWidth,n*this.videoElementParent.clientHeight)}normalizeAndQuantizeSignedPlayerSmaller(e,t){const s=this.ratio*e/(.5*this.videoElementParent.clientWidth),n=t/(.5*this.videoElementParent.clientHeight);return new mt(32767*s,32767*n)}}class gt{constructor(e,t,s){this.inRange=e,this.x=t,this.y=s}}class ut{constructor(e,t){this.x=e,this.y=t}}class mt{constructor(e,t){this.x=e,this.y=t}}class pt{constructor(e,t){this.shouldShowPlayOverlay=!0,this.config=e,this.pixelStreaming=t,this.responseController=new ot,this.file=new He,this.sdpConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!0},this.afkController=new Ce(this.config,this.pixelStreaming,this.onAfkTriggered.bind(this)),this.afkController.onAFKTimedOutCallback=()=>{this.setDisconnectMessageOverride("You have been disconnected due to inactivity"),this.closeSignalingServer()},this.freezeFrameController=new y(this.pixelStreaming.videoElementParent),this.videoPlayer=new nt(this.pixelStreaming.videoElementParent,this.config),this.videoPlayer.onVideoInitialized=()=>this.handleVideoInitialized(),this.videoPlayer.onMatchViewportResolutionCallback=(e,t)=>{const s={"Resolution.Width":e,"Resolution.Height":t};this.sendDescriptorController.emitCommand(s)},this.videoPlayer.onResizePlayerCallback=()=>{this.setUpMouseAndFreezeFrame()},this.streamController=new E(this.videoPlayer),this.coordinateConverter=new ht(this.videoPlayer),this.sendrecvDataChannelController=new fe,this.recvDataChannelController=new fe,this.registerDataChannelEventEmitters(this.sendrecvDataChannelController),this.registerDataChannelEventEmitters(this.recvDataChannelController),this.dataChannelSender=new ct(this.sendrecvDataChannelController),this.dataChannelSender.resetAfkWarningTimerOnDataSend=()=>this.afkController.resetAfkWarningTimer(),this.streamMessageController=new it,this.webSocketController=new f,this.webSocketController.onConfig=e=>this.handleOnConfigMessage(e),this.webSocketController.onStreamerList=e=>this.handleStreamerListMessage(e),this.webSocketController.onWebSocketOncloseOverlayMessage=e=>{this.pixelStreaming._onDisconnect(`Websocket disconnect (${e.code}) ${""!=e.reason?"- "+e.reason:""}`),this.setVideoEncoderAvgQP(0)},this.webSocketController.onPlayerCount=e=>{this.pixelStreaming._onPlayerCount(e.count)},this.webSocketController.onOpen.addEventListener("open",(()=>{this.config.isFlagEnabled(le.BrowserSendOffer)||this.webSocketController.requestStreamerList()})),this.webSocketController.onClose.addEventListener("close",(()=>{this.afkController.stopAfkWarningTimer(),this.statsTimerHandle&&void 0!==this.statsTimerHandle&&window.clearInterval(this.statsTimerHandle),this.setTouchInputEnabled(!1),this.setMouseInputEnabled(!1),this.setKeyboardInputEnabled(!1),this.setGamePadInputEnabled(!1),this.shouldReconnect&&this.config.getNumericSettingValue(ce.MaxReconnectAttempts)>0&&(this.isReconnecting=!0,this.reconnectAttempt++,this.restartStreamAutomatically())})),this.sendDescriptorController=new Rt(this.dataChannelSender,this.streamMessageController),this.sendMessageController=new lt(this.dataChannelSender,this.streamMessageController),this.toStreamerMessagesController=new dt(this.sendMessageController),this.registerMessageHandlers(),this.streamMessageController.populateDefaultProtocol(),this.inputClassesFactory=new tt(this.streamMessageController,this.videoPlayer,this.coordinateConverter),this.isUsingSFU=!1,this.isQualityController=!1,this.preferredCodec="",this.shouldReconnect=!0,this.isReconnecting=!1,this.reconnectAttempt=0,this.config._addOnOptionSettingChangedListener(me.StreamerId,(e=>{""!==e&&(this.peerConnectionController.peerConnection.close(),this.peerConnectionController.createPeerConnection(this.peerConfig,this.preferredCodec),this.subscribedStream=e,this.webSocketController.sendSubscribe(e))})),this.setVideoEncoderAvgQP(-1),this.signallingUrlBuilder=()=>{let e=this.config.getTextSettingValue(ge.SignallingServerUrl);return this.config.isFlagEnabled(le.BrowserSendOffer)&&(e+="?"+le.BrowserSendOffer+"=true"),e}}requestUnquantizedAndDenormalizeUnsigned(e,t){return this.coordinateConverter.unquantizeAndDenormalizeUnsigned(e,t)}handleOnMessage(e){const t=new Uint8Array(e.data);i.Log(i.GetStackTrace(),"Message incoming:"+t,6);const s=this.streamMessageController.fromStreamerMessages.getFromValue(t[0]);this.streamMessageController.fromStreamerHandlers.get(s)(e.data)}registerMessageHandlers(){this.streamMessageController.registerMessageHandler(wt.FromStreamer,"QualityControlOwnership",(e=>this.onQualityControlOwnership(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"Response",(e=>this.responseController.onResponse(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"Command",(e=>{this.onCommand(e)})),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"FreezeFrame",(e=>this.onFreezeFrameMessage(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"UnfreezeFrame",(()=>this.invalidateFreezeFrameAndEnableVideo())),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"VideoEncoderAvgQP",(e=>this.handleVideoEncoderAvgQP(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"LatencyTest",(e=>this.handleLatencyTestResult(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"InitialSettings",(e=>this.handleInitialSettings(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"FileExtension",(e=>this.onFileExtension(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"FileMimeType",(e=>this.onFileMimeType(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"FileContents",(e=>this.onFileContents(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"TestEcho",(()=>{})),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"InputControlOwnership",(e=>this.onInputControlOwnership(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"GamepadResponse",(e=>this.onGamepadResponse(e))),this.streamMessageController.registerMessageHandler(wt.FromStreamer,"Protocol",(e=>this.onProtocolMessage(e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"IFrameRequest",(()=>this.sendMessageController.sendMessageToStreamer("IFrameRequest"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"RequestQualityControl",(()=>this.sendMessageController.sendMessageToStreamer("RequestQualityControl"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"FpsRequest",(()=>this.sendMessageController.sendMessageToStreamer("FpsRequest"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"AverageBitrateRequest",(()=>this.sendMessageController.sendMessageToStreamer("AverageBitrateRequest"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"StartStreaming",(()=>this.sendMessageController.sendMessageToStreamer("StartStreaming"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"StopStreaming",(()=>this.sendMessageController.sendMessageToStreamer("StopStreaming"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"LatencyTest",(()=>this.sendMessageController.sendMessageToStreamer("LatencyTest"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"RequestInitialSettings",(()=>this.sendMessageController.sendMessageToStreamer("RequestInitialSettings"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"TestEcho",(()=>{})),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"UIInteraction",(e=>this.sendDescriptorController.emitUIInteraction(e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"Command",(e=>this.sendDescriptorController.emitCommand(e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"KeyDown",(e=>this.sendMessageController.sendMessageToStreamer("KeyDown",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"KeyUp",(e=>this.sendMessageController.sendMessageToStreamer("KeyUp",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"KeyPress",(e=>this.sendMessageController.sendMessageToStreamer("KeyPress",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"MouseEnter",(e=>this.sendMessageController.sendMessageToStreamer("MouseEnter",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"MouseLeave",(e=>this.sendMessageController.sendMessageToStreamer("MouseLeave",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"MouseDown",(e=>this.sendMessageController.sendMessageToStreamer("MouseDown",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"MouseUp",(e=>this.sendMessageController.sendMessageToStreamer("MouseUp",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"MouseMove",(e=>this.sendMessageController.sendMessageToStreamer("MouseMove",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"MouseWheel",(e=>this.sendMessageController.sendMessageToStreamer("MouseWheel",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"MouseDouble",(e=>this.sendMessageController.sendMessageToStreamer("MouseDouble",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"TouchStart",(e=>this.sendMessageController.sendMessageToStreamer("TouchStart",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"TouchEnd",(e=>this.sendMessageController.sendMessageToStreamer("TouchEnd",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"TouchMove",(e=>this.sendMessageController.sendMessageToStreamer("TouchMove",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"GamepadConnected",(()=>this.sendMessageController.sendMessageToStreamer("GamepadConnected"))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"GamepadButtonPressed",(e=>this.sendMessageController.sendMessageToStreamer("GamepadButtonPressed",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"GamepadButtonReleased",(e=>this.sendMessageController.sendMessageToStreamer("GamepadButtonReleased",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"GamepadAnalog",(e=>this.sendMessageController.sendMessageToStreamer("GamepadAnalog",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"GamepadDisconnected",(e=>this.sendMessageController.sendMessageToStreamer("GamepadDisconnected",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"XRHMDTransform",(e=>this.sendMessageController.sendMessageToStreamer("XRHMDTransform",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"XRControllerTransform",(e=>this.sendMessageController.sendMessageToStreamer("XRControllerTransform",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"XRSystem",(e=>this.sendMessageController.sendMessageToStreamer("XRSystem",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"XRButtonTouched",(e=>this.sendMessageController.sendMessageToStreamer("XRButtonTouched",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"XRButtonPressed",(e=>this.sendMessageController.sendMessageToStreamer("XRButtonPressed",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"XRButtonReleased",(e=>this.sendMessageController.sendMessageToStreamer("XRButtonReleased",e))),this.streamMessageController.registerMessageHandler(wt.ToStreamer,"XRAnalog",(e=>this.sendMessageController.sendMessageToStreamer("XRAnalog",e)))}onCommand(e){i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.Command",6);const t=new TextDecoder("utf-16").decode(e.slice(1));i.Log(i.GetStackTrace(),"Data Channel Command: "+t,6);const s=JSON.parse(t);"onScreenKeyboard"===s.command&&this.pixelStreaming._activateOnScreenKeyboard(s)}onProtocolMessage(e){try{const t=new TextDecoder("utf-16").decode(e.slice(1)),s=JSON.parse(t);Object.prototype.hasOwnProperty.call(s,"Direction")||i.Error(i.GetStackTrace(),"Malformed protocol received. Ensure the protocol message contains a direction");const n=s.Direction;delete s.Direction,i.Log(i.GetStackTrace(),`Received new ${n==wt.FromStreamer?"FromStreamer":"ToStreamer"} protocol. Updating existing protocol...`),Object.keys(s).forEach((e=>{const t=s[e];switch(n){case wt.ToStreamer:if(!Object.prototype.hasOwnProperty.call(t,"id")||!Object.prototype.hasOwnProperty.call(t,"byteLength"))return void i.Error(i.GetStackTrace(),`ToStreamer->${e} protocol definition was malformed as it didn't contain at least an id and a byteLength\n\n                                           Definition was: ${JSON.stringify(t,null,2)}`);if(t.byteLength>0&&!Object.prototype.hasOwnProperty.call(t,"structure"))return void i.Error(i.GetStackTrace(),`ToStreamer->${e} protocol definition was malformed as it specified a byteLength but no accompanying structure`);this.streamMessageController.toStreamerHandlers.get(e)?this.streamMessageController.toStreamerMessages.add(e,t):i.Error(i.GetStackTrace(),`There was no registered handler for "${e}" - try adding one using registerMessageHandler(MessageDirection.ToStreamer, "${e}", myHandler)`);break;case wt.FromStreamer:if(!Object.prototype.hasOwnProperty.call(t,"id"))return void i.Error(i.GetStackTrace(),`FromStreamer->${e} protocol definition was malformed as it didn't contain at least an id\n\n                            Definition was: ${JSON.stringify(t,null,2)}`);this.streamMessageController.fromStreamerHandlers.get(e)?this.streamMessageController.fromStreamerMessages.add(e,t.id):i.Error(i.GetStackTrace(),`There was no registered handler for "${t}" - try adding one using registerMessageHandler(MessageDirection.FromStreamer, "${e}", myHandler)`);break;default:i.Error(i.GetStackTrace(),`Unknown direction: ${n}`)}})),this.toStreamerMessagesController.SendRequestInitialSettings(),this.toStreamerMessagesController.SendRequestQualityControl()}catch(t){i.Log(i.GetStackTrace(),t)}}onInputControlOwnership(e){const t=new Uint8Array(e);i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.InputControlOwnership",6);const s=new Boolean(t[1]).valueOf();i.Log(i.GetStackTrace(),`Received input controller message - will your input control the stream: ${s}`),this.pixelStreaming._onInputControlOwnership(s)}onGamepadResponse(e){const t=new TextDecoder("utf-16").decode(e.slice(1)),s=JSON.parse(t);this.gamePadController.onGamepadResponseReceived(s.controllerId)}onAfkTriggered(){this.afkController.onAfkClick(),this.videoPlayer.isPaused()&&this.videoPlayer.hasVideoSource()&&this.playStream()}setAfkEnabled(e){e?this.onAfkTriggered():this.afkController.stopAfkWarningTimer()}restartStreamAutomatically(){if(this.webSocketController)if(this.webSocketController.webSocket&&this.webSocketController.webSocket.readyState!==WebSocket.CLOSED){this.pixelStreaming._showActionOrErrorOnDisconnect=!1,this.setDisconnectMessageOverride("Restarting stream..."),this.closeSignalingServer();const e=setTimeout((()=>{this.pixelStreaming._onWebRtcAutoConnect(),this.connectToSignallingServer(),clearTimeout(e)}),3e3)}else i.Log(i.GetStackTrace(),"A websocket connection has not been made yet so we will start the stream"),this.pixelStreaming._onWebRtcAutoConnect(),this.connectToSignallingServer();else i.Log(i.GetStackTrace(),"The Web Socket Controller does not exist so this will not work right now.")}loadFreezeFrameOrShowPlayOverlay(){this.pixelStreaming.dispatchEvent(new j({shouldShowPlayOverlay:this.shouldShowPlayOverlay,isValid:this.freezeFrameController.valid,jpegData:this.freezeFrameController.jpeg})),!0===this.shouldShowPlayOverlay?(i.Log(i.GetStackTrace(),"showing play overlay"),this.resizePlayerStyle()):(i.Log(i.GetStackTrace(),"showing freeze frame"),this.freezeFrameController.showFreezeFrame()),setTimeout((()=>{this.videoPlayer.setVideoEnabled(!1)}),this.freezeFrameController.freezeFrameDelay)}onFreezeFrameMessage(e){i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.FreezeFrame",6);const t=new Uint8Array(e);this.freezeFrameController.processFreezeFrameMessage(t,(()=>this.loadFreezeFrameOrShowPlayOverlay()))}invalidateFreezeFrameAndEnableVideo(){i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.FreezeFrame",6),setTimeout((()=>{this.pixelStreaming.dispatchEvent(new Y),this.freezeFrameController.hideFreezeFrame()}),this.freezeFrameController.freezeFrameDelay),this.videoPlayer.getVideoElement()&&this.videoPlayer.setVideoEnabled(!0)}onFileExtension(e){const t=new Uint8Array(e);We.setExtensionFromBytes(t,this.file)}onFileMimeType(e){const t=new Uint8Array(e);We.setMimeTypeFromBytes(t,this.file)}onFileContents(e){const t=new Uint8Array(e);We.setContentsFromBytes(t,this.file)}playStream(){if(!this.videoPlayer.getVideoElement()){const e="Could not play video stream because the video player was not initialized correctly.";return this.pixelStreaming.dispatchEvent(new $({message:e})),i.Error(i.GetStackTrace(),e),this.setDisconnectMessageOverride("Stream not initialized correctly"),void this.closeSignalingServer()}if(this.videoPlayer.hasVideoSource()){if(this.setTouchInputEnabled(this.config.isFlagEnabled(le.TouchInput)),this.pixelStreaming.dispatchEvent(new q),this.streamController.audioElement.srcObject){const e=this.config.isFlagEnabled(le.StartVideoMuted);this.streamController.audioElement.muted=e,e?this.playVideo():this.streamController.audioElement.play().then((()=>{this.playVideo()})).catch((e=>{i.Log(i.GetStackTrace(),e),i.Log(i.GetStackTrace(),"Browser does not support autoplaying video without interaction - to resolve this we are going to show the play button overlay."),this.pixelStreaming.dispatchEvent(new X({reason:e}))}))}else this.playVideo();this.shouldShowPlayOverlay=!1,this.freezeFrameController.showFreezeFrame()}else i.Warning(i.GetStackTrace(),"Cannot play stream, the video element has no srcObject to play.")}playVideo(){this.videoPlayer.play().catch((e=>{this.streamController.audioElement.srcObject&&this.streamController.audioElement.pause(),i.Log(i.GetStackTrace(),e),i.Log(i.GetStackTrace(),"Browser does not support autoplaying video without interaction - to resolve this we are going to show the play button overlay."),this.pixelStreaming.dispatchEvent(new X({reason:e}))}))}autoPlayVideoOrSetUpPlayOverlay(){this.config.isFlagEnabled(le.AutoPlayVideo)&&this.playStream(),this.resizePlayerStyle()}connectToSignallingServer(){const e=this.signallingUrlBuilder();this.webSocketController.connect(e)}startSession(e){if(this.peerConfig=e,this.config.isFlagEnabled(le.ForceTURN)&&!this.checkTurnServerAvailability(e))return i.Info(i.GetStackTrace(),"No turn server was found in the Peer Connection Options. TURN cannot be forced, closing connection. Please use STUN instead"),this.setDisconnectMessageOverride("TURN cannot be forced, closing connection. Please use STUN instead."),void this.closeSignalingServer();this.peerConnectionController=new Ue(this.peerConfig,this.config,this.preferredCodec),this.peerConnectionController.onVideoStats=e=>this.handleVideoStats(e),this.peerConnectionController.onSendWebRTCOffer=e=>this.handleSendWebRTCOffer(e),this.peerConnectionController.onSendWebRTCAnswer=e=>this.handleSendWebRTCAnswer(e),this.peerConnectionController.onPeerIceCandidate=e=>this.handleSendIceCandidate(e),this.peerConnectionController.onDataChannel=e=>this.handleDataChannel(e),this.peerConnectionController.showTextOverlayConnecting=()=>this.pixelStreaming._onWebRtcConnecting(),this.peerConnectionController.showTextOverlaySetupFailure=()=>this.pixelStreaming._onWebRtcFailed();let t=!1;this.peerConnectionController.onIceConnectionStateChange=()=>{!t&&["connected","completed"].includes(this.peerConnectionController.peerConnection.iceConnectionState)&&(this.pixelStreaming._onWebRtcConnected(),t=!0)},this.peerConnectionController.onTrack=e=>this.streamController.handleOnTrack(e),this.config.isFlagEnabled(le.BrowserSendOffer)&&(this.sendrecvDataChannelController.createDataChannel(this.peerConnectionController.peerConnection,"cirrus",this.datachannelOptions),this.sendrecvDataChannelController.handleOnMessage=e=>this.handleOnMessage(e),this.peerConnectionController.createOffer(this.sdpConstraints,this.config))}checkTurnServerAvailability(e){if(!e.iceServers)return i.Info(i.GetStackTrace(),"A turn sever was not found"),!1;for(const t of e.iceServers)for(const e of t.urls)if(e.includes("turn"))return i.Log(i.GetStackTrace(),`A turn sever was found at ${e}`),!0;return i.Info(i.GetStackTrace(),"A turn sever was not found"),!1}handleOnConfigMessage(e){this.resizePlayerStyle(),this.startSession(e.peerConnectionOptions),this.webSocketController.onWebRtcAnswer=e=>this.handleWebRtcAnswer(e),this.webSocketController.onWebRtcOffer=e=>this.handleWebRtcOffer(e),this.webSocketController.onWebRtcPeerDataChannels=e=>this.handleWebRtcSFUPeerDatachannels(e),this.webSocketController.onIceCandidate=e=>this.handleIceCandidate(e)}handleStreamerListMessage(e){if(i.Log(i.GetStackTrace(),`Got streamer list ${e.ids}`,6),this.isReconnecting)e.ids.includes(this.subscribedStream)?(this.isReconnecting=!1,this.reconnectAttempt=0,this.webSocketController.sendSubscribe(this.subscribedStream)):this.reconnectAttempt<this.config.getNumericSettingValue(ce.MaxReconnectAttempts)?(this.reconnectAttempt++,setTimeout((()=>{this.webSocketController.requestStreamerList()}),2e3)):(this.reconnectAttempt=0,this.isReconnecting=!1,this.shouldReconnect=!1,this.webSocketController.close(),this.config.setOptionSettingValue(me.StreamerId,""),this.config.setOptionSettingOptions(me.StreamerId,[]));else{const t=[...e.ids];t.unshift(""),this.config.setOptionSettingOptions(me.StreamerId,t);const s=new URLSearchParams(window.location.search);let n=null;1==e.ids.length?n=e.ids[0]:this.config.isFlagEnabled(le.PreferSFU)&&e.ids.includes("SFU")?n="SFU":s.has(me.StreamerId)&&e.ids.includes(s.get(me.StreamerId))&&(n=s.get(me.StreamerId)),null!==n&&this.config.setOptionSettingValue(me.StreamerId,n),this.pixelStreaming.dispatchEvent(new Z({messageStreamerList:e,autoSelectedStreamerId:n}))}}handleWebRtcAnswer(e){i.Log(i.GetStackTrace(),`Got answer sdp ${e.sdp}`,6);const t={sdp:e.sdp,type:"answer"};this.peerConnectionController.receiveAnswer(t),this.handlePostWebrtcNegotiation()}handleWebRtcOffer(e){i.Log(i.GetStackTrace(),`Got offer sdp ${e.sdp}`,6),this.isUsingSFU=!!e.sfu&&e.sfu,this.isUsingSFU&&(this.peerConnectionController.preferredCodec="");const t={sdp:e.sdp,type:"offer"};this.peerConnectionController.receiveOffer(t,this.config),this.handlePostWebrtcNegotiation()}handleWebRtcSFUPeerDatachannels(e){const t={ordered:!0,negotiated:!0,id:e.sendStreamId},s=e.sendStreamId!=e.recvStreamId;if(this.sendrecvDataChannelController.createDataChannel(this.peerConnectionController.peerConnection,s?"send-datachannel":"datachannel",t),s){const t={ordered:!0,negotiated:!0,id:e.recvStreamId};this.recvDataChannelController.createDataChannel(this.peerConnectionController.peerConnection,"recv-datachannel",t),this.recvDataChannelController.handleOnOpen=()=>this.webSocketController.sendSFURecvDataChannelReady(),this.recvDataChannelController.handleOnMessage=e=>this.handleOnMessage(e)}else this.sendrecvDataChannelController.handleOnMessage=e=>this.handleOnMessage(e)}handlePostWebrtcNegotiation(){this.afkController.startAfkWarningTimer(),this.pixelStreaming._onWebRtcSdp(),this.statsTimerHandle&&void 0!==this.statsTimerHandle&&window.clearInterval(this.statsTimerHandle),this.statsTimerHandle=window.setInterval((()=>this.getStats()),1e3),this.setMouseInputEnabled(this.config.isFlagEnabled(le.MouseInput)),this.setKeyboardInputEnabled(this.config.isFlagEnabled(le.KeyboardInput)),this.setGamePadInputEnabled(this.config.isFlagEnabled(le.GamepadInput))}handleIceCandidate(e){i.Log(i.GetStackTrace(),"Web RTC Controller: onWebRtcIce",6);const t=new RTCIceCandidate(e);this.peerConnectionController.handleOnIce(t)}handleSendIceCandidate(e){i.Log(i.GetStackTrace(),"OnIceCandidate",6),e.candidate&&e.candidate.candidate&&this.webSocketController.sendIceCandidate(e.candidate)}handleDataChannel(e){i.Log(i.GetStackTrace(),"Data channel created for us by browser as we are a receiving peer.",6),this.sendrecvDataChannelController.dataChannel=e.channel,this.sendrecvDataChannelController.setupDataChannel(),this.sendrecvDataChannelController.handleOnMessage=e=>this.handleOnMessage(e)}handleSendWebRTCOffer(e){i.Log(i.GetStackTrace(),"Sending the offer to the Server",6),this.webSocketController.sendWebRtcOffer(e)}handleSendWebRTCAnswer(e){i.Log(i.GetStackTrace(),"Sending the answer to the Server",6),this.webSocketController.sendWebRtcAnswer(e),this.isUsingSFU&&this.webSocketController.sendWebRtcDatachannelRequest()}setUpMouseAndFreezeFrame(){this.videoElementParentClientRect=this.videoPlayer.getVideoParentElement().getBoundingClientRect(),this.coordinateConverter.setupNormalizeAndQuantize(),this.freezeFrameController.freezeFrame.resize()}closeSignalingServer(){var e;this.shouldReconnect=!1,null===(e=this.webSocketController)||void 0===e||e.close()}closePeerConnection(){var e;null===(e=this.peerConnectionController)||void 0===e||e.close()}close(){this.closeSignalingServer(),this.closePeerConnection()}getStats(){this.peerConnectionController.generateStats()}sendLatencyTest(){this.latencyStartTime=Date.now(),this.sendDescriptorController.sendLatencyTest({StartTime:this.latencyStartTime})}sendEncoderMinQP(e){i.Log(i.GetStackTrace(),`MinQP=${e}\n`,6),null!=e&&this.sendDescriptorController.emitCommand({"Encoder.MinQP":e})}sendEncoderMaxQP(e){i.Log(i.GetStackTrace(),`MaxQP=${e}\n`,6),null!=e&&this.sendDescriptorController.emitCommand({"Encoder.MaxQP":e})}sendWebRTCMinBitrate(e){i.Log(i.GetStackTrace(),`WebRTC Min Bitrate=${e}`,6),null!=e&&this.sendDescriptorController.emitCommand({"WebRTC.MinBitrate":e})}sendWebRTCMaxBitrate(e){i.Log(i.GetStackTrace(),`WebRTC Max Bitrate=${e}`,6),null!=e&&this.sendDescriptorController.emitCommand({"WebRTC.MaxBitrate":e})}sendWebRTCFps(e){i.Log(i.GetStackTrace(),`WebRTC FPS=${e}`,6),null!=e&&(this.sendDescriptorController.emitCommand({"WebRTC.Fps":e}),this.sendDescriptorController.emitCommand({"WebRTC.MaxFps":e}))}sendShowFps(){i.Log(i.GetStackTrace(),"----   Sending show stat to UE   ----",6),this.sendDescriptorController.emitCommand({"stat.fps":""})}sendIframeRequest(){i.Log(i.GetStackTrace(),"----   Sending Request for an IFrame  ----",6),this.streamMessageController.toStreamerHandlers.get("IFrameRequest")()}emitUIInteraction(e){i.Log(i.GetStackTrace(),"----   Sending custom UIInteraction message   ----",6),this.sendDescriptorController.emitUIInteraction(e)}emitCommand(e){i.Log(i.GetStackTrace(),"----   Sending custom Command message   ----",6),this.sendDescriptorController.emitCommand(e)}emitConsoleCommand(e){i.Log(i.GetStackTrace(),"----   Sending custom Command:ConsoleCommand message   ----",6),this.sendDescriptorController.emitCommand({ConsoleCommand:e})}sendRequestQualityControlOwnership(){i.Log(i.GetStackTrace(),"----   Sending Request to Control Quality  ----",6),this.toStreamerMessagesController.SendRequestQualityControl()}handleLatencyTestResult(e){i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.latencyTest",6);const t=new TextDecoder("utf-16").decode(e.slice(1)),s=new _e;Object.assign(s,JSON.parse(t)),s.processFields(),s.testStartTimeMs=this.latencyStartTime,s.browserReceiptTimeMs=Date.now(),s.latencyExcludingDecode=~~(s.browserReceiptTimeMs-s.testStartTimeMs),s.testDuration=~~(s.TransmissionTimeMs-s.ReceiptTimeMs),s.networkLatency=~~(s.latencyExcludingDecode-s.testDuration),s.frameDisplayDeltaTimeMs&&s.browserReceiptTimeMs&&(s.endToEndLatency=(s.frameDisplayDeltaTimeMs,s.networkLatency,~~+s.CaptureToSendMs)),this.pixelStreaming._onLatencyTestResult(s)}handleInitialSettings(e){i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.InitialSettings",6);const t=new TextDecoder("utf-16").decode(e.slice(1)),s=JSON.parse(t),n=new Ie;s.Encoder&&(n.EncoderSettings=s.Encoder),s.WebRTC&&(n.WebRTCSettings=s.WebRTC),s.PixelStreaming&&(n.PixelStreamingSettings=s.PixelStreaming),s.ConfigOptions&&void 0!==s.ConfigOptions.DefaultToHover&&this.config.setFlagEnabled(le.HoveringMouseMode,!!s.ConfigOptions.DefaultToHover),n.ueCompatible(),i.Log(i.GetStackTrace(),t,6),this.pixelStreaming._onInitialSettings(n)}handleVideoEncoderAvgQP(e){i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.VideoEncoderAvgQP",6);const t=Number(new TextDecoder("utf-16").decode(e.slice(1)));this.setVideoEncoderAvgQP(t)}handleVideoInitialized(){this.pixelStreaming._onVideoInitialized(),this.autoPlayVideoOrSetUpPlayOverlay(),this.resizePlayerStyle(),this.videoPlayer.updateVideoStreamSize()}onQualityControlOwnership(e){const t=new Uint8Array(e);i.Log(i.GetStackTrace(),"DataChannelReceiveMessageType.QualityControlOwnership",6),this.isQualityController=new Boolean(t[1]).valueOf(),i.Log(i.GetStackTrace(),`Received quality controller message, will control quality: ${this.isQualityController}`),this.pixelStreaming._onQualityControlOwnership(this.isQualityController)}handleVideoStats(e){this.pixelStreaming._onVideoStats(e)}resizePlayerStyle(){this.videoPlayer.resizePlayerStyle()}getDisconnectMessageOverride(){return this.disconnectMessageOverride}setDisconnectMessageOverride(e){this.disconnectMessageOverride=e}setPreferredCodec(e){this.preferredCodec=e,this.peerConnectionController&&(this.peerConnectionController.preferredCodec=e,this.peerConnectionController.updateCodecSelection=!1)}setVideoEncoderAvgQP(e){this.videoAvgQp=e,this.pixelStreaming._onVideoEncoderAvgQP(this.videoAvgQp)}setKeyboardInputEnabled(e){var t;null===(t=this.keyboardController)||void 0===t||t.unregisterKeyBoardEvents(),e&&(this.keyboardController=this.inputClassesFactory.registerKeyBoard(this.config))}setMouseInputEnabled(e){var t;if(null===(t=this.mouseController)||void 0===t||t.unregisterMouseEvents(),e){const e=this.config.isFlagEnabled(le.HoveringMouseMode)?De.HoveringMouse:De.LockedMouse;this.mouseController=this.inputClassesFactory.registerMouse(e)}}setTouchInputEnabled(e){var t;null===(t=this.touchController)||void 0===t||t.unregisterTouchEvents(),e&&(this.touchController=this.inputClassesFactory.registerTouch(this.config.isFlagEnabled(le.FakeMouseWithTouches),this.videoElementParentClientRect))}setGamePadInputEnabled(e){var t;null===(t=this.gamePadController)||void 0===t||t.unregisterGamePadEvents(),e&&(this.gamePadController=this.inputClassesFactory.registerGamePad(),this.gamePadController.onGamepadConnected=()=>{this.streamMessageController.toStreamerHandlers.get("GamepadConnected")()},this.gamePadController.onGamepadDisconnected=e=>{this.streamMessageController.toStreamerHandlers.get("GamepadDisconnected")([e])})}registerDataChannelEventEmitters(e){e.onOpen=(e,t)=>this.pixelStreaming.dispatchEvent(new B({label:e,event:t})),e.onClose=(e,t)=>this.pixelStreaming.dispatchEvent(new _({label:e,event:t})),e.onError=(e,t)=>this.pixelStreaming.dispatchEvent(new W({label:e,event:t}))}}class St{static vertexShader(){return"\n\t\tattribute vec2 a_position;\n\t\tattribute vec2 a_texCoord;\n\n\t\t// input\n\t\tuniform vec2 u_resolution;\n\t\tuniform vec4 u_offset;\n\n\t\t//\n\t\tvarying vec2 v_texCoord;\n\n\t\tvoid main() {\n\t\t   // convert the rectangle from pixels to 0.0 to 1.0\n\t\t   vec2 zeroToOne = a_position / u_resolution;\n\n\t\t   // convert from 0->1 to 0->2\n\t\t   vec2 zeroToTwo = zeroToOne * 2.0;\n\n\t\t   // convert from 0->2 to -1->+1 (clipspace)\n\t\t   vec2 clipSpace = zeroToTwo - 1.0;\n\n\t\t   gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n\t\t   // pass the texCoord to the fragment shader\n\t\t   // The GPU will interpolate this value between points.\n\t\t   v_texCoord = (a_texCoord * u_offset.xy) + u_offset.zw;\n\t\t}\n\t\t"}static fragmentShader(){return"\n\t\tprecision mediump float;\n\n\t\t// our texture\n\t\tuniform sampler2D u_image;\n\n\t\t// the texCoords passed in from the vertex shader.\n\t\tvarying vec2 v_texCoord;\n\n\t\tvoid main() {\n\t\t   gl_FragColor = texture2D(u_image, v_texCoord);\n\t\t}\n\t\t"}}class vt{static deepCopyGamepad(e){return JSON.parse(JSON.stringify({buttons:e.buttons.map((e=>JSON.parse(JSON.stringify({pressed:e.pressed,touched:e.touched})))),axes:e.axes}))}}class Ct{constructor(e){this.toStreamerMessagesProvider=e,this.controllers=[]}updateStatus(e,t,s){if(e.gamepad){const n=t.getPose(e.gripSpace,s);if(!n)return;let r=0;e.profiles.includes("htc-vive")?r=1:e.profiles.includes("oculus-touch")&&(r=2),this.toStreamerMessagesProvider.toStreamerHandlers.get("XRSystem")([r]);let de=2;switch(e.handedness){case"left":de=0;break;case"right":de=1}const he=n.transform.matrix,ue=[];for(let e=0;e<16;e++)ue[e]=new Float32Array([he[e]])[0];this.toStreamerMessagesProvider.toStreamerHandlers.get("XRControllerTransform")([ue[0],ue[4],ue[8],ue[12],ue[1],ue[5],ue[9],ue[13],ue[2],ue[6],ue[10],ue[14],ue[3],ue[7],ue[11],ue[15],de]),void 0===this.controllers[de]&&(this.controllers[de]={prevState:void 0,currentState:void 0,id:void 0},this.controllers[de].prevState=vt.deepCopyGamepad(e.gamepad)),this.controllers[de].currentState=vt.deepCopyGamepad(e.gamepad);const pe=this.controllers[de],ve=pe.currentState,Le=pe.prevState;for(let e=0;e<ve.buttons.length;e++){const t=ve.buttons[e],s=Le.buttons[e];t.pressed?this.toStreamerMessagesProvider.toStreamerHandlers.get("XRButtonPressed")([de,e,s.pressed?1:0]):!t.pressed&&s.pressed&&this.toStreamerMessagesProvider.toStreamerHandlers.get("XRButtonReleased")([de,e,0]),t.touched&&!t.pressed?this.toStreamerMessagesProvider.toStreamerHandlers.get("XRButtonPressed")([de,3,s.touched?1:0]):!t.touched&&s.touched&&this.toStreamerMessagesProvider.toStreamerHandlers.get("XRButtonReleased")([de,3,0])}for(let e=0;e<ve.axes.length;e++)this.toStreamerMessagesProvider.toStreamerHandlers.get("XRAnalog")([de,e,ve.axes[e]]);this.controllers[de].prevState=ve}}}class ft{constructor(e){this.xrSession=null,this.webRtcController=e,this.xrControllers=[],this.xrGamepadController=new Ct(this.webRtcController.streamMessageController),this.onSessionEnded=new EventTarget,this.onSessionStarted=new EventTarget,this.onFrame=new EventTarget}xrClicked(){this.xrSession?this.xrSession.end():navigator.xr.requestSession("immersive-vr").then((e=>{this.onXrSessionStarted(e)}))}onXrSessionEnded(){i.Log(i.GetStackTrace(),"XR Session ended"),this.xrSession=null,this.onSessionEnded.dispatchEvent(new Event("xrSessionEnded"))}onXrSessionStarted(e){i.Log(i.GetStackTrace(),"XR Session started"),this.xrSession=e,this.xrSession.addEventListener("end",(()=>{this.onXrSessionEnded()}));const t=document.createElement("canvas");this.gl=t.getContext("webgl2",{xrCompatible:!0}),this.xrSession.updateRenderState({baseLayer:new XRWebGLLayer(this.xrSession,this.gl)});const s=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(s,St.vertexShader()),this.gl.compileShader(s);const n=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(n,St.fragmentShader()),this.gl.compileShader(n);const r=this.gl.createProgram();this.gl.attachShader(r,s),this.gl.attachShader(r,n),this.gl.linkProgram(r),this.gl.useProgram(r),this.positionLocation=this.gl.getAttribLocation(r,"a_position"),this.texcoordLocation=this.gl.getAttribLocation(r,"a_texCoord"),this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.enableVertexAttribArray(this.positionLocation);const de=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,de),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.texcoordBuffer=this.gl.createBuffer(),this.resolutionLocation=this.gl.getUniformLocation(r,"u_resolution"),this.offsetLocation=this.gl.getUniformLocation(r,"u_offset"),e.requestReferenceSpace("local").then((e=>{this.xrRefSpace=e,this.xrSession.requestAnimationFrame(((e,t)=>this.onXrFrame(e,t)))})),this.onSessionStarted.dispatchEvent(new Event("xrSessionStarted"))}onXrFrame(e,t){const s=t.getViewerPose(this.xrRefSpace);if(s){const e=s.transform.matrix,t=[];for(let s=0;s<16;s++)t[s]=new Float32Array([e[s]])[0];this.webRtcController.streamMessageController.toStreamerHandlers.get("XRHMDTransform")([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]]);const n=this.xrSession.renderState.baseLayer;this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,n.framebuffer),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.webRtcController.videoPlayer.getVideoElement()),this.render(this.webRtcController.videoPlayer.getVideoElement())}this.webRtcController.config.isFlagEnabled(le.XRControllerInput)&&this.xrSession.inputSources.forEach(((e,s,n)=>{this.xrGamepadController.updateStatus(e,t,this.xrRefSpace)}),this),this.xrSession.requestAnimationFrame(((e,t)=>this.onXrFrame(e,t))),this.onFrame.dispatchEvent(new ie({time:e,frame:t}))}render(e){if(!this.gl)return;const t=this.xrSession.renderState.baseLayer;let s,n,r,de,he;this.gl.viewport(0,0,t.framebufferWidth,t.framebufferHeight),this.gl.uniform4f(this.offsetLocation,1,1,0,0),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,e.videoWidth,0,0,e.videoHeight,0,e.videoHeight,e.videoWidth,0,e.videoWidth,e.videoHeight]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),s=2,n=this.gl.FLOAT,r=!1,de=0,he=0,this.gl.vertexAttribPointer(this.positionLocation,s,n,r,de,he),this.gl.enableVertexAttribArray(this.texcoordLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer),s=2,n=this.gl.FLOAT,r=!1,de=0,he=0,this.gl.vertexAttribPointer(this.texcoordLocation,s,n,r,de,he),this.gl.uniform2f(this.resolutionLocation,e.videoWidth,e.videoHeight);const ue=this.gl.TRIANGLES;he=0,this.gl.drawArrays(ue,he,6)}static isSessionSupported(e){return navigator.xr?navigator.xr.isSessionSupported(e):new Promise((()=>!1))}}class Et{constructor(e){this.editTextButton=null,this.hiddenInput=null,"ontouchstart"in document.documentElement&&this.createOnScreenKeyboardHelpers(e)}unquantizeAndDenormalizeUnsigned(e,t){return null}createOnScreenKeyboardHelpers(e){this.hiddenInput||(this.hiddenInput=document.createElement("input"),this.hiddenInput.id="hiddenInput",this.hiddenInput.maxLength=0,e.appendChild(this.hiddenInput)),this.editTextButton||(this.editTextButton=document.createElement("button"),this.editTextButton.id="editTextButton",this.editTextButton.innerHTML="edit text",e.appendChild(this.editTextButton),this.editTextButton.classList.add("hiddenState"),this.editTextButton.addEventListener("touchend",(e=>{this.hiddenInput.focus(),e.preventDefault()})))}showOnScreenKeyboard(e){if(e.showOnScreenKeyboard){this.editTextButton.classList.remove("hiddenState");const t=this.unquantizeAndDenormalizeUnsigned(e.x,e.y);this.editTextButton.style.top=t.y.toString()+"px",this.editTextButton.style.left=(t.x-40).toString()+"px"}else this.editTextButton.classList.add("hiddenState"),this.hiddenInput.blur()}}class Tt{constructor(e,t){this._showActionOrErrorOnDisconnect=!0,this.allowConsoleCommands=!1,this.config=e,(null==t?void 0:t.videoElementParent)&&(this._videoElementParent=t.videoElementParent),this._eventEmitter=new ae,this.configureSettings(),this.setWebRtcPlayerController(new pt(this.config,this)),this.onScreenKeyboardHelper=new Et(this.videoElementParent),this.onScreenKeyboardHelper.unquantizeAndDenormalizeUnsigned=(e,t)=>this._webRtcController.requestUnquantizedAndDenormalizeUnsigned(e,t),this._activateOnScreenKeyboard=e=>this.onScreenKeyboardHelper.showOnScreenKeyboard(e),this._webXrController=new ft(this._webRtcController)}get videoElementParent(){return this._videoElementParent||(this._videoElementParent=document.createElement("div"),this._videoElementParent.id="videoElementParent"),this._videoElementParent}configureSettings(){this.config._addOnSettingChangedListener(le.IsQualityController,(e=>{!0!==e||this._webRtcController.isQualityController||this._webRtcController.sendRequestQualityControlOwnership()})),this.config._addOnSettingChangedListener(le.AFKDetection,(e=>{this._webRtcController.setAfkEnabled(e)})),this.config._addOnSettingChangedListener(le.MatchViewportResolution,(()=>{this._webRtcController.videoPlayer.updateVideoStreamSize()})),this.config._addOnSettingChangedListener(le.HoveringMouseMode,(e=>{this.config.setFlagLabel(le.HoveringMouseMode,`Control Scheme: ${e?"Hovering":"Locked"} Mouse`),this._webRtcController.setMouseInputEnabled(this.config.isFlagEnabled(le.MouseInput))})),this.config._addOnSettingChangedListener(le.KeyboardInput,(e=>{this._webRtcController.setKeyboardInputEnabled(e)})),this.config._addOnSettingChangedListener(le.MouseInput,(e=>{this._webRtcController.setMouseInputEnabled(e)})),this.config._addOnSettingChangedListener(le.TouchInput,(e=>{this._webRtcController.setTouchInputEnabled(e)})),this.config._addOnSettingChangedListener(le.GamepadInput,(e=>{this._webRtcController.setGamePadInputEnabled(e)})),this.config._addOnNumericSettingChangedListener(ce.MinQP,(e=>{i.Log(i.GetStackTrace(),"--------  Sending MinQP  --------",7),this._webRtcController.sendEncoderMinQP(e),i.Log(i.GetStackTrace(),"-------------------------------------------",7)})),this.config._addOnNumericSettingChangedListener(ce.MaxQP,(e=>{i.Log(i.GetStackTrace(),"--------  Sending encoder settings  --------",7),this._webRtcController.sendEncoderMaxQP(e),i.Log(i.GetStackTrace(),"-------------------------------------------",7)})),this.config._addOnNumericSettingChangedListener(ce.WebRTCMinBitrate,(e=>{i.Log(i.GetStackTrace(),"--------  Sending web rtc settings  --------",7),this._webRtcController.sendWebRTCMinBitrate(1e3*e),i.Log(i.GetStackTrace(),"-------------------------------------------",7)})),this.config._addOnNumericSettingChangedListener(ce.WebRTCMaxBitrate,(e=>{i.Log(i.GetStackTrace(),"--------  Sending web rtc settings  --------",7),this._webRtcController.sendWebRTCMaxBitrate(1e3*e),i.Log(i.GetStackTrace(),"-------------------------------------------",7)})),this.config._addOnNumericSettingChangedListener(ce.WebRTCFPS,(e=>{i.Log(i.GetStackTrace(),"--------  Sending web rtc settings  --------",7),this._webRtcController.sendWebRTCFps(e),i.Log(i.GetStackTrace(),"-------------------------------------------",7)})),this.config._addOnOptionSettingChangedListener(me.PreferredCodec,(e=>{this._webRtcController&&this._webRtcController.setPreferredCodec(e)})),this.config._registerOnChangeEvents(this._eventEmitter)}_activateOnScreenKeyboard(e){throw new Error("Method not implemented.")}_onInputControlOwnership(e){this._inputController=e}setWebRtcPlayerController(e){this._webRtcController=e,this._webRtcController.setPreferredCodec(this.config.getSettingOption(me.PreferredCodec).selected),this._webRtcController.resizePlayerStyle(),this.checkForAutoConnect()}connect(){this._eventEmitter.dispatchEvent(new N),this._webRtcController.connectToSignallingServer()}reconnect(){this._eventEmitter.dispatchEvent(new Q),this._webRtcController.restartStreamAutomatically()}disconnect(){this._eventEmitter.dispatchEvent(new K),this._webRtcController.close()}play(){this._onStreamLoading(),this._webRtcController.playStream()}checkForAutoConnect(){this.config.isFlagEnabled(le.AutoConnect)&&(this._onWebRtcAutoConnect(),this._webRtcController.connectToSignallingServer())}_onWebRtcAutoConnect(){this._eventEmitter.dispatchEvent(new O),this._showActionOrErrorOnDisconnect=!0}_onWebRtcSdp(){this._eventEmitter.dispatchEvent(new D)}_onStreamLoading(){this._eventEmitter.dispatchEvent(new V)}_onDisconnect(e){""!=this._webRtcController.getDisconnectMessageOverride()&&void 0!==this._webRtcController.getDisconnectMessageOverride()&&null!=this._webRtcController.getDisconnectMessageOverride()&&(e=this._webRtcController.getDisconnectMessageOverride(),this._webRtcController.setDisconnectMessageOverride("")),this._eventEmitter.dispatchEvent(new z({eventString:e,showActionOrErrorOnDisconnect:this._showActionOrErrorOnDisconnect})),0==this._showActionOrErrorOnDisconnect&&(this._showActionOrErrorOnDisconnect=!0)}_onWebRtcConnecting(){this._eventEmitter.dispatchEvent(new U)}_onWebRtcConnected(){this._eventEmitter.dispatchEvent(new I)}_onWebRtcFailed(){this._eventEmitter.dispatchEvent(new G)}_onVideoInitialized(){this._eventEmitter.dispatchEvent(new H),this._videoStartTime=Date.now()}_onLatencyTestResult(e){this._eventEmitter.dispatchEvent(new ee({latencyTimings:e}))}_onVideoStats(e){this._videoStartTime&&void 0!==this._videoStartTime||(this._videoStartTime=Date.now()),e.handleSessionStatistics(this._videoStartTime,this._inputController,this._webRtcController.videoAvgQp),this._eventEmitter.dispatchEvent(new J({aggregatedStats:e}))}_onVideoEncoderAvgQP(e){this._eventEmitter.dispatchEvent(new F({avgQP:e}))}_onInitialSettings(e){var t;this._eventEmitter.dispatchEvent(new te({settings:e})),e.PixelStreamingSettings&&(this.allowConsoleCommands=null!==(t=e.PixelStreamingSettings.AllowPixelStreamingCommands)&&void 0!==t&&t,!1===this.allowConsoleCommands&&i.Info(i.GetStackTrace(),"-AllowPixelStreamingCommands=false, sending arbitrary console commands from browser to UE is disabled."));const s=this.config.useUrlParams,n=new URLSearchParams(window.location.search);e.EncoderSettings&&(this.config.setNumericSetting(ce.MinQP,s&&n.has(ce.MinQP)?Number.parseInt(n.get(ce.MinQP)):e.EncoderSettings.MinQP),this.config.setNumericSetting(ce.MaxQP,s&&n.has(ce.MaxQP)?Number.parseInt(n.get(ce.MaxQP)):e.EncoderSettings.MaxQP)),e.WebRTCSettings&&(this.config.setNumericSetting(ce.WebRTCMinBitrate,s&&n.has(ce.WebRTCMinBitrate)?Number.parseInt(n.get(ce.WebRTCMinBitrate)):e.WebRTCSettings.MinBitrate/1e3),this.config.setNumericSetting(ce.WebRTCMaxBitrate,s&&n.has(ce.WebRTCMaxBitrate)?Number.parseInt(n.get(ce.WebRTCMaxBitrate)):e.WebRTCSettings.MaxBitrate/1e3),this.config.setNumericSetting(ce.WebRTCFPS,s&&n.has(ce.WebRTCFPS)?Number.parseInt(n.get(ce.WebRTCFPS)):e.WebRTCSettings.FPS))}_onQualityControlOwnership(e){this.config.setFlagEnabled(le.IsQualityController,e)}_onPlayerCount(e){this._eventEmitter.dispatchEvent(new oe({count:e}))}requestLatencyTest(){return!!this._webRtcController.videoPlayer.isVideoReady()&&(this._webRtcController.sendLatencyTest(),!0)}requestShowFps(){return!!this._webRtcController.videoPlayer.isVideoReady()&&(this._webRtcController.sendShowFps(),!0)}requestIframe(){return!!this._webRtcController.videoPlayer.isVideoReady()&&(this._webRtcController.sendIframeRequest(),!0)}emitUIInteraction(e){return!!this._webRtcController.videoPlayer.isVideoReady()&&(this._webRtcController.emitUIInteraction(e),!0)}emitCommand(e){return!(!this._webRtcController.videoPlayer.isVideoReady()||!this.allowConsoleCommands&&"ConsoleCommand"in e||(this._webRtcController.emitCommand(e),0))}emitConsoleCommand(e){return!(!this.allowConsoleCommands||!this._webRtcController.videoPlayer.isVideoReady()||(this._webRtcController.emitConsoleCommand(e),0))}addResponseEventListener(e,t){this._webRtcController.responseController.addResponseEventListener(e,t)}removeResponseEventListener(e){this._webRtcController.responseController.removeResponseEventListener(e)}dispatchEvent(e){return this._eventEmitter.dispatchEvent(e)}addEventListener(e,t){this._eventEmitter.addEventListener(e,t)}removeEventListener(e,t){this._eventEmitter.removeEventListener(e,t)}toggleXR(){this.webXrController.xrClicked()}setSignallingUrlBuilder(e){this._webRtcController.signallingUrlBuilder=e}get webSocketController(){return this._webRtcController.webSocketController}get webXrController(){return this._webXrController}}var kt=ve.De,Lt=ve.Yd,xt=ve.g;function At(){return At=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e},At.apply(this,arguments)}var Ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Dt="object"===("undefined"==typeof window?"undefined":Ot(window))&&"object"===("undefined"==typeof document?"undefined":Ot(document))&&9===document.nodeType,Ft="production"===process.env.NODE_ENV;function It(e,t){if(!Ft){if(e)return;var s="Warning: "+t;"undefined"!=typeof console&&console.warn(s);try{throw Error(s)}catch(n){}}}function _t(e){return(_t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ut(e){var t=function(e,t){if("object"!=_t(e)||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var n=s.call(e,t||"default");if("object"!=_t(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==_t(t)?t:String(t)}function Gt(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Ut(n.key),n)}}function zt(e,t,s){return t&&Gt(e.prototype,t),s&&Gt(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}function Bt(e,t){return(Bt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Vt(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Bt(e,t)}function Wt(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var Ht={}.constructor;function Nt(e){if(null==e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(Nt);if(e.constructor!==Ht)return e;var t={};for(var s in e)t[s]=Nt(e[s]);return t}function Kt(e,t,s){void 0===e&&(e="unnamed");var n=s.jss,r=Nt(t),de=n.plugins.onCreateRule(e,r,s);return de||("@"===e[0]&&"production"!==process.env.NODE_ENV&&It(!1,"[JSS] Unknown rule "+e),null)}var jt=function(e,t){for(var s="",n=0;n<e.length&&"!important"!==e[n];n++)s&&(s+=t),s+=e[n];return s},qt=function(e){if(!Array.isArray(e))return e;var t="";if(Array.isArray(e[0]))for(var s=0;s<e.length&&"!important"!==e[s];s++)t&&(t+=", "),t+=jt(e[s]," ");else t=jt(e,", ");return"!important"===e[e.length-1]&&(t+=" !important"),t};function Qt(e){return e&&!1===e.format?{linebreak:"",space:""}:{linebreak:"\n",space:" "}}function $t(e,t){for(var s="",n=0;n<t;n++)s+="  ";return s+e}function Xt(e,t,s){void 0===s&&(s={});var n="";if(!t)return n;var r=s.indent,de=void 0===r?0:r,he=t.fallbacks;!1===s.format&&(de=-1/0);var ue=Qt(s),pe=ue.linebreak,ve=ue.space;if(e&&de++,he)if(Array.isArray(he))for(var Le=0;Le<he.length;Le++){var xe=he[Le];for(var Ae in xe){var Oe=xe[Ae];null!=Oe&&(n&&(n+=pe),n+=$t(Ae+":"+ve+qt(Oe)+";",de))}}else for(var De in he){var Fe=he[De];null!=Fe&&(n&&(n+=pe),n+=$t(De+":"+ve+qt(Fe)+";",de))}for(var yt in t){var bt=t[yt];null!=bt&&"fallbacks"!==yt&&(n&&(n+=pe),n+=$t(yt+":"+ve+qt(bt)+";",de))}return(n||s.allowEmpty)&&e?(n&&(n=""+pe+n+pe),$t(""+e+ve+"{"+n,--de)+$t("}",de)):n}var Jt=/([[\].#*$><+~=|^:(),"'`\s])/g,Yt="undefined"!=typeof CSS&&CSS.escape,Zt=function(e){return Yt?Yt(e):e.replace(Jt,"\\$1")},es=function(){function e(e,t,s){this.type="style",this.isProcessed=!1;var n=s.sheet,r=s.Renderer;this.key=e,this.options=s,this.style=t,n?this.renderer=n.renderer:r&&(this.renderer=new r)}return e.prototype.prop=function(e,t,s){if(void 0===t)return this.style[e];var n=!!s&&s.force;if(!n&&this.style[e]===t)return this;var r=t;s&&!1===s.process||(r=this.options.jss.plugins.onChangeValue(t,e,this));var de=null==r||!1===r,he=e in this.style;if(de&&!he&&!n)return this;var ue=de&&he;if(ue?delete this.style[e]:this.style[e]=r,this.renderable&&this.renderer)return ue?this.renderer.removeProperty(this.renderable,e):this.renderer.setProperty(this.renderable,e,r),this;var pe=this.options.sheet;return pe&&pe.attached&&"production"!==process.env.NODE_ENV&&It(!1,'[JSS] Rule is not linked. Missing sheet option "link: true".'),this},e}(),ts=function(e){function t(t,s,n){var r;r=e.call(this,t,s,n)||this;var de=n.selector,he=n.scoped,ue=n.sheet,pe=n.generateId;return de?r.selectorText=de:!1!==he&&(r.id=pe(Wt(Wt(r)),ue),r.selectorText="."+Zt(r.id)),r}Vt(t,e);var s=t.prototype;return s.applyTo=function(e){var t=this.renderer;if(t){var s=this.toJSON();for(var n in s)t.setProperty(e,n,s[n])}return this},s.toJSON=function(){var e={};for(var t in this.style){var s=this.style[t];"object"!=typeof s?e[t]=s:Array.isArray(s)&&(e[t]=qt(s))}return e},s.toString=function(e){var t=this.options.sheet,s=!!t&&t.options.link?At({},e,{allowEmpty:!0}):e;return Xt(this.selectorText,this.style,s)},zt(t,[{key:"selector",set:function(e){if(e!==this.selectorText){this.selectorText=e;var t=this.renderer,s=this.renderable;if(s&&t)t.setSelector(s,e)||t.replaceRule(s,this)}},get:function(){return this.selectorText}}]),t}(es),ss={onCreateRule:function(e,t,s){return"@"===e[0]||s.parent&&"keyframes"===s.parent.type?null:new ts(e,t,s)}},ns={indent:1,children:!0},rs=/@([\w-]+)/,is=function(){function e(e,t,s){this.type="conditional",this.isProcessed=!1,this.key=e;var n=e.match(rs);for(var r in this.at=n?n[1]:"unknown",this.query=s.name||"@"+this.at,this.options=s,this.rules=new Ls(At({},s,{parent:this})),t)this.rules.add(r,t[r]);this.rules.process()}var t=e.prototype;return t.getRule=function(e){return this.rules.get(e)},t.indexOf=function(e){return this.rules.indexOf(e)},t.addRule=function(e,t,s){var n=this.rules.add(e,t,s);return n?(this.options.jss.plugins.onProcessRule(n),n):null},t.replaceRule=function(e,t,s){var n=this.rules.replace(e,t,s);return n&&this.options.jss.plugins.onProcessRule(n),n},t.toString=function(e){void 0===e&&(e=ns);var t=Qt(e).linebreak;if(null==e.indent&&(e.indent=ns.indent),null==e.children&&(e.children=ns.children),!1===e.children)return this.query+" {}";var s=this.rules.toString(e);return s?this.query+" {"+t+s+t+"}":""},e}(),os=/@container|@media|@supports\s+/,as={onCreateRule:function(e,t,s){return os.test(e)?new is(e,t,s):null}},ls={indent:1,children:!0},cs=/@keyframes\s+([\w-]+)/,ds=function(){function e(e,t,s){this.type="keyframes",this.at="@keyframes",this.isProcessed=!1;var n=e.match(cs);n&&n[1]?this.name=n[1]:(this.name="noname","production"!==process.env.NODE_ENV&&It(!1,"[JSS] Bad keyframes name "+e)),this.key=this.type+"-"+this.name,this.options=s;var r=s.scoped,de=s.sheet,he=s.generateId;for(var ue in this.id=!1===r?this.name:Zt(he(this,de)),this.rules=new Ls(At({},s,{parent:this})),t)this.rules.add(ue,t[ue],At({},s,{parent:this}));this.rules.process()}return e.prototype.toString=function(e){void 0===e&&(e=ls);var t=Qt(e).linebreak;if(null==e.indent&&(e.indent=ls.indent),null==e.children&&(e.children=ls.children),!1===e.children)return this.at+" "+this.id+" {}";var s=this.rules.toString(e);return s&&(s=""+t+s+t),this.at+" "+this.id+" {"+s+"}"},e}(),hs=/@keyframes\s+/,us=/\$([\w-]+)/g,ms=function(e,t){return"string"==typeof e?e.replace(us,(function(e,s){return s in t?t[s]:("production"!==process.env.NODE_ENV&&It(!1,'[JSS] Referenced keyframes rule "'+s+'" is not defined.'),e)})):e},gs=function(e,t,s){var n=e[t],r=ms(n,s);r!==n&&(e[t]=r)},ps={onCreateRule:function(e,t,s){return"string"==typeof e&&hs.test(e)?new ds(e,t,s):null},onProcessStyle:function(e,t,s){return"style"===t.type&&s?("animation-name"in e&&gs(e,"animation-name",s.keyframes),"animation"in e&&gs(e,"animation",s.keyframes),e):e},onChangeValue:function(e,t,s){var n=s.options.sheet;if(!n)return e;switch(t){case"animation":case"animation-name":return ms(e,n.keyframes);default:return e}}},vs=function(e){function t(){return e.apply(this,arguments)||this}return Vt(t,e),t.prototype.toString=function(e){var t=this.options.sheet,s=!!t&&t.options.link?At({},e,{allowEmpty:!0}):e;return Xt(this.key,this.style,s)},t}(es),fs={onCreateRule:function(e,t,s){return s.parent&&"keyframes"===s.parent.type?new vs(e,t,s):null}},Ss=function(){function e(e,t,s){this.type="font-face",this.at="@font-face",this.isProcessed=!1,this.key=e,this.style=t,this.options=s}return e.prototype.toString=function(e){var t=Qt(e).linebreak;if(Array.isArray(this.style)){for(var s="",n=0;n<this.style.length;n++)s+=Xt(this.at,this.style[n]),this.style[n+1]&&(s+=t);return s}return Xt(this.at,this.style,e)},e}(),ys=/@font-face/,Cs={onCreateRule:function(e,t,s){return ys.test(e)?new Ss(e,t,s):null}},bs=function(){function e(e,t,s){this.type="viewport",this.at="@viewport",this.isProcessed=!1,this.key=e,this.style=t,this.options=s}return e.prototype.toString=function(e){return Xt(this.key,this.style,e)},e}(),Ts={onCreateRule:function(e,t,s){return"@viewport"===e||"@-ms-viewport"===e?new bs(e,t,s):null}},Ps=function(){function e(e,t,s){this.type="simple",this.isProcessed=!1,this.key=e,this.value=t,this.options=s}return e.prototype.toString=function(e){if(Array.isArray(this.value)){for(var t="",s=0;s<this.value.length;s++)t+=this.key+" "+this.value[s]+";",this.value[s+1]&&(t+="\n");return t}return this.key+" "+this.value+";"},e}(),ws={"@charset":!0,"@import":!0,"@namespace":!0},Es={onCreateRule:function(e,t,s){return e in ws?new Ps(e,t,s):null}},Ms=[ss,as,ps,fs,Cs,Ts,Es],Rs={process:!0},ks={force:!0,process:!0},Ls=function(){function e(e){this.map={},this.raw={},this.index=[],this.counter=0,this.options=e,this.classes=e.classes,this.keyframes=e.keyframes}var t=e.prototype;return t.add=function(e,t,s){var n=this.options,r=n.parent,de=n.sheet,he=n.jss,ue=n.Renderer,pe=n.generateId,ve=n.scoped,Le=At({classes:this.classes,parent:r,sheet:de,jss:he,Renderer:ue,generateId:pe,scoped:ve,name:e,keyframes:this.keyframes,selector:void 0},s),xe=e;e in this.raw&&(xe=e+"-d"+this.counter++),this.raw[xe]=t,xe in this.classes&&(Le.selector="."+Zt(this.classes[xe]));var Ae=Kt(xe,t,Le);if(!Ae)return null;this.register(Ae);var Oe=void 0===Le.index?this.index.length:Le.index;return this.index.splice(Oe,0,Ae),Ae},t.replace=function(e,t,s){var n=this.get(e),r=this.index.indexOf(n);n&&this.remove(n);var de=s;return-1!==r&&(de=At({},s,{index:r})),this.add(e,t,de)},t.get=function(e){return this.map[e]},t.remove=function(e){this.unregister(e),delete this.raw[e.key],this.index.splice(this.index.indexOf(e),1)},t.indexOf=function(e){return this.index.indexOf(e)},t.process=function(){var e=this.options.jss.plugins;this.index.slice(0).forEach(e.onProcessRule,e)},t.register=function(e){this.map[e.key]=e,e instanceof ts?(this.map[e.selector]=e,e.id&&(this.classes[e.key]=e.id)):e instanceof ds&&this.keyframes&&(this.keyframes[e.name]=e.id)},t.unregister=function(e){delete this.map[e.key],e instanceof ts?(delete this.map[e.selector],delete this.classes[e.key]):e instanceof ds&&delete this.keyframes[e.name]},t.update=function(){var e,t,s;if("string"==typeof(arguments.length<=0?void 0:arguments[0])?(e=arguments.length<=0?void 0:arguments[0],t=arguments.length<=1?void 0:arguments[1],s=arguments.length<=2?void 0:arguments[2]):(t=arguments.length<=0?void 0:arguments[0],s=arguments.length<=1?void 0:arguments[1],e=null),e)this.updateOne(this.get(e),t,s);else for(var n=0;n<this.index.length;n++)this.updateOne(this.index[n],t,s)},t.updateOne=function(t,s,n){void 0===n&&(n=Rs);var r=this.options,de=r.jss.plugins,he=r.sheet;if(t.rules instanceof e)t.rules.update(s,n);else{var ue=t.style;if(de.onUpdate(s,t,he,n),n.process&&ue&&ue!==t.style){for(var pe in de.onProcessStyle(t.style,t,he),t.style){var ve=t.style[pe];ve!==ue[pe]&&t.prop(pe,ve,ks)}for(var Le in ue){var xe=t.style[Le],Ae=ue[Le];null==xe&&xe!==Ae&&t.prop(Le,null,ks)}}}},t.toString=function(e){for(var t="",s=this.options.sheet,n=!!s&&s.options.link,r=Qt(e).linebreak,de=0;de<this.index.length;de++){var he=this.index[de].toString(e);(he||n)&&(t&&(t+=r),t+=he)}return t},e}(),xs=function(){function e(e,t){for(var s in this.attached=!1,this.deployed=!1,this.classes={},this.keyframes={},this.options=At({},t,{sheet:this,parent:this,classes:this.classes,keyframes:this.keyframes}),t.Renderer&&(this.renderer=new t.Renderer(this)),this.rules=new Ls(this.options),e)this.rules.add(s,e[s]);this.rules.process()}var t=e.prototype;return t.attach=function(){return this.attached||(this.renderer&&this.renderer.attach(),this.attached=!0,this.deployed||this.deploy()),this},t.detach=function(){return this.attached?(this.renderer&&this.renderer.detach(),this.attached=!1,this):this},t.addRule=function(e,t,s){var n=this.queue;this.attached&&!n&&(this.queue=[]);var r=this.rules.add(e,t,s);return r?(this.options.jss.plugins.onProcessRule(r),this.attached?this.deployed?(n?n.push(r):(this.insertRule(r),this.queue&&(this.queue.forEach(this.insertRule,this),this.queue=void 0)),r):r:(this.deployed=!1,r)):null},t.replaceRule=function(e,t,s){var n=this.rules.get(e);if(!n)return this.addRule(e,t,s);var r=this.rules.replace(e,t,s);return r&&this.options.jss.plugins.onProcessRule(r),this.attached?this.deployed?(this.renderer&&(r?n.renderable&&this.renderer.replaceRule(n.renderable,r):this.renderer.deleteRule(n)),r):r:(this.deployed=!1,r)},t.insertRule=function(e){this.renderer&&this.renderer.insertRule(e)},t.addRules=function(e,t){var s=[];for(var n in e){var r=this.addRule(n,e[n],t);r&&s.push(r)}return s},t.getRule=function(e){return this.rules.get(e)},t.deleteRule=function(e){var t="object"==typeof e?e:this.rules.get(e);return!(!t||this.attached&&!t.renderable)&&(this.rules.remove(t),!(this.attached&&t.renderable&&this.renderer)||this.renderer.deleteRule(t.renderable))},t.indexOf=function(e){return this.rules.indexOf(e)},t.deploy=function(){return this.renderer&&this.renderer.deploy(),this.deployed=!0,this},t.update=function(){var e;return(e=this.rules).update.apply(e,arguments),this},t.updateOne=function(e,t,s){return this.rules.updateOne(e,t,s),this},t.toString=function(e){return this.rules.toString(e)},e}(),As=function(){function e(){this.plugins={internal:[],external:[]},this.registry={}}var t=e.prototype;return t.onCreateRule=function(e,t,s){for(var n=0;n<this.registry.onCreateRule.length;n++){var r=this.registry.onCreateRule[n](e,t,s);if(r)return r}return null},t.onProcessRule=function(e){if(!e.isProcessed){for(var t=e.options.sheet,s=0;s<this.registry.onProcessRule.length;s++)this.registry.onProcessRule[s](e,t);e.style&&this.onProcessStyle(e.style,e,t),e.isProcessed=!0}},t.onProcessStyle=function(e,t,s){for(var n=0;n<this.registry.onProcessStyle.length;n++)t.style=this.registry.onProcessStyle[n](t.style,t,s)},t.onProcessSheet=function(e){for(var t=0;t<this.registry.onProcessSheet.length;t++)this.registry.onProcessSheet[t](e)},t.onUpdate=function(e,t,s,n){for(var r=0;r<this.registry.onUpdate.length;r++)this.registry.onUpdate[r](e,t,s,n)},t.onChangeValue=function(e,t,s){for(var n=e,r=0;r<this.registry.onChangeValue.length;r++)n=this.registry.onChangeValue[r](n,t,s);return n},t.use=function(e,t){void 0===t&&(t={queue:"external"});var s=this.plugins[t.queue];-1===s.indexOf(e)&&(s.push(e),this.registry=[].concat(this.plugins.external,this.plugins.internal).reduce((function(e,t){for(var s in t)s in e?e[s].push(t[s]):"production"!==process.env.NODE_ENV&&It(!1,'[JSS] Unknown hook "'+s+'".');return e}),{onCreateRule:[],onProcessRule:[],onProcessStyle:[],onProcessSheet:[],onChangeValue:[],onUpdate:[]}))},e}(),Os=function(){function e(){this.registry=[]}var t=e.prototype;return t.add=function(e){var t=this.registry,s=e.options.index;if(-1===t.indexOf(e))if(0===t.length||s>=this.index)t.push(e);else for(var n=0;n<t.length;n++)if(t[n].options.index>s)return void t.splice(n,0,e)},t.reset=function(){this.registry=[]},t.remove=function(e){var t=this.registry.indexOf(e);this.registry.splice(t,1)},t.toString=function(e){for(var t=void 0===e?{}:e,s=t.attached,n=function(e,t){if(null==e)return{};var s,n,r={},de=Object.keys(e);for(n=0;n<de.length;n++)s=de[n],t.indexOf(s)>=0||(r[s]=e[s]);return r}(t,["attached"]),r=Qt(n).linebreak,de="",he=0;he<this.registry.length;he++){var ue=this.registry[he];null!=s&&ue.attached!==s||(de&&(de+=r),de+=ue.toString(n))}return de},zt(e,[{key:"index",get:function(){return 0===this.registry.length?0:this.registry[this.registry.length-1].options.index}}]),e}(),Ds=new Os,Fs="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window&&window.Math===Math?window:"undefined"!=typeof self&&self.Math===Math?self:Function("return this")(),Is="2f1acc6c3a606b082e5eef5e54414ffb";null==Fs[Is]&&(Fs[Is]=0);var _s=Fs[Is]++,Us=function(e){void 0===e&&(e={});var t=0;return function(s,n){(t+=1)>1e10&&"production"!==process.env.NODE_ENV&&It(!1,"[JSS] You might have a memory leak. Rule counter is at "+t+".");var r="",de="";return n&&(n.options.classNamePrefix&&(de=n.options.classNamePrefix),null!=n.options.jss.id&&(r=String(n.options.jss.id))),e.minify?""+(de||"c")+_s+r+t:de+s.key+"-"+_s+(r?"-"+r:"")+"-"+t}},Gs=function(e){var t;return function(){return t||(t=e()),t}},zs=function(e,t){try{return e.attributeStyleMap?e.attributeStyleMap.get(t):e.style.getPropertyValue(t)}catch(s){return""}},Bs=function(e,t,s){try{var n=s;if(Array.isArray(s)&&(n=qt(s)),e.attributeStyleMap)e.attributeStyleMap.set(t,n);else{var r=n?n.indexOf("!important"):-1,de=r>-1?n.substr(0,r-1):n;e.style.setProperty(t,de,r>-1?"important":"")}}catch(he){return!1}return!0},Vs=function(e,t){try{e.attributeStyleMap?e.attributeStyleMap.delete(t):e.style.removeProperty(t)}catch(s){"production"!==process.env.NODE_ENV&&It(!1,'[JSS] DOMException "'+s.message+'" was thrown. Tried to remove property "'+t+'".')}},Ws=function(e,t){return e.selectorText=t,e.selectorText===t},Hs=Gs((function(){return document.querySelector("head")}));function Ns(e){var t=Ds.registry;if(t.length>0){var s=function(e,t){for(var s=0;s<e.length;s++){var n=e[s];if(n.attached&&n.options.index>t.index&&n.options.insertionPoint===t.insertionPoint)return n}return null}(t,e);if(s&&s.renderer)return{parent:s.renderer.element.parentNode,node:s.renderer.element};if(s=function(e,t){for(var s=e.length-1;s>=0;s--){var n=e[s];if(n.attached&&n.options.insertionPoint===t.insertionPoint)return n}return null}(t,e),s&&s.renderer)return{parent:s.renderer.element.parentNode,node:s.renderer.element.nextSibling}}var n=e.insertionPoint;if(n&&"string"==typeof n){var r=function(e){for(var t=Hs(),s=0;s<t.childNodes.length;s++){var n=t.childNodes[s];if(8===n.nodeType&&n.nodeValue.trim()===e)return n}return null}(n);if(r)return{parent:r.parentNode,node:r.nextSibling};"production"!==process.env.NODE_ENV&&It(!1,'[JSS] Insertion point "'+n+'" not found.')}return!1}var Ks,js=Gs((function(){var e=document.querySelector('meta[property="csp-nonce"]');return e?e.getAttribute("content"):null})),qs=function(e,t,s){try{"insertRule"in e?e.insertRule(t,s):"appendRule"in e&&e.appendRule(t)}catch(n){return"production"!==process.env.NODE_ENV&&It(!1,"[JSS] "+n.message),!1}return e.cssRules[s]},Qs=function(e,t){var s=e.cssRules.length;return void 0===t||t>s?s:t},$s=function(){function e(e){this.getPropertyValue=zs,this.setProperty=Bs,this.removeProperty=Vs,this.setSelector=Ws,this.hasInsertedRules=!1,this.cssRules=[],e&&Ds.add(e),this.sheet=e;var t,s=this.sheet?this.sheet.options:{},n=s.media,r=s.meta,de=s.element;this.element=de||((t=document.createElement("style")).textContent="\n",t),this.element.setAttribute("data-jss",""),n&&this.element.setAttribute("media",n),r&&this.element.setAttribute("data-meta",r);var he=js();he&&this.element.setAttribute("nonce",he)}var t=e.prototype;return t.attach=function(){if(!this.element.parentNode&&this.sheet){!function(e,t){var s=t.insertionPoint,n=Ns(t);if(!1!==n&&n.parent)n.parent.insertBefore(e,n.node);else if(s&&"number"==typeof s.nodeType){var r=s,de=r.parentNode;de?de.insertBefore(e,r.nextSibling):"production"!==process.env.NODE_ENV&&It(!1,"[JSS] Insertion point is not in the DOM.")}else Hs().appendChild(e)}(this.element,this.sheet.options);var e=Boolean(this.sheet&&this.sheet.deployed);this.hasInsertedRules&&e&&(this.hasInsertedRules=!1,this.deploy())}},t.detach=function(){if(this.sheet){var e=this.element.parentNode;e&&e.removeChild(this.element),this.sheet.options.link&&(this.cssRules=[],this.element.textContent="\n")}},t.deploy=function(){var e=this.sheet;e&&(e.options.link?this.insertRules(e.rules):this.element.textContent="\n"+e.toString()+"\n")},t.insertRules=function(e,t){for(var s=0;s<e.index.length;s++)this.insertRule(e.index[s],s,t)},t.insertRule=function(e,t,s){if(void 0===s&&(s=this.element.sheet),e.rules){var n=e,r=s;if("conditional"===e.type||"keyframes"===e.type){var de=Qs(s,t);if(!1===(r=qs(s,n.toString({children:!1}),de)))return!1;this.refCssRule(e,de,r)}return this.insertRules(n.rules,r),r}var he=e.toString();if(!he)return!1;var ue=Qs(s,t),pe=qs(s,he,ue);return!1!==pe&&(this.hasInsertedRules=!0,this.refCssRule(e,ue,pe),pe)},t.refCssRule=function(e,t,s){e.renderable=s,e.options.parent instanceof xs&&this.cssRules.splice(t,0,s)},t.deleteRule=function(e){var t=this.element.sheet,s=this.indexOf(e);return-1!==s&&(t.deleteRule(s),this.cssRules.splice(s,1),!0)},t.indexOf=function(e){return this.cssRules.indexOf(e)},t.replaceRule=function(e,t){var s=this.indexOf(e);return-1!==s&&(this.element.sheet.deleteRule(s),this.cssRules.splice(s,1),this.insertRule(t,s))},t.getRules=function(){return this.element.sheet.cssRules},e}(),Xs=0,Js=function(){function e(e){this.id=Xs++,this.version="10.10.0",this.plugins=new As,this.options={id:{minify:!1},createGenerateId:Us,Renderer:Dt?$s:null,plugins:[]},this.generateId=Us({minify:!1});for(var t=0;t<Ms.length;t++)this.plugins.use(Ms[t],{queue:"internal"});this.setup(e)}var t=e.prototype;return t.setup=function(e){return void 0===e&&(e={}),e.createGenerateId&&(this.options.createGenerateId=e.createGenerateId),e.id&&(this.options.id=At({},this.options.id,e.id)),(e.createGenerateId||e.id)&&(this.generateId=this.options.createGenerateId(this.options.id)),null!=e.insertionPoint&&(this.options.insertionPoint=e.insertionPoint),"Renderer"in e&&(this.options.Renderer=e.Renderer),e.plugins&&this.use.apply(this,e.plugins),this},t.createStyleSheet=function(e,t){void 0===t&&(t={});var s=t.index;"number"!=typeof s&&(s=0===Ds.index?0:Ds.index+1);var n=new xs(e,At({},t,{jss:this,generateId:t.generateId||this.generateId,insertionPoint:this.options.insertionPoint,Renderer:this.options.Renderer,index:s}));return this.plugins.onProcessSheet(n),n},t.removeStyleSheet=function(e){return e.detach(),Ds.remove(e),this},t.createRule=function(e,t,s){if(void 0===t&&(t={}),void 0===s&&(s={}),"object"==typeof e)return this.createRule(void 0,e,t);var n=At({},s,{name:e,jss:this,Renderer:this.options.Renderer});n.generateId||(n.generateId=this.generateId),n.classes||(n.classes={}),n.keyframes||(n.keyframes={});var r=Kt(e,t,n);return r&&this.plugins.onProcessRule(r),r},t.use=function(){for(var e=this,t=arguments.length,s=new Array(t),n=0;n<t;n++)s[n]=arguments[n];return s.forEach((function(t){e.plugins.use(t)})),this},e}(),Ys=new Js(Ks),Zs="@global",en="@global ",tn=function(){function e(e,t,s){for(var n in this.type="global",this.at=Zs,this.isProcessed=!1,this.key=e,this.options=s,this.rules=new Ls(At({},s,{parent:this})),t)this.rules.add(n,t[n]);this.rules.process()}var t=e.prototype;return t.getRule=function(e){return this.rules.get(e)},t.addRule=function(e,t,s){var n=this.rules.add(e,t,s);return n&&this.options.jss.plugins.onProcessRule(n),n},t.replaceRule=function(e,t,s){var n=this.rules.replace(e,t,s);return n&&this.options.jss.plugins.onProcessRule(n),n},t.indexOf=function(e){return this.rules.indexOf(e)},t.toString=function(e){return this.rules.toString(e)},e}(),sn=function(){function e(e,t,s){this.type="global",this.at=Zs,this.isProcessed=!1,this.key=e,this.options=s;var n=e.substr(8);this.rule=s.jss.createRule(n,t,At({},s,{parent:this}))}return e.prototype.toString=function(e){return this.rule?this.rule.toString(e):""},e}(),nn=/\s*,\s*/g;function rn(e,t){for(var s=e.split(nn),n="",r=0;r<s.length;r++)n+=t+" "+s[r].trim(),s[r+1]&&(n+=", ");return n}function on(){return{onCreateRule:function(e,t,s){if(!e)return null;if(e===Zs)return new tn(e,t,s);if("@"===e[0]&&e.substr(0,8)===en)return new sn(e,t,s);var n=s.parent;return n&&("global"===n.type||n.options.parent&&"global"===n.options.parent.type)&&(s.scoped=!1),s.selector||!1!==s.scoped||(s.selector=e),null},onProcessRule:function(e,t){"style"===e.type&&t&&(function(e,t){var s=e.options,n=e.style,r=n?n[Zs]:null;if(r){for(var de in r)t.addRule(de,r[de],At({},s,{selector:rn(de,e.selector)}));delete n[Zs]}}(e,t),function(e,t){var s=e.options,n=e.style;for(var r in n)if("@"===r[0]&&r.substr(0,Zs.length)===Zs){var de=rn(r.substr(Zs.length),e.selector);t.addRule(de,n[r],At({},s,{selector:de})),delete n[r]}}(e,t))}}}var an=/[A-Z]/g,ln=/^ms-/,cn={};function dn(e){return"-"+e.toLowerCase()}function hn(e){if(cn.hasOwnProperty(e))return cn[e];var t=e.replace(an,dn);return cn[e]=ln.test(t)?"-"+t:t}function un(e){var t={};for(var s in e){t[0===s.indexOf("--")?s:hn(s)]=e[s]}return e.fallbacks&&(Array.isArray(e.fallbacks)?t.fallbacks=e.fallbacks.map(un):t.fallbacks=un(e.fallbacks)),t}class OverlayStyle{constructor(e){s(this,"customStyles"),s(this,"modePalette"),s(this,"defaultModePalette",{"--color0":"#ff0000"}),s(this,"defaultStyles",{":root":{"--color0":"#00ff00"},".hiddenState":{display:"none"},"#Overlayid":{zIndex:99999,position:"fixed",left:"50%",transform:"translateX(-50%)",marginTop:"30px",padding:"10px 30px",borderRadius:"8px",background:"linear-gradient(120deg, rgba(202, 202, 202, 0.91) 0%, #7e7e7e 100%)",boxShadow:"4px 10px 15px 0px rgba(0, 0, 0, 0.18)",transition:"all 0.5s"},"#Overlaycontentid":{color:"#fff"}});const t={plugins:[on(),{onProcessStyle:function(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++)e[t]=un(e[t]);return e}return un(e)},onChangeValue:function(e,t,s){if(0===t.indexOf("--"))return e;var n=hn(t);return t===n?e:(s.prop(n,e),null)}}],insertionPoint:null==e?void 0:e.jssInsertionPoint};Ys.setup(t),this.customStyles=null==e?void 0:e.customStyles,this.modePalette=(null==e?void 0:e.modePalette)??this.defaultModePalette,this.applyPalette(this.modePalette)}applyStyleSheet(){Ys.createStyleSheet({"@global":{...this.defaultStyles}}).attach()}applyPalette(e){document.querySelector(":root").style.setProperty("--color0",e["--color0"])}}class Overlay{constructor(e){s(this,"rootElement"),s(this,"rootDiv"),s(this,"textElement"),this.rootDiv=e,this.textElement=this._textElement,this.rootElement=this._rootElement,this.rootElement.appendChild(this.textElement),this.hide(),this.rootDiv.appendChild(this.rootElement),this.setOverlayStyle()}get _rootElement(){return this.rootElement=document.createElement("div"),this.rootElement.id="Overlayid",this.rootElement.className="overlaystyle",this.rootElement}get _textElement(){return this.textElement=document.createElement("div"),this.textElement.id="Overlaycontentid",this.textElement.innerHTML="...",this.textElement}show(){this.rootElement.classList.remove("hiddenState")}hide(){this.rootElement.classList.add("hiddenState")}text(e){this.textElement.innerHTML=e}setOverlayStyle(){new OverlayStyle({}).applyStyleSheet()}}class ArgumentsUtils{static uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}static standardArgument(e,t){let s={};s=Object.assign({},e,t);for(const n in s)if(Object.prototype.hasOwnProperty.call(s,n)){const e=s[n];"string"==typeof e&&(s[n]=e.includes("#")?this.HexToRgba(e):e.includes("rgb")||e.includes("RGB")?this.SplitRgba(e):e),e instanceof Array&&(s[n]="string"==typeof e[0]?this.SetColorArray(e,s.Coord.length):e[0]instanceof Array?this.CoordToVector(e):this.ArraysConvertVector(e))}return s}static SetColorArray(e,t){let s=[];for(let n=0;n<t;n++){const t=e[n]||"#f00";"string"==typeof t&&s.push(t.includes("#")?this.HexToRgba(t):t.includes("rgb")||t.includes("RGB")?this.SplitRgba(t):t)}return e=s}static ArraysConvertVector(e){let t=e[2]??0;return{x:e[0],y:e[1],z:t}}static SplitRgba(e){var t=e.replace(/\s*/g,"").match(/^rgba?\(([\d.]+),([\d.]+),([\d.]+)(?:,([.\d]+))?\)$/);if(!(t&&t[1]&&t[2]&&t[3]))return{};var s=parseFloat(t[1]),n=parseFloat(t[2]),r=parseFloat(t[3]),de=s<=1&&n<=1&&r<=1;return{r:de?s:s/255,g:de?n:n/255,b:de?r:r/255,a:t[4]?parseFloat(t[4]):1}}static HexToRgba(e){3==(e=e.replace("#","")).length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);var t=255,s=255,n=255;return 6==e.length&&(t=parseInt(e.substring(0,2),16),s=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16)),{r:t/255,g:s/255,b:n/255,a:1}}static CoordToVector(e){for(let t=0;t<e.length;t++){const s=e[t];s[0]instanceof Array?this.CoordToVector(s):e[t]=this.ArraysConvertVector(s)}return e}}var mn=new Map;let gn,pn,vn;var fn,Sn;"object"!=typeof gn&&(gn={}),vn=function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}))},fn=function(e,t){if("function"!=typeof e)return"";var s=vn();return gn.interface[s]=e,setTimeout((function(){delete gn.interface[s]}),1e3*Math.max(1,parseInt(t)||0)),s},pn="object"!=typeof gn.interface||"function"!=typeof gn.interface.broadcast?(gn.interface={},function(e,t,s,n){var r,de;"string"==typeof e&&("function"==typeof t&&(n=s,s=t,t=null),r=[e,"",fn(s,n)],void 0!==t&&(r[1]=t),de=encodeURIComponent(JSON.stringify(r)),"object"==typeof history&&"function"==typeof history.pushState?(history.pushState({},"","#"+de),history.pushState({},"","#"+encodeURIComponent("[]"))):(document.location.hash=de,document.location.hash=encodeURIComponent("[]")))}):(Sn=gn.interface,gn.interface={},function(e,t,s,n){var r;"string"==typeof e&&("function"==typeof t&&(n=s,s=t,t=null),r=fn(s,n),void 0!==t?Sn.broadcast(e,JSON.stringify(t),r):Sn.broadcast(e,"",r))});class CommunicationUtils{constructor(e){s(this,"stream"),this.stream=e}onCommunacation(e,t={},s=(e=>{})){var n=ArgumentsUtils.uuidv4();this.communication(e,t,n,(e=>{s(e)}))}communication(e,t,s,n){mn.set(s,{});var r=e.split("_"),de={IntfCode:r[0],SubIntfCode:r[1],Params:t,callKey:s,timeStamp:Date.parse((new Date).toString())};console.log(de),this.stream?(this.stream.emitUIInteraction(de),this.Response(s,n)):pn(e,t,(e=>{console.log(e,"this.Client.ue5"),n(e)}),30),console.log("-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-")}Response(e,t){Object.defineProperty(mn,e,{get(){},set(e){t(e)}})}}class BaseClass{constructor(e){s(this,"stream"),s(this,"Communication"),this.stream=e,this.Communication=new CommunicationUtils(this.stream)}PassingParameters(e,t={},s){this.Communication.onCommunacation(e,t,s)}listener(e,t){Object.defineProperty(mn,e,{get(){},set(e){t(e)}}),mn.set(e,{})}}class DrawClass extends BaseClass{constructor(e){super(e),s(this,"params"),s(this,"DRAWAPI"),this.DRAWAPI={},this.params={}}add(e,t){super.PassingParameters(this.DRAWAPI.add,DrawClass.resuleArray(e,this.params),t)}update(e,t){super.PassingParameters(this.DRAWAPI.update,DrawClass.resuleArray(e),t)}delete(e,t){super.PassingParameters(this.DRAWAPI.delete,{id:e},t)}show(e,t){super.PassingParameters(this.DRAWAPI.show,{id:e},t)}allShow(e){super.PassingParameters(this.DRAWAPI.allShow,{},e)}hide(e,t){super.PassingParameters(this.DRAWAPI.hide,{id:e},t)}allHide(e){super.PassingParameters(this.DRAWAPI.allHide,{},e)}clear(e){super.PassingParameters(this.DRAWAPI.clear,{},e)}focus(e,t){super.PassingParameters(this.DRAWAPI.focus,{id:e},t)}static resuleArray(e,t={}){var s=[];if(e instanceof Array)e.forEach((e=>{e=ArgumentsUtils.standardArgument(t,e),s.push(e)}));else if("object"==typeof e){var n=ArgumentsUtils.standardArgument(t,e);s.push(n)}return{Params:s}}}class Marker extends DrawClass{constructor(e){super(e),s(this,"params"),this.params=Marker.returnParams(),this.DRAWAPI={add:"Poi_Add",update:"Poi_Update",delete:"Poi_Delete",show:"Poi_Show",allShow:"Poi_AllShow",hide:"Poi_Hidden",allHide:"Poi_AllHidden",clear:"Poi_ClearAll",focus:"Poi_Focus"}}static returnParams(){return{Id:ArgumentsUtils.uuidv4(),GroupID:ArgumentsUtils.uuidv4(),Type:0,UseLocalFile:!1,LabelProperties:"",FilePath:"",CoordType:4545,Coord:{x:0,y:0,z:0},PoiAlwaysShow:!0,PoiShowRange:{x:0,y:0,z:0},ImageUrl:"",ImageForceRefresh:!1,ImageSize:{x:0,y:0,z:0},ImagePivot:{x:.5,y:.5,z:0},ImagePosition:{x:0,y:0,z:0},Label:"",LabelFontsize:14,LabelFontColor:{r:1,g:1,b:1,a:1},LabelBackgroundColor:{r:0,g:0,b:0,a:1},LabelPivot:{x:.5,y:1,z:0},LabelPosition:{x:0,y:-50,z:0},LabelAlwaysShow:!0,LabelShowRange:{x:0,y:5e3,z:0},GuideLineSize:{x:2,y:50,z:0},GuideLinePosition:{x:0,y:-25,z:0},GuideLinePivot:{x:.5,y:.5,z:0},GuideLineColor:{r:1,g:1,b:1,a:1}}}add(e,t){super.add(e,t)}update(e,t){super.update(e,t)}delete(e,t){super.delete(e,t)}show(e,t){super.show(e,t)}allShow(e){super.allShow(e)}hide(e,t){super.hide(e,t)}allHide(e){super.allHide(e)}clear(e){super.clear(e)}focus(e,t){super.focus(e,t)}}class Polyline extends DrawClass{constructor(e){super(e),s(this,"params"),this.params=Polyline.returnParams(),this.DRAWAPI={add:"Line_Add",update:"Line_Update",delete:"Line_Delete",show:"Line_Show",allShow:"Line_AllShow",hide:"Line_Hidden",allHide:"Line_AllHidden",clear:"Line_ClearAll",focus:"Line_Focus"}}static returnParams(){return{Id:ArgumentsUtils.uuidv4(),GroupID:ArgumentsUtils.uuidv4(),Coord:{x:0,y:0,z:0},CoordType:4545,Name:"",GeoJsonPath:"",UseLocalFile:!1,Color:["#FF0000"],Thickness:2,Range:{x:0,y:0,z:0},ColorIntensity:1}}add(e,t){super.add(e,t)}update(e,t){super.update(e,t)}delete(e,t){super.delete(e,t)}show(e,t){super.show(e,t)}allShow(e){super.allShow(e)}hide(e,t){super.hide(e,t)}allHide(e){super.allHide(e)}clear(e){super.clear(e)}focus(e,t){super.focus(e,t)}}class Polygon extends DrawClass{constructor(e){super(e),s(this,"params"),this.params=Polygon.returnParams(),this.DRAWAPI={add:"Poly_Add",update:"Poly_Update",delete:"Poly_Delete",show:"Poly_Show",allShow:"Poly_AllShow",hide:"Poly_Hidden",allHide:"Poly_AllHidden",clear:"Poly_ClearAll",focus:"Poly_Focus"}}static returnParams(){return{Id:ArgumentsUtils.uuidv4(),GroupID:ArgumentsUtils.uuidv4(),GeoJsonPath:"",UseLocalFile:!1,Coord:{x:0,y:0,z:0},CoordType:4545,Hight:0,Color:["#FF0000"],FrameColor:["#FF0000"],FrameThickness:0,FrameIntensity:0}}add(e,t){super.add(e,t)}update(e,t){super.update(e,t)}delete(e,t){super.delete(e,t)}show(e,t){super.show(e,t)}allShow(e){super.allShow(e)}hide(e,t){super.hide(e,t)}allHide(e){super.allHide(e)}clear(e){super.clear(e)}focus(e,t){super.focus(e,t)}}class Tools extends BaseClass{constructor(e){super(e)}measurementData(e,t){return{operationType:e,toolType:t}}setMeasurement(e,t){super.PassingParameters("Tools_Measure",this.measurementData(4,0),t),super.PassingParameters("Tools_Measure",this.measurementData(4,e),t)}stopMeasurement(e){super.PassingParameters("Tools_Measure",this.measurementData(4,0),e),super.PassingParameters("Tools_Measure",this.measurementData(0,0),e)}startSkylineAnalysis(e){super.PassingParameters("Tools_SkylineAnalysis",{switch:!0},e)}stopSkylineAnalysis(e){super.PassingParameters("Tools_SkylineAnalysis",{switch:!1},e)}screenShot(e=1920,t=1080,s){var n={x:e,y:t};super.PassingParameters("Tools_ScreenShot",{resolution:n},s)}static returnParams(){return{ActorTag:"Left",Cesium_URL:"",ComponentType:-1,ComponentTag:"",TMS_URL:"",TMS_SpecifyZoomLevels:!0,TMS_MaximumLevel:0,TMS_MinimumLevel:81,TMS_MaterialLayerKey:"",WMS_BaseURL:"",WMS_MaterialLayerKey:"",WMS_Layer:"",WMS_TileWidth:0,WMS_TileHeight:0,WMS_MaximumLevel:0,WMS_MinimumLevel:0}}splitScreen(e,t){let s=Object.assign({},Tools.returnParams(),e);super.PassingParameters("Tools_AddSplitScreenComponent",s,t)}showSplitScreen(e){super.PassingParameters("Tools_ShowSplitScreen",{Switch:!0},e)}hideSplitScreen(e){super.PassingParameters("Tools_ShowSplitScreen",{Switch:!1},e)}deleteSplitScreen(e,t,s){super.PassingParameters("Tools_DeleteSplitScreenComponent",{ActorTag:e,ComponentTag:t},s)}}var yn=(e=>(e.a="Layer_GetLayerTree",e.b="Layer_ShowLayer",e.c="Layer_RemoveLayer",e.d="Layer_QueryLayer",e.e="Layer_ChangeOpacity",e.f="Layer_RemoveOverlay",e.g="Layer_FocusLayer",e.h="Layer_AddImageLayer",e.j="Layer_UpdateLayer",e.k="Layer_AddTilesLayer",e.l="Layer_AddModelLayer",e))(yn||{});class LayerTree extends BaseClass{constructor(e){super(e)}baseCommunacation(e,t,s){super.PassingParameters(yn[e],t,s)}get(e){this.baseCommunacation("a",{},e)}show(e,t,s){this.baseCommunacation("b",this.ShowOrHide(e,t,!0),s)}hide(e,t,s){this.baseCommunacation("b",this.ShowOrHide(e,t,!1),s)}delete(e,t,s){this.baseCommunacation("c",this.composeType(e,t),s)}find(e,t,s){this.baseCommunacation("d",this.composeType(e,t),s)}setOpacity(e,t,s){this.baseCommunacation("e",{Overlay:e,Opacity:t},s)}removeOverlay(e,t){this.baseCommunacation("f",{id:e},t)}focus(e,t){this.baseCommunacation("g",{id:e},t)}addWms(e,t){this.baseCommunacation("h",this.composeType(void 0,"wms",e),t)}updateWms(e,t){this.baseCommunacation("j",this.composeType(void 0,"wms",e),t)}add3DTiles(e,t){this.baseCommunacation("k",this.composeType(void 0,"tiles",e),t)}addTerrain(e,t){this.baseCommunacation("k",this.composeType(void 0,"terrain",e),t)}addModelLayer(e,t){this.baseCommunacation("l",this.composeType(void 0,"model",e),t)}ShowOrHide(e,t,s){let n={layers:[],show:s};return e instanceof Array&&(n.layers=e),"object"==typeof e&&n.layers.push(e),"string"==typeof e&&n.layers.push(this.composeType(e,t)),n}composeType(e,t="wms",s={}){let n={id:(null==s?void 0:s.id)??e??ArgumentsUtils.uuidv4(),type:t};return Object.assign({},n,s)}}class Camera extends BaseClass{constructor(e){super(e),s(this,"params"),s(this,"paramspeed"),s(this,"normalObject"),s(this,"bufferVal",.1),this.params=Camera.returnParams(),this.paramspeed=Camera.returnSpeed(),this.normalObject={}}static returnParams(){return{Transform:{rotation:{pitch:-90,yaw:-90,roll:0},translation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},Duration:2,TravelChangeZ:1e5}}static returnSpeed(){return{MovementSpeed:5,RotateSpeed:2,ZoomSpeed:25,MovementLagSpeed:5,RotateLagSpeed:5,GroundLevel:0,ScalingDistanceReference:300,MinPitch:-89,MaxPitch:89,MinRoll:-180,MaxRoll:180,TravelSpeed:1}}get(e){super.PassingParameters("Player_GetPlayerLocation",{},e)}set(e,t,s,n,r,de){if("number"==typeof e&&this.setByObj(e,t,s,n,r),"object"==typeof e&&"object"==typeof e.Transform){const t=this.params.Transform,s=e.Transform;var he=(null==s?void 0:s.translation)??{},ue=(null==s?void 0:s.rotation)??{},pe=(null==s?void 0:s.scale)??{};const n={translation:Object.assign({},t.translation,he),rotation:Object.assign({},t.rotation,ue),scale:Object.assign({},t.scale,pe)};for(const e in n.rotation)if(Object.prototype.hasOwnProperty.call(n.rotation,e)){const t=n.rotation[e];90!=t&&-90!=t||(n.rotation[e]+=this.bufferVal)}var ve=Object.assign({},this.params,{Transform:n,Duration:(null==e?void 0:e.Duration)??this.params.Duration,TravelChangeZ:(null==e?void 0:e.TravelChangeZ)??this.params.TravelChangeZ});super.PassingParameters("Player_SetPlayerLocation",ve,de)}}abort(e){super.PassingParameters("Player_SetPlayerLocation",{},e)}setControlMode(e,t){super.PassingParameters("Player_SetPlayerInfo",ArgumentsUtils.standardArgument(this.paramspeed,e),t)}setByObj(e,t,s,n,r){var de={x:e,y:t,z:0|s},he={Transform:{}};he.Transform.translation={},he.Transform.translation=de,n&&(he.Duration=n),r&&(he.TravelChangeZ=r);var ue=Object.assign({},this.params,he);this.set(ue,t,s,n,r,(()=>{}))}addEventListener(e,t){mn.set(e,{}),this.listener(e,t)}}var Cn=(e=>(e[e.clear_skies=0]="clear_skies",e[e.partly_cloudy=1]="partly_cloudy",e[e.overcast=2]="overcast",e[e.foggy=3]="foggy",e[e.rain_light=4]="rain_light",e[e.rain=5]="rain",e[e.rain_thunderstorm=6]="rain_thunderstorm",e[e.snow_light=7]="snow_light",e[e.snow=8]="snow",e[e.snow_blizzard=9]="snow_blizzard",e))(Cn||{}),bn=(e=>(e[e.sunrise=1]="sunrise",e[e.noon=2]="noon",e[e.sunset=3]="sunset",e))(bn||{});class Weather extends BaseClass{constructor(e){super(e),s(this,"timeParams"),s(this,"WeatherParams"),s(this,"skyParams"),this.timeParams=Weather.returnTimeParams(),this.WeatherParams=Weather.returnWeatherParams(),this.skyParams=Weather.returnSkyParams()}static returnTimeParams(){return{TimeOfDay:1200,DawnTime:600,DuskTime:1800,SimulateReal:!1,AnimateTime:!1,TimeSpeed:1}}static returnWeatherParams(){return{CloudCoverage:0,Fog:0,Wind:0,Rain:0,Snow:0,ThunderLightning:0,Dust:0}}static returnSkyParams(){return{OverallIntensity:1,SkyContrast:.1,SkySaturation:1,SoftenCloudLayer:0,CloudHeightLayer:1,UseCloudShadows:!0,CloudSpeed:.35,CloudWispsColorIntensity:1,MoonScale:.7,MoonPhase:0,SkyLightIntensity:1,NightBrightness:1,SkyLightTemperature:0,StarsIntensity:.75,StarsSpeed:.1,EnableSunLensFlare:!0}}getTimeParams(e){super.PassingParameters("Scene_TimeGetting",{},e)}getSkyParams(e){super.PassingParameters("Scene_SkyGetting",{},e)}getWeatherParams(e){super.PassingParameters("Scene_WeatherGetting",{},e)}setTimeParams(e,t){super.PassingParameters("Scene_TimeSetting",e,t)}setSkyParams(e,t){super.PassingParameters("Scene_SkySetting",e,t)}setWeatherParams(e,t){super.PassingParameters("Scene_WeatherSetting",e,t)}setWeather(e,t){super.PassingParameters("Scene_WeatherSetting",{Weather:Cn[e]},t)}momentOfDay(e,t){super.PassingParameters("Scene_TimeSetting",{MomentOfDay:bn[e]},t)}setSkyLightIntensity(e,t){super.PassingParameters("Scene_SkySetting",{SkyLightIntensity:e},t)}setCloudDensity(e,t){super.PassingParameters("Scene_SkySetting",{SoftenCloudLayer:e},t)}setCloudHeight(e,t){super.PassingParameters("Scene_SkySetting",{CloudHeightLayer:e},t)}setMoonScale(e,t){super.PassingParameters("Scene_SkySetting",{MoonScale:e},t)}}e.Application=class Application{constructor(e,t){var n,r,de;if(s(this,"stream"),s(this,"_rootElement"),s(this,"currentOverlay"),s(this,"OverlayDiv"),s(this,"Marker"),s(this,"Polyline"),s(this,"Polygon"),s(this,"Tools"),s(this,"LayerTree"),s(this,"Camera"),s(this,"Weather"),s(this,"_option"),s(this,"judgeTime",[null,"",0,void 0]),this._option=t,e){var he=e+"/type=player";const s=new kt({initialSettings:{ss:t.instanceId?he+"&insid="+t.instanceId:he,AutoConnect:(null==(n=this._option)?void 0:n.AutoConnect)??!0,StartVideoMuted:!0,HoveringMouse:!0,MatchViewportRes:!0,KeyboardInput:(null==(r=this._option)?void 0:r.KeyboardInput)??!1,MouseInput:(null==(de=this._option)?void 0:de.MouseInput)??!0},useUrlParams:!0});this.stream=new xt(s),this._rootElement=this.rootElement,this.OverlayDiv=new Overlay(this.stream.videoElementParent),this.registerCallbacks(),this.responseStream()}else this.responseClient();this.initInterface(),t.debugLog||null==t.debugLog||(Lt.Info=function(){},Lt.Log=function(){})}_onReady(){var e,t=(null==(e=this._option)?void 0:e.initialized)??{};"object"==typeof t&&"function"==typeof t.onReady&&t.onReady()}_onEvent(e){var t,s=(null==(t=this._option)?void 0:t.initialized)??{};"object"==typeof s&&"function"==typeof s.onEvent&&s.onEvent(e)}get rootElement(){return this._rootElement||(!this._option.domId&&Lt.Error(Lt.GetStackTrace(),", domId"),this._rootElement=document.getElementById(this._option.domId),this._rootElement.appendChild(this.stream.videoElementParent)),this._rootElement}registerCallbacks(){let e=this.stream;e.addEventListener("webRtcConnecting",(()=>{this.showOverlay(" webRtcConnecting")})),e.addEventListener("webRtcConnected",(()=>{this.showOverlay(" webRtcConnected")})),e.addEventListener("webRtcFailed",(()=>{this.showOverlay(" webRtcFailed")})),e.addEventListener("afkTimedOut",(()=>{this.showOverlay(" afkTimedOut")})),e.addEventListener("webRtcSdp",(()=>{this.showOverlay(" webRtcSdp")})),e.addEventListener("webRtcAutoConnect",(()=>{this.showOverlay("")})),e.addEventListener("videoInitialized",(()=>{this.showOverlay(""),this._onReady()})),e.addEventListener("streamLoading",(()=>{this.showOverlay(" streamLoading")}))}showOverlay(e){null!=this.currentOverlay&&(this.currentOverlay.hide(),this.currentOverlay=void 0),this.OverlayDiv.text(e),this.OverlayDiv.show(),this.currentOverlay=this.OverlayDiv,setTimeout((()=>{this.OverlayDiv.hide()}),5e3)}initInterface(){this.Marker=new Marker(this.stream),this.Polyline=new Polyline(this.stream),this.Polygon=new Polygon(this.stream),this.Tools=new Tools(this.stream),this.LayerTree=new LayerTree(this.stream),this.Camera=new Camera(this.stream),this.Weather=new Weather(this.stream)}responseStream(){this.stream.addResponseEventListener("responseListener",(e=>{if(!this.judgeTime.includes(e)){var t=JSON.parse(e);mn[t.K]=t.data,this.eventMatch(t)}}))}responseClient(){const e=this;gn.interface.responseListener=function(t){if(console.log(t),!e.judgeTime.includes(t)){var s=JSON.parse(t);mn[s.K]=s.data,e.eventMatch(s)}}}eventMatch(e){(null==e?void 0:e.K)&&["PickCoordinate","MeasurementDistance","MeasuringArea","GaugeAltitude","Marker","Polyline","Polygon","ClickCoverage"].includes(null==e?void 0:e.K)&&this._onEvent({type:e.K,event:e.data.data})}},Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
