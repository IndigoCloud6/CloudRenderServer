<?xml version="1.0" encoding="UTF-8"?>
<!--虚幻引擎像素流送信令服务器日志配置-->
<!--monitorInterval：Log4j能够自动检测修改配置文件并重新配置，设置间隔秒数(最小5秒)-->
<configuration monitorInterval="30" status="warn">
    <!--日志级别优先级排序: OFF > FATAL > ERROR > WARN > INFO > DEBUG > TRACE > ALL -->

    <!--变量配置-->
    <Properties>
        <!-- 完整日志格式：包含时间、级别、线程、类、方法、行号和消息 -->
        <property name="FULL_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%highlight{%-5level}] [%t] %c{1}.%M(%L) - %msg%n" />
        <!-- 简化日志格式：只包含时间和消息，适用于业务日志 -->
        <property name="SIMPLE_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss} - %msg%n" />
        <!-- 业务日志格式：专用于业务操作记录 -->
        <property name="BUSINESS_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss} [%highlight{业务}] %msg%n" />
        <!-- 定义日志存储路径 -->
        <property name="FILE_PATH" value="logs" />
    </Properties>

    <appenders>
        <!--控制台输出配置-->
        <console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="${FULL_PATTERN}"/>
            <!--控制台只输出INFO及以上级别的信息-->
            <ThresholdFilter level="info" onMatch="ACCEPT" onMismatch="DENY"/>
        </console>

        <!-- 业务操作日志 - 记录关键业务操作和状态变化 -->
        <RollingFile name="BusinessLog" fileName="${FILE_PATH}/business.log" 
                     filePattern="${FILE_PATH}/business/BUSINESS-%d{yyyy-MM-dd}_%i.log.gz">
            <PatternLayout pattern="${BUSINESS_PATTERN}"/>
            <ThresholdFilter level="info" onMatch="ACCEPT" onMismatch="DENY"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="50MB"/>
            </Policies>
            <DefaultRolloverStrategy max="30">
                <Delete basePath="${FILE_PATH}" maxDepth="2">
                    <IfFileName glob="*/BUSINESS-*.log.gz" />
                    <IfLastModified age="30d" />
                </Delete>
            </DefaultRolloverStrategy>
        </RollingFile>

        <!-- 系统运行日志 - 记录系统启动、配置、性能等信息 -->
        <RollingFile name="SystemLog" fileName="${FILE_PATH}/system.log" 
                     filePattern="${FILE_PATH}/system/SYSTEM-%d{yyyy-MM-dd}_%i.log.gz">
            <PatternLayout pattern="${FULL_PATTERN}"/>
            <ThresholdFilter level="info" onMatch="ACCEPT" onMismatch="DENY"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="100MB"/>
            </Policies>
            <DefaultRolloverStrategy max="30">
                <Delete basePath="${FILE_PATH}" maxDepth="2">
                    <IfFileName glob="*/SYSTEM-*.log.gz" />
                    <IfLastModified age="30d" />
                </Delete>
            </DefaultRolloverStrategy>
        </RollingFile>

        <!-- 错误日志 - 记录所有错误和异常信息 -->
        <RollingFile name="ErrorLog" fileName="${FILE_PATH}/error.log" 
                     filePattern="${FILE_PATH}/error/ERROR-%d{yyyy-MM-dd}_%i.log.gz">
            <PatternLayout pattern="${FULL_PATTERN}"/>
            <ThresholdFilter level="error" onMatch="ACCEPT" onMismatch="DENY"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="50MB"/>
            </Policies>
            <DefaultRolloverStrategy max="60">
                <Delete basePath="${FILE_PATH}" maxDepth="2">
                    <IfFileName glob="*/ERROR-*.log.gz" />
                    <IfLastModified age="60d" />
                </Delete>
            </DefaultRolloverStrategy>
        </RollingFile>

        <!-- 调试日志 - 开发和调试使用 -->
        <RollingFile name="DebugLog" fileName="${FILE_PATH}/debug.log" 
                     filePattern="${FILE_PATH}/debug/DEBUG-%d{yyyy-MM-dd}_%i.log.gz">
            <PatternLayout pattern="${FULL_PATTERN}"/>
            <ThresholdFilter level="debug" onMatch="ACCEPT" onMismatch="DENY"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true" />
                <SizeBasedTriggeringPolicy size="100MB"/>
            </Policies>
            <DefaultRolloverStrategy max="7">
                <Delete basePath="${FILE_PATH}" maxDepth="2">
                    <IfFileName glob="*/DEBUG-*.log.gz" />
                    <IfLastModified age="7d" />
                </Delete>
            </DefaultRolloverStrategy>
        </RollingFile>

        <!--启用异步日志提高性能-->
        <Async name="AsyncAll" bufferSize="10000" blocking="false">
            <AppenderRef ref="Console"/>
            <AppenderRef ref="SystemLog"/>
            <AppenderRef ref="BusinessLog"/>
            <AppenderRef ref="ErrorLog"/>
            <AppenderRef ref="DebugLog"/>
        </Async>
    </appenders>

    <loggers>
        <!-- 业务日志记录器 - 专门用于记录业务操作 -->
        <Logger name="BUSINESS" level="info" additivity="false">
            <AppenderRef ref="BusinessLog"/>
            <AppenderRef ref="Console"/>
        </Logger>

        <!-- 像素流服务相关日志 -->
        <Logger name="com.xudri.cloudrenderserver.core" level="info" additivity="false">
            <AppenderRef ref="AsyncAll"/>
        </Logger>

        <!-- 网络通信日志 -->
        <Logger name="com.xudri.cloudrenderserver.infrastructure.network" level="info" additivity="false">
            <AppenderRef ref="AsyncAll"/>
        </Logger>

        <!-- 监控相关日志 -->
        <Logger name="com.xudri.cloudrenderserver.infrastructure.monitor" level="info" additivity="false">
            <AppenderRef ref="AsyncAll"/>
        </Logger>

        <!-- Spring框架日志控制 -->
        <Logger name="org.springframework" level="warn" additivity="false">
            <AppenderRef ref="AsyncAll"/>
        </Logger>

        <!-- MyBatis日志控制 -->
        <Logger name="org.mybatis" level="warn" additivity="false">
            <AppenderRef ref="AsyncAll"/>
        </Logger>

        <!-- Netty日志控制 -->
        <Logger name="io.netty" level="warn" additivity="false">
            <AppenderRef ref="AsyncAll"/>
        </Logger>

        <!--根日志配置-->
        <root level="info">
            <AppenderRef ref="AsyncAll"/>
        </root>
    </loggers>
</configuration>