name: ğŸš€ æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx1024m

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: ğŸ“¦ Maven ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ” ä»£ç ç¼–è¯‘æ£€æŸ¥
      run: ./mvnw clean compile -B

    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: ./mvnw test -B

  # æ„å»ºåº”ç”¨
  build:
    name: ğŸ—ï¸ æ„å»ºåº”ç”¨
    needs: code-quality
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: â˜• è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: ğŸ“¦ Maven ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ·ï¸ è·å–ç‰ˆæœ¬å·
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)-$(date +%Y%m%d-%H%M%S)
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ åº”ç”¨ç‰ˆæœ¬: $VERSION"

    - name: ğŸ”¨ æ„å»ºåº”ç”¨
      run: |
        ./mvnw clean package -B -DskipTests
        
    - name: ğŸ“ ç”Ÿæˆæ„å»ºä¿¡æ¯
      run: |
        echo "## ğŸš€ æ„å»ºä¿¡æ¯" > build-info.md
        echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> build-info.md
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> build-info.md
        echo "- **æäº¤**: ${{ github.sha }}" >> build-info.md
        echo "- **æ„å»ºæ—¶é—´**: $(date)" >> build-info.md
        echo "- **Javaç‰ˆæœ¬**: ${{ env.JAVA_VERSION }}" >> build-info.md

    - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: cloud-render-server-${{ steps.version.outputs.version }}
        path: |
          target/*.jar
          build-info.md
          README.md
        retention-days: 30

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    needs: [build]
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: ğŸ“Š æ„å»ºçŠ¶æ€é€šçŸ¥
      run: |
        if [[ "${{ needs.build.result }}" == "success" ]]; then
          echo "âœ… æ„å»ºæˆåŠŸå®Œæˆï¼"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
        else
          echo "âŒ æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
          exit 1
        fi
